# Exclusiones y ajustes de ModSecurity / OWASP CRS para la aplicación médica
#
# Este fichero se monta como regla AFTER-CRS para que las exclusiones
# se apliquen después de cargar el Core Rule Set.
#
# Contexto: la app envía JSON con campos "password", "username", etc.
# que disparan reglas de inyección SQL y XSS (falsos positivos).

# ─── Exclusiones para rutas de autenticación ───────────────────────────
# POST /api/auth/register y /api/auth/login envían JSON con "password"
# que activa reglas SQL injection (942xxx) y XSS (941xxx).
SecRule REQUEST_URI "@beginsWith /api/auth/" \
    "id:10001,\
    phase:1,\
    pass,\
    nolog,\
    ctl:ruleRemoveTargetById=941100-941999;ARGS:password,\
    ctl:ruleRemoveTargetById=942100-942999;ARGS:password,\
    ctl:ruleRemoveTargetById=920272;ARGS:password"

# El campo recaptcha_token puede contener caracteres base64 largos
SecRule REQUEST_URI "@beginsWith /api/auth/" \
    "id:10002,\
    phase:1,\
    pass,\
    nolog,\
    ctl:ruleRemoveTargetById=941100-941999;ARGS:recaptcha_token,\
    ctl:ruleRemoveTargetById=942100-942999;ARGS:recaptcha_token"

# ─── Exclusiones para rutas de datos ──────────────────────────────────
# Los nombres de usuario pueden contener caracteres Unicode/especiales
SecRule REQUEST_URI "@beginsWith /api/user" \
    "id:10003,\
    phase:1,\
    pass,\
    nolog,\
    ctl:ruleRemoveTargetById=941100-941999;ARGS:first_name,\
    ctl:ruleRemoveTargetById=941100-941999;ARGS:last_name,\
    ctl:ruleRemoveTargetById=942100-942999;ARGS:first_name,\
    ctl:ruleRemoveTargetById=942100-942999;ARGS:last_name"

# ─── Exclusión para el supervisor (solo desarrollo) ──────────────────
SecRule REQUEST_URI "@beginsWith /supervisor" \
    "id:10004,\
    phase:1,\
    pass,\
    nolog,\
    ctl:ruleEngine=Off"

# ─── No inspeccionar cuerpos de respuesta (evitar fugas de info) ─────
SecResponseBodyAccess Off
