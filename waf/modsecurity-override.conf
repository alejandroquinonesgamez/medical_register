# Exclusiones y ajustes de ModSecurity / OWASP CRS para la aplicación médica
#
# Este fichero se monta como regla AFTER-CRS para que las exclusiones
# se apliquen después de cargar el Core Rule Set.
#
# Contexto: la app envía JSON con campos "password", "username", etc.
# que disparan reglas de inyección SQL y XSS (falsos positivos).

# ═══════════════════════════════════════════════════════════════════════
# INSPECCIÓN DE RESPUESTAS (Outbound Filtering / Prevención de exfiltración)
# ═══════════════════════════════════════════════════════════════════════
# Habilita la inspección del cuerpo de las respuestas para detectar fugas
# de datos sensibles: errores SQL, stack traces, rutas del sistema,
# números de tarjeta de crédito, volcados de base de datos, etc.
#
# Las reglas CRS de respuesta (951xxx-954xxx) se activan automáticamente
# cuando SecResponseBodyAccess está en On.
SecResponseBodyAccess On
SecResponseBodyMimeType text/plain text/html text/xml application/json
SecResponseBodyLimit 524288

# ─── Reglas personalizadas de exfiltración de datos ───────────────────
# Complementan las reglas CRS estándar (951xxx-954xxx) con detecciones
# específicas para esta aplicación.

# Regla 10010: Detectar números de tarjeta de crédito en respuestas
# Patrones: Visa (4xxx), MasterCard (5[1-5]xx), AMEX (3[47]xx), Discover (6011/65xx)
SecRule RESPONSE_BODY "@rx \b(?:4[0-9]{12}(?:[0-9]{3})?|5[1-5][0-9]{14}|3[47][0-9]{13}|6(?:011|5[0-9]{2})[0-9]{12})\b" \
    "id:10010,\
    phase:4,\
    deny,\
    status:403,\
    log,\
    msg:'Posible fuga de número de tarjeta de crédito en respuesta',\
    severity:'CRITICAL',\
    tag:'DATA_LEAKAGE/CREDIT_CARD'"

# Regla 10011: Detectar contenido de /etc/passwd en respuestas
# Patrón: líneas con formato usuario:x:UID:GID (típico de /etc/passwd)
SecRule RESPONSE_BODY "@rx (?:root|daemon|bin|sys|adm|www-data|nobody):[x*!]:\d+:\d+" \
    "id:10011,\
    phase:4,\
    deny,\
    status:403,\
    log,\
    msg:'Posible fuga de contenido de /etc/passwd en respuesta',\
    severity:'CRITICAL',\
    tag:'DATA_LEAKAGE/SYSTEM_FILE'"

# Regla 10012: Detectar volcados de base de datos (sentencias SQL) en respuestas
# Patrón: sentencias CREATE TABLE, INSERT INTO, mysqldump que indican un dump
SecRule RESPONSE_BODY "@rx (?i)(?:CREATE\s+TABLE|INSERT\s+INTO|mysqldump|pg_dump|sqlite3?\s+\.dump)" \
    "id:10012,\
    phase:4,\
    deny,\
    status:403,\
    log,\
    msg:'Posible volcado de base de datos en respuesta',\
    severity:'CRITICAL',\
    tag:'DATA_LEAKAGE/DB_DUMP'"

# Regla 10013: Detectar stack traces de Python/Flask en respuestas
# Patrón: Traceback (most recent call last) — error no controlado de Python
SecRule RESPONSE_BODY "@rx (?:Traceback \(most recent call last\)|Internal Server Error|Debugger PIN)" \
    "id:10013,\
    phase:4,\
    deny,\
    status:403,\
    log,\
    msg:'Posible fuga de stack trace o debugger de Python en respuesta',\
    severity:'CRITICAL',\
    tag:'DATA_LEAKAGE/STACK_TRACE'"

# ═══════════════════════════════════════════════════════════════════════
# EXCLUSIONES DE FALSOS POSITIVOS (Inbound)
# ═══════════════════════════════════════════════════════════════════════

# ─── Exclusiones para rutas de autenticación ───────────────────────────
# POST /api/auth/register y /api/auth/login envían JSON con "password"
# que activa reglas SQL injection (942xxx) y XSS (941xxx).
SecRule REQUEST_URI "@beginsWith /api/auth/" \
    "id:10001,\
    phase:1,\
    pass,\
    nolog,\
    ctl:ruleRemoveTargetById=941100-941999;ARGS:password,\
    ctl:ruleRemoveTargetById=942100-942999;ARGS:password,\
    ctl:ruleRemoveTargetById=920272;ARGS:password"

# El campo recaptcha_token puede contener caracteres base64 largos
SecRule REQUEST_URI "@beginsWith /api/auth/" \
    "id:10002,\
    phase:1,\
    pass,\
    nolog,\
    ctl:ruleRemoveTargetById=941100-941999;ARGS:recaptcha_token,\
    ctl:ruleRemoveTargetById=942100-942999;ARGS:recaptcha_token"

# ─── Exclusiones para rutas de datos ──────────────────────────────────
# Los nombres de usuario pueden contener caracteres Unicode/especiales
SecRule REQUEST_URI "@beginsWith /api/user" \
    "id:10003,\
    phase:1,\
    pass,\
    nolog,\
    ctl:ruleRemoveTargetById=941100-941999;ARGS:first_name,\
    ctl:ruleRemoveTargetById=941100-941999;ARGS:last_name,\
    ctl:ruleRemoveTargetById=942100-942999;ARGS:first_name,\
    ctl:ruleRemoveTargetById=942100-942999;ARGS:last_name"

# ─── Exclusión para el supervisor (solo desarrollo) ──────────────────
# El supervisor es un dashboard interno que muestra estadísticas de
# tráfico y base de datos. Su contenido HTML/JS puede activar reglas
# de detección de inyección (inbound y outbound).
# Se excluyen familias de reglas específicas por ID (NO se desactiva
# el motor completo del WAF). En producción, el supervisor debe estar
# desactivado (APP_SUPERVISOR=0), por lo que esta exclusión no aplica.
#
# Reglas excluidas por familia:
#   - 941xxx: XSS (el HTML del dashboard contiene JavaScript inline)
#   - 942xxx: SQL injection (el dashboard muestra queries/datos de BD)
#   - 951xxx: SQL information leakage (respuestas con datos SQL)
#   - 952xxx: Data leakage (rutas de ficheros en la interfaz)
#   - 953xxx: PHP/Java information leakage (patrones genéricos)
#   - 954xxx: Application errors (mensajes de estado del sistema)
SecRule REQUEST_URI "@beginsWith /supervisor" \
    "id:10004,\
    phase:1,\
    pass,\
    nolog,\
    ctl:ruleRemoveById=941100-941999,\
    ctl:ruleRemoveById=942100-942999,\
    ctl:ruleRemoveById=951100-951999,\
    ctl:ruleRemoveById=952100-952999,\
    ctl:ruleRemoveById=953100-953999,\
    ctl:ruleRemoveById=954100-954999"

# Exclusión de las reglas personalizadas de exfiltración (10010-10013)
# para el supervisor, ya que su contenido legítimo activa estas reglas.
SecRule REQUEST_URI "@beginsWith /supervisor" \
    "id:10005,\
    phase:1,\
    pass,\
    nolog,\
    ctl:ruleRemoveById=10010-10013"
