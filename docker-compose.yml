# Docker Compose - Aplicación Médica con DefectDojo
#
# Este archivo define todos los servicios Docker de la aplicación:
#
# SERVICIOS PRINCIPALES (sin perfil, se arrancan por defecto):
# - waf: ModSecurity + OWASP CRS (Nginx reverse proxy, puerto 5001)
# - web: Aplicación Flask principal (solo accesible internamente por el WAF)
#
# SERVICIOS CON PERFIL "tests" (solo con --profile tests o docker-compose run):
# - frontend-tests: Ejecución de tests del frontend
#
# SERVICIOS CON PERFIL "defectdojo" (solo con --profile defectdojo):
# - defectdojo-db: Base de datos PostgreSQL para DefectDojo
# - defectdojo-redis: Redis para cache y tareas asíncronas
# - defectdojo: Servidor principal de DefectDojo (Django)
# - defectdojo-nginx: Servidor web Nginx para servir archivos estáticos (puerto 8080)
# - defectdojo-celeryworker: Worker de Celery para tareas asíncronas
# - defectdojo-celerybeat: Scheduler de Celery para tareas programadas
#
# NOTA: El servicio defectdojo ejecuta automáticamente init_defectdojo_internal.py
# al arrancar para inicializar la base de datos y crear findings si es necesario.
# Usa la variable DD_SKIP_FINDINGS=True para saltar la creación de findings.

services:
  # ── WAF: ModSecurity v3 + OWASP Core Rule Set (Nginx reverse proxy) ──
  # Filtra todo el tráfico antes de pasarlo al backend Flask.
  # El usuario sigue accediendo por http://localhost:5001 como antes.
  waf:
    image: owasp/modsecurity-crs:nginx-alpine
    container_name: waf_modsecurity
    ports:
      - "5001:8080"
    environment:
      - BACKEND=http://web:5001
      # ModSecurity: On = bloquea, DetectionOnly = solo registra
      - MODSEC_RULE_ENGINE=On
      # OWASP CRS Paranoia Level (1-4). 1 = mínimo de falsos positivos.
      - PARANOIA=1
      - ANOMALY_INBOUND=5
      - ANOMALY_OUTBOUND=4
      # Permitir Content-Type JSON (necesario para la API REST)
      - ALLOWED_METHODS=GET HEAD POST OPTIONS PUT DELETE
      - ALLOWED_REQUEST_CONTENT_TYPE=|application/x-www-form-urlencoded||multipart/form-data||text/xml||application/xml||application/soap+xml||application/json||application/octet-stream|
    volumes:
      - ./waf/modsecurity-override.conf:/etc/modsecurity.d/owasp-crs/rules/RESPONSE-999-EXCLUSION-RULES-AFTER-CRS.conf:ro
      - ./data/waf:/var/log/modsecurity:rw
    depends_on:
      web:
        condition: service_healthy
    networks:
      - proxy-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/"]
      interval: 30s
      timeout: 5s
      start_period: 15s
      retries: 3

  # ── Backend Flask (solo accesible internamente por el WAF) ──
  web:
    build: .
    expose:
      - "5001"
    container_name: flask_medical_register
    networks:
      - proxy-network
    restart: unless-stopped
    volumes:
      - .:/app
      - /var/run/docker.sock:/var/run/docker.sock:ro  # Montar socket de Docker para ejecutar comandos docker
    environment:
      - FLASK_ENV=development
      - STORAGE_BACKEND=${STORAGE_BACKEND:-sqlite}
      - SQLITE_DB_PATH=${SQLITE_DB_PATH:-/app/data/app.db}
      - SQLCIPHER_DB_PATH=${SQLCIPHER_DB_PATH:-/app/data/app_secure.db}
      - SQLCIPHER_KEY=${SQLCIPHER_KEY:-}
      - PASSWORD_PEPPER=${PASSWORD_PEPPER:-}
      # reCAPTCHA v3 (login/register). Si no se definen en .env, la app usa los valores por defecto de config.py
      - RECAPTCHA_SITE_KEY=${RECAPTCHA_SITE_KEY:-}
      - RECAPTCHA_SECRET_KEY=${RECAPTCHA_SECRET_KEY:-}
      # Supervisor (tráfico y DB): 1 = activo (por defecto en desarrollo). En producción usar APP_SUPERVISOR=0
      - APP_SUPERVISOR=${APP_SUPERVISOR:-1}
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:5001')"]
      interval: 30s
      timeout: 3s
      start_period: 5s
      retries: 3

  # Servicio opcional para ejecutar tests del frontend
  # Uso: docker-compose run --rm frontend-tests
  # Perfil: tests - Solo se arranca con --profile tests o explícitamente con run
  frontend-tests:
    profiles:
      - tests
    build:
      context: .
      dockerfile: Dockerfile.test
    restart: unless-stopped
    volumes:
      - .:/app
    command: npm test

  # Servicio opcional: frontend-only en modo local (simula offline)
  # Perfil: local - Solo se arranca con --profile local
  frontend-local:
    profiles:
      - local
    build: .
    container_name: frontend_local_medical_register
    ports:
      - "5001:5001"
    volumes:
      - .:/app
    environment:
      - FLASK_ENV=development
    command: ["python", "/app/scripts/local_frontend_app.py"]

  # Base de datos PostgreSQL para DefectDojo
  # Perfil: defectdojo - Solo se arranca con --profile defectdojo
  defectdojo-db:
    profiles:
      - defectdojo
    image: postgres:15-alpine
    container_name: defectdojo-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: defectdojo
      POSTGRES_PASSWORD: defectdojo_password
      POSTGRES_DB: defectdojo
    ports:
      - "5432:5432"
    volumes:
      - ./data/postgres:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U defectdojo"]
      interval: 15s
      timeout: 10s
      retries: 10
      start_period: 30s
    networks:
      - defectdojo-network

  # Redis para DefectDojo (cache y tareas asíncronas)
  # Perfil: defectdojo - Solo se arranca con --profile defectdojo
  defectdojo-redis:
    profiles:
      - defectdojo
    image: redis:7-alpine
    container_name: defectdojo-redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    volumes:
      - ./data/redis:/data
    command: redis-server --maxmemory 256mb --maxmemory-policy allkeys-lru
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 15s
      timeout: 10s
      retries: 10
      start_period: 20s
    networks:
      - defectdojo-network

  # DefectDojo - Gestión de Vulnerabilidades de Seguridad
  # Perfil: defectdojo - Solo se arranca con --profile defectdojo
  defectdojo:
    profiles:
      - defectdojo
    image: defectdojo/defectdojo-django:latest
    container_name: defectdojo
    restart: unless-stopped
    expose:
      - "8081"
    networks:
      defectdojo-network:
        aliases:
          - uwsgi
    environment:
      DD_DATABASE_URL: postgresql://defectdojo:defectdojo_password@defectdojo-db:5432/defectdojo
      DD_CELERY_BROKER_URL: redis://defectdojo-redis:6379/0
      DD_CELERY_RESULT_BACKEND: redis://defectdojo-redis:6379/0
      DD_SECRET_KEY: defectdojo_secret_key_change_in_production
      DD_DEBUG: "True"
      DD_ALLOWED_HOSTS: "*"
      DD_WHITENOISE: "False"
      DD_STATIC_ROOT: /app/static
      DD_STATIC_URL: /static/
      DD_DATABASE_ENGINE: django.db.backends.postgresql
      DD_DATABASE_NAME: defectdojo
      DD_DATABASE_USER: defectdojo
      DD_DATABASE_PASSWORD: defectdojo_password
      DD_DATABASE_HOST: defectdojo-db
      DD_DATABASE_PORT: "5432"
    depends_on:
      defectdojo-db:
        condition: service_healthy
      defectdojo-redis:
        condition: service_healthy
    volumes:
      - ./data/defectdojo/media:/app/media
      - ./data/defectdojo/static:/app/static
      - ./scripts/init_defectdojo_internal.py:/app/init_defectdojo.py:ro
      - ./scripts/manage_findings.py:/app/manage_findings.py:ro
      - ./scripts/wstg_sync_service.py:/app/scripts/wstg_sync_service.py:ro
      - ./scripts/wstg_sync_handler.py:/app/scripts/wstg_sync_handler.py:ro
      - ./scripts/generate_asvs_report.py:/app/scripts/generate_asvs_report.py:ro
      - ./scripts/generate_pdf_report.py:/app/scripts/generate_pdf_report.py:ro
      - ./app/wstg_sync.py:/app/app/wstg_sync.py:ro
      - ./data:/app/data
      - ./docs:/app/docs
    entrypoint: ["/bin/sh", "-c", "python /app/init_defectdojo.py && exec /entrypoint-uwsgi.sh"]
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8081/')"]
      interval: 60s
      timeout: 30s
      retries: 10
      start_period: 300s

  # DefectDojo Nginx - Servidor web para servir archivos estáticos y hacer proxy
  # Perfil: defectdojo - Solo se arranca con --profile defectdojo
  defectdojo-nginx:
    profiles:
      - defectdojo
    image: defectdojo/defectdojo-nginx:latest
    container_name: defectdojo-nginx
    restart: unless-stopped
    ports:
      - "8080:8080"
    depends_on:
      defectdojo:
        condition: service_healthy
    volumes:
      - ./data/defectdojo/static:/app/static
    networks:
      - defectdojo-network
      - proxy-network
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:8080/ || exit 1"]
      interval: 60s
      timeout: 20s
      retries: 10
      start_period: 30s

  # DefectDojo Celery Worker (tareas asíncronas)
  # Perfil: defectdojo - Solo se arranca con --profile defectdojo
  defectdojo-celeryworker:
    profiles:
      - defectdojo
    image: defectdojo/defectdojo-django:latest
    container_name: defectdojo-celeryworker
    command: celery -A dojo worker -l info
    environment:
      DD_DATABASE_URL: postgresql://defectdojo:defectdojo_password@defectdojo-db:5432/defectdojo
      DD_CELERY_BROKER_URL: redis://defectdojo-redis:6379/0
      DD_CELERY_RESULT_BACKEND: redis://defectdojo-redis:6379/0
      DD_SECRET_KEY: defectdojo_secret_key_change_in_production
      DD_DEBUG: "True"
      DD_ALLOWED_HOSTS: "*"
    restart: unless-stopped
    depends_on:
      - defectdojo-db
      - defectdojo-redis
      - defectdojo
    volumes:
      - ./data/defectdojo/media:/app/media
    networks:
      - defectdojo-network

  # DefectDojo Celery Beat (tareas programadas)
  # Perfil: defectdojo - Solo se arranca con --profile defectdojo
  defectdojo-celerybeat:
    profiles:
      - defectdojo
    image: defectdojo/defectdojo-django:latest
    container_name: defectdojo-celerybeat
    command: celery -A dojo beat -l info
    environment:
      DD_DATABASE_URL: postgresql://defectdojo:defectdojo_password@defectdojo-db:5432/defectdojo
      DD_CELERY_BROKER_URL: redis://defectdojo-redis:6379/0
      DD_CELERY_RESULT_BACKEND: redis://defectdojo-redis:6379/0
      DD_SECRET_KEY: defectdojo_secret_key_change_in_production
      DD_DEBUG: "True"
      DD_ALLOWED_HOSTS: "*"
    restart: unless-stopped
    depends_on:
      - defectdojo-db
      - defectdojo-redis
      - defectdojo
    volumes:
      - ./data/defectdojo/media:/app/media
    networks:
      - defectdojo-network

  # Servicio de sincronización WSTG (Background)
  wstg-sync:
    profiles:
      - defectdojo
    image: defectdojo/defectdojo-django:latest
    container_name: wstg-sync-service
    restart: unless-stopped
    entrypoint: ["python"]
    depends_on:
      defectdojo:
        condition: service_healthy
      defectdojo-db:
        condition: service_healthy
    volumes:
      - ./scripts/wstg_sync_service.py:/app/wstg_sync_service.py:ro
      - ./scripts/wstg_sync_handler.py:/app/scripts/wstg_sync_handler.py:ro
      - ./app/wstg_sync.py:/app/app/wstg_sync.py:ro
      - ./data:/app/data
    environment:
      DD_DATABASE_URL: postgresql://defectdojo:defectdojo_password@defectdojo-db:5432/defectdojo
      DD_SECRET_KEY: defectdojo_secret_key_change_in_production
      DD_DEBUG: "True"
      WSTG_SYNC_INTERVAL: ${WSTG_SYNC_INTERVAL:-5}
    command: ["/app/wstg_sync_service.py", "--interval", "${WSTG_SYNC_INTERVAL:-5}"]
    networks:
      - defectdojo-network
    healthcheck:
      test: ["CMD", "python", "-c", "import sys; sys.exit(0)"]
      interval: 60s
      timeout: 10s
      retries: 3

networks:
  defectdojo-network:
    driver: bridge
  proxy-network:
    external: true