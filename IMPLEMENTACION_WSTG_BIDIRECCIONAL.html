<!doctype html>
<html class="no-js" lang="en" data-content_root="./">
  <head><meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="color-scheme" content="light dark"><meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="index" title="Index" href="genindex.html"><link rel="search" title="Search" href="search.html">

    <!-- Generated with Sphinx 8.1.3 and Furo 2025.09.25 -->
        <title>Implementación Completa: Integración Bidireccional Automática WSTG Tracker ↔ DefectDojo - Medical Register 0.1.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=d111a655" />
    <link rel="stylesheet" type="text/css" href="_static/styles/furo.css?v=580074bf" />
    <link rel="stylesheet" type="text/css" href="_static/styles/furo-extensions.css?v=8dab3a3b" />
    
    


<style>
  body {
    --color-code-background: #f2f2f2;
  --color-code-foreground: #1e1e1e;
  --color-brand-primary: #254F6D;
  --color-brand-content: #254F6D;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-with-moon" viewBox="0 0 24 24">
    <title>Auto light/dark, in light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path style="opacity: 50%" d="M 5.411 14.504 C 5.471 14.504 5.532 14.504 5.591 14.504 C 3.639 16.319 4.383 19.569 6.931 20.352 C 7.693 20.586 8.512 20.551 9.25 20.252 C 8.023 23.207 4.056 23.725 2.11 21.184 C 0.166 18.642 1.702 14.949 4.874 14.536 C 5.051 14.512 5.231 14.5 5.411 14.5 L 5.411 14.504 Z"/>
      <line x1="14.5" y1="3.25" x2="14.5" y2="1.25"/>
      <line x1="14.5" y1="15.85" x2="14.5" y2="17.85"/>
      <line x1="10.044" y1="5.094" x2="8.63" y2="3.68"/>
      <line x1="19" y1="14.05" x2="20.414" y2="15.464"/>
      <line x1="8.2" y1="9.55" x2="6.2" y2="9.55"/>
      <line x1="20.8" y1="9.55" x2="22.8" y2="9.55"/>
      <line x1="10.044" y1="14.006" x2="8.63" y2="15.42"/>
      <line x1="19" y1="5.05" x2="20.414" y2="3.636"/>
      <circle cx="14.5" cy="9.55" r="3.6"/>
    </svg>
  </symbol>
  <symbol id="svg-moon-with-sun" viewBox="0 0 24 24">
    <title>Auto light/dark, in dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path d="M 8.282 7.007 C 8.385 7.007 8.494 7.007 8.595 7.007 C 5.18 10.184 6.481 15.869 10.942 17.24 C 12.275 17.648 13.706 17.589 15 17.066 C 12.851 22.236 5.91 23.143 2.505 18.696 C -0.897 14.249 1.791 7.786 7.342 7.063 C 7.652 7.021 7.965 7 8.282 7 L 8.282 7.007 Z"/>
      <line style="opacity: 50%" x1="18" y1="3.705" x2="18" y2="2.5"/>
      <line style="opacity: 50%" x1="18" y1="11.295" x2="18" y2="12.5"/>
      <line style="opacity: 50%" x1="15.316" y1="4.816" x2="14.464" y2="3.964"/>
      <line style="opacity: 50%" x1="20.711" y1="10.212" x2="21.563" y2="11.063"/>
      <line style="opacity: 50%" x1="14.205" y1="7.5" x2="13.001" y2="7.5"/>
      <line style="opacity: 50%" x1="21.795" y1="7.5" x2="23" y2="7.5"/>
      <line style="opacity: 50%" x1="15.316" y1="10.184" x2="14.464" y2="11.036"/>
      <line style="opacity: 50%" x1="20.711" y1="4.789" x2="21.563" y2="3.937"/>
      <circle style="opacity: 50%" cx="18" cy="7.5" r="2.169"/>
    </svg>
  </symbol>
  <symbol id="svg-pencil" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-pencil-code">
      <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" />
      <path d="M13.5 6.5l4 4" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
  <symbol id="svg-eye" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-eye-code">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
      <path
        d="M11.11 17.958c-3.209 -.307 -5.91 -2.293 -8.11 -5.958c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6c-.21 .352 -.427 .688 -.647 1.008" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle site navigation sidebar">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc" aria-label="Toggle table of contents sidebar">
<label class="overlay sidebar-overlay" for="__navigation"></label>
<label class="overlay toc-overlay" for="__toc"></label>

<a class="skip-to-content muted-link" href="#furo-main-content">Skip to content</a>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <span class="icon"><svg><use href="#svg-menu"></use></svg></span>
      </label>
    </div>
    <div class="header-center">
      <a href="index.html"><div class="brand">Medical Register 0.1.0 documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle" aria-label="Toggle Light / Dark / Auto color theme">
          <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
          <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <span class="icon"><svg><use href="#svg-toc"></use></svg></span>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="index.html">
  
  
</a><form class="sidebar-search-container" method="get" action="search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <p class="caption" role="heading"><span class="caption-text">Contenido:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="manual.html">Manual de Usuario - Registro Personal de Peso e IMC</a></li>
<li class="toctree-l1"><a class="reference internal" href="requeriments.html">Requerimientos Funcionales</a></li>
<li class="toctree-l1"><a class="reference internal" href="INFORME_SEGURIDAD.html">Informe de Análisis de Seguridad - Aplicación Médica</a></li>
<li class="toctree-l1"><a class="reference internal" href="INICIO_RAPIDO.html">Inicio Rápido</a></li>
<li class="toctree-l1"><a class="reference internal" href="mockups/MOCKUPS.html">Mockups y Diagramas</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">DefectDojo:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="defectdojo/ANALISIS_CWE_699.html">Análisis de Seguridad según CWE-699</a></li>
<li class="toctree-l1"><a class="reference internal" href="defectdojo/ESTADO_ACTUAL_CWE_699.html">Estado Actual del Programa - Análisis CWE-699</a></li>
<li class="toctree-l1"><a class="reference internal" href="defectdojo/DEFECTDOJO_CONFIGURACION.html">Configuración de DefectDojo</a></li>
<li class="toctree-l1"><a class="reference internal" href="defectdojo/DEFECTDOJO_CREDENTIALS.html">Credenciales de DefectDojo</a></li>
<li class="toctree-l1"><a class="reference internal" href="defectdojo/DEFECTDOJO_DATABASE.html">Gestión de Base de Datos de DefectDojo</a></li>
<li class="toctree-l1"><a class="reference internal" href="defectdojo/DEFECTDOJO_INTEGRATION.html">Integración de DefectDojo</a></li>
<li class="toctree-l1"><a class="reference internal" href="defectdojo/DEFECTDOJO_FLUJO_CREACION_RESOLUCION.html">Flujo de Creación y Resolución de Findings en DefectDojo</a></li>
<li class="toctree-l1"><a class="reference internal" href="defectdojo/DEFECTDOJO_FLUJO_IMPLEMENTADO.html">Flujo de Creación → Resolución Implementado en DefectDojo</a></li>
<li class="toctree-l1"><a class="reference internal" href="defectdojo/MAKE_ALL_USO.html">Uso de <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">update</span></code> - Flujo Completo de DefectDojo</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="view-this-page">
  <a class="muted-link" href="_sources/IMPLEMENTACION_WSTG_BIDIRECCIONAL.md.txt" title="View this page">
    <svg><use href="#svg-eye"></use></svg>
    <span class="visually-hidden">View this page</span>
  </a>
</div>
<div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle" aria-label="Toggle Light / Dark / Auto color theme">
              <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
              <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <span class="icon"><svg><use href="#svg-toc"></use></svg></span>
          </label>
        </div>
        <article role="main" id="furo-main-content">
          <section id="implementacion-completa-integracion-bidireccional-automatica-wstg-tracker-defectdojo">
<h1>Implementación Completa: Integración Bidireccional Automática WSTG Tracker ↔ DefectDojo<a class="headerlink" href="#implementacion-completa-integracion-bidireccional-automatica-wstg-tracker-defectdojo" title="Link to this heading">¶</a></h1>
<section id="confirmacion-automatizacion-total">
<h2>✅ Confirmación: Automatización Total<a class="headerlink" href="#confirmacion-automatizacion-total" title="Link to this heading">¶</a></h2>
<p><strong>SÍ, la integración bidireccional es totalmente automática</strong> con los componentes implementados en este documento.</p>
<section id="componentes-de-automatizacion">
<h3>Componentes de Automatización<a class="headerlink" href="#componentes-de-automatizacion" title="Link to this heading">¶</a></h3>
<ol class="arabic simple">
<li><p><strong>Sincronización Tracker → DefectDojo</strong>: Automática en tiempo real</p></li>
<li><p><strong>Sincronización DefectDojo → Tracker</strong>: Automática vía webhooks + polling</p></li>
<li><p><strong>Servicio de Sincronización</strong>: Background service con resolución automática de conflictos</p></li>
<li><p><strong>Reintentos Automáticos</strong>: Cola de sincronizaciones fallidas con reintentos</p></li>
<li><p><strong>Logging y Monitoreo</strong>: Registro completo de todas las operaciones</p></li>
</ol>
</section>
</section>
<hr class="docutils" />
<section id="indice">
<h2>Índice<a class="headerlink" href="#indice" title="Link to this heading">¶</a></h2>
<ol class="arabic simple">
<li><p><a class="reference internal" href="#1-arquitectura-completa"><span class="xref myst">Arquitectura Completa</span></a></p></li>
<li><p><a class="reference internal" href="#2-gu%C3%ADa-de-desarrollo-paso-a-paso"><span class="xref myst">Guía de Desarrollo Paso a Paso</span></a></p></li>
<li><p><a class="reference internal" href="#3-implementaci%C3%B3n-completa-de-c%C3%B3digo"><span class="xref myst">Implementación Completa de Código</span></a></p></li>
<li><p><a class="reference internal" href="#4-automatizaci%C3%B3n-del-wstg-tracker"><span class="xref myst">Automatización del WSTG Tracker</span></a></p></li>
<li><p><a class="reference internal" href="#5-configuraci%C3%B3n-de-webhooks"><span class="xref myst">Configuración de Webhooks</span></a></p></li>
<li><p><a class="reference internal" href="#6-servicios-en-background"><span class="xref myst">Servicios en Background</span></a></p></li>
<li><p><a class="reference internal" href="#7-testing-y-validaci%C3%B3n"><span class="xref myst">Testing y Validación</span></a></p></li>
<li><p><a class="reference internal" href="#8-monitoreo-y-alertas"><span class="xref myst">Monitoreo y Alertas</span></a></p></li>
<li><p><a class="reference internal" href="#9-troubleshooting"><span class="xref myst">Troubleshooting</span></a></p></li>
</ol>
</section>
<hr class="docutils" />
<section id="arquitectura-completa">
<h2>1. Arquitectura Completa<a class="headerlink" href="#arquitectura-completa" title="Link to this heading">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>┌─────────────────────────────────────────────────────────────────────┐
│                    WSTG Tracker (Frontend)                          │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │  Checklist UI + Auto-Sync                                    │  │
│  │  - Estados: Not Started, In Progress, Blocked, Done, N/A    │  │
│  │  - localStorage (persistencia local)                         │  │
│  │  - Auto-sync al cambiar estado (JavaScript)                 │  │
│  │  - Cola de reintentos automáticos                            │  │
│  └──────────────┬───────────────────────────────────────────────┘  │
│                 │ HTTP POST /api/wstg/sync (automático)            │
└─────────────────┼───────────────────────────────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────────────────────────────────┐
│              API Flask (Aplicación Médica)                          │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │  /api/wstg/sync (POST)                                        │  │
│  │  - Recibe actualizaciones del tracker                         │  │
│  │  - Valida y procesa cambios                                   │  │
│  │  - Actualiza DefectDojo automáticamente                      │  │
│  │  - Registra en log                                            │  │
│  └──────────────┬───────────────────────────────────────────────┘  │
│                 │                                                   │
│  ┌──────────────▼───────────────────────────────────────────────┐  │
│  │  /api/wstg/webhook (POST)                                     │  │
│  │  - Recibe webhooks de DefectDojo                             │  │
│  │  - Procesa cambios en findings                               │  │
│  │  - Almacena para sincronización con tracker                  │  │
│  └──────────────┬───────────────────────────────────────────────┘  │
│                 │                                                   │
│  ┌──────────────▼───────────────────────────────────────────────┐  │
│  │  Servicio de Sincronización (Background)                     │  │
│  │  - Polling periódico cada 5 minutos                          │  │
│  │  - Detecta cambios automáticamente                           │  │
│  │  - Resuelve conflictos automáticamente                       │  │
│  │  - Reintenta fallos automáticamente                          │  │
│  │  - Logging completo                                           │  │
│  └──────────────┬───────────────────────────────────────────────┘  │
└─────────────────┼───────────────────────────────────────────────────┘
                  │
                  │ API DefectDojo + Webhooks
                  ▼
┌─────────────────────────────────────────────────────────────────────┐
│                    DefectDojo                                        │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │  Findings + Webhooks                                          │  │
│  │  - Test Type: &quot;WSTG Security Testing&quot;                        │  │
│  │  - Tags: [&quot;WSTG&quot;, &quot;INFO-01&quot;, ...]                            │  │
│  │  - Webhook configurado → /api/wstg/webhook                  │  │
│  └──────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────┘
</pre></div>
</div>
</section>
<hr class="docutils" />
<section id="guia-de-desarrollo-paso-a-paso">
<h2>2. Guía de Desarrollo Paso a Paso<a class="headerlink" href="#guia-de-desarrollo-paso-a-paso" title="Link to this heading">¶</a></h2>
<section id="paso-1-crear-modulo-de-sincronizacion-base">
<h3>2.1 Paso 1: Crear Módulo de Sincronización Base<a class="headerlink" href="#paso-1-crear-modulo-de-sincronizacion-base" title="Link to this heading">¶</a></h3>
<p><strong>Archivo</strong>: <code class="docutils literal notranslate"><span class="pre">app/wstg_sync.py</span></code> (NUEVO)</p>
<p>Este es el módulo principal que contiene toda la lógica de sincronización.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python3</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Módulo de sincronización bidireccional WSTG ↔ DefectDojo</span>
<span class="sd">Implementación completa con logging, manejo de errores y resolución de conflictos</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">django</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>

<span class="c1"># Configurar logging</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;wstg_sync&#39;</span><span class="p">)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>

<span class="c1"># Configurar Django para acceso a DefectDojo</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;/app&#39;</span><span class="p">)</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;DJANGO_SETTINGS_MODULE&#39;</span><span class="p">,</span> <span class="s1">&#39;dojo.settings.settings&#39;</span><span class="p">)</span>
<span class="n">django</span><span class="o">.</span><span class="n">setup</span><span class="p">()</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">dojo.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">Finding</span><span class="p">,</span> <span class="n">Test</span><span class="p">,</span> <span class="n">Engagement</span><span class="p">,</span> <span class="n">Product</span><span class="p">,</span> <span class="n">Product_Type</span><span class="p">,</span> <span class="n">Test_Type</span><span class="p">,</span> <span class="n">Tag</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.contrib.auth.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">User</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">timezone</span>

<span class="c1"># Mapeo de estados WSTG → DefectDojo</span>
<span class="n">WSTG_TO_DD_STATUS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;Not Started&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;active&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;verified&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;false_p&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">},</span>
    <span class="s1">&#39;In Progress&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;active&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;verified&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;false_p&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">},</span>
    <span class="s1">&#39;Blocked&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;active&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;verified&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;false_p&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">},</span>
    <span class="s1">&#39;Done&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;active&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;verified&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;false_p&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">},</span>
    <span class="s1">&#39;Not Applicable&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;active&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;verified&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;false_p&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
<span class="p">}</span>

<span class="c1"># Mapeo inverso DefectDojo → WSTG</span>
<span class="n">DD_TO_WSTG_STATUS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span> <span class="s1">&#39;In Progress&#39;</span><span class="p">,</span>   <span class="c1"># active=True, verified=False, false_p=False</span>
    <span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span> <span class="s1">&#39;Done&#39;</span><span class="p">,</span>           <span class="c1"># active=False, verified=True, false_p=False</span>
    <span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span> <span class="s1">&#39;Not Applicable&#39;</span><span class="p">,</span> <span class="c1"># active=False, verified=False, false_p=True</span>
    <span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span> <span class="s1">&#39;Not Started&#39;</span>   <span class="c1"># active=False, verified=False, false_p=False</span>
<span class="p">}</span>

<span class="c1"># Archivo para almacenar estado de sincronización</span>
<span class="n">SYNC_STATE_FILE</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;/app/data/wstg_sync_state.json&#39;</span><span class="p">)</span>
<span class="n">SYNC_LOG_FILE</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;/app/data/wstg_sync.log&#39;</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">init_logging</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Inicializar logging a archivo&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">SYNC_LOG_FILE</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="n">SYNC_LOG_FILE</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="n">file_handler</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">FileHandler</span><span class="p">(</span><span class="n">SYNC_LOG_FILE</span><span class="p">)</span>
    <span class="n">file_handler</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
    <span class="n">formatter</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span>
        <span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="s1"> - </span><span class="si">%(name)s</span><span class="s1"> - </span><span class="si">%(levelname)s</span><span class="s1"> - </span><span class="si">%(message)s</span><span class="s1">&#39;</span>
    <span class="p">)</span>
    <span class="n">file_handler</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">formatter</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">file_handler</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">load_sync_state</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Cargar estado de sincronización desde archivo JSON&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">SYNC_STATE_FILE</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">SYNC_STATE_FILE</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error cargando estado de sincronización: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{}</span>


<span class="k">def</span><span class="w"> </span><span class="nf">save_sync_state</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">Dict</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Guardar estado de sincronización a archivo JSON&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">SYNC_STATE_FILE</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="n">SYNC_STATE_FILE</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">SYNC_STATE_FILE</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error guardando estado de sincronización: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">log_sync</span><span class="p">(</span><span class="n">wstg_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">direction</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">old_status</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> 
             <span class="n">new_status</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">success</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">error_message</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Registrar sincronización en log&quot;&quot;&quot;</span>
    <span class="n">log_entry</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
        <span class="s1">&#39;wstg_id&#39;</span><span class="p">:</span> <span class="n">wstg_id</span><span class="p">,</span>
        <span class="s1">&#39;direction&#39;</span><span class="p">:</span> <span class="n">direction</span><span class="p">,</span>
        <span class="s1">&#39;old_status&#39;</span><span class="p">:</span> <span class="n">old_status</span><span class="p">,</span>
        <span class="s1">&#39;new_status&#39;</span><span class="p">:</span> <span class="n">new_status</span><span class="p">,</span>
        <span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="n">success</span><span class="p">,</span>
        <span class="s1">&#39;error_message&#39;</span><span class="p">:</span> <span class="n">error_message</span>
    <span class="p">}</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sync: </span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">log_entry</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="c1"># También guardar en estado</span>
    <span class="n">state</span> <span class="o">=</span> <span class="n">load_sync_state</span><span class="p">()</span>
    <span class="k">if</span> <span class="s1">&#39;sync_log&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">state</span><span class="p">:</span>
        <span class="n">state</span><span class="p">[</span><span class="s1">&#39;sync_log&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">state</span><span class="p">[</span><span class="s1">&#39;sync_log&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">log_entry</span><span class="p">)</span>
    <span class="c1"># Mantener solo últimos 1000 registros</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;sync_log&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1000</span><span class="p">:</span>
        <span class="n">state</span><span class="p">[</span><span class="s1">&#39;sync_log&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s1">&#39;sync_log&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1000</span><span class="p">:]</span>
    <span class="n">save_sync_state</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">get_wstg_test_and_engagement</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Obtener o crear Test y Engagement para WSTG&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">admin_user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s1">&#39;admin&#39;</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">User</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Usuario admin no encontrado&quot;</span><span class="p">)</span>
        <span class="k">raise</span>
    
    <span class="n">product_type</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">Product_Type</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Medical Register&#39;</span><span class="p">,</span>
        <span class="n">defaults</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="s1">&#39;Aplicación de registro médico&#39;</span><span class="p">}</span>
    <span class="p">)</span>
    
    <span class="n">product</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">Product</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Medical Register App&#39;</span><span class="p">,</span>
        <span class="n">defaults</span><span class="o">=</span><span class="p">{</span>
            <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="s1">&#39;Aplicación web para registro de peso e IMC&#39;</span><span class="p">,</span>
            <span class="s1">&#39;prod_type&#39;</span><span class="p">:</span> <span class="n">product_type</span>
        <span class="p">}</span>
    <span class="p">)</span>
    
    <span class="n">engagement</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">Engagement</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;WSTG Security Testing&#39;</span><span class="p">,</span>
        <span class="n">product</span><span class="o">=</span><span class="n">product</span><span class="p">,</span>
        <span class="n">defaults</span><span class="o">=</span><span class="p">{</span>
            <span class="s1">&#39;target_start&#39;</span><span class="p">:</span> <span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">date</span><span class="p">(),</span>
            <span class="s1">&#39;target_end&#39;</span><span class="p">:</span> <span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">date</span><span class="p">(),</span>
            <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;In Progress&#39;</span><span class="p">,</span>
            <span class="s1">&#39;lead&#39;</span><span class="p">:</span> <span class="n">admin_user</span>
        <span class="p">}</span>
    <span class="p">)</span>
    
    <span class="n">test_type</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">Test_Type</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;WSTG Security Testing&#39;</span><span class="p">)</span>
    
    <span class="n">test</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">Test</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span>
        <span class="n">engagement</span><span class="o">=</span><span class="n">engagement</span><span class="p">,</span>
        <span class="n">test_type</span><span class="o">=</span><span class="n">test_type</span><span class="p">,</span>
        <span class="n">defaults</span><span class="o">=</span><span class="p">{</span>
            <span class="s1">&#39;target_start&#39;</span><span class="p">:</span> <span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">date</span><span class="p">(),</span>
            <span class="s1">&#39;target_end&#39;</span><span class="p">:</span> <span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">date</span><span class="p">(),</span>
            <span class="s1">&#39;lead&#39;</span><span class="p">:</span> <span class="n">admin_user</span>
        <span class="p">}</span>
    <span class="p">)</span>
    
    <span class="k">return</span> <span class="n">test</span><span class="p">,</span> <span class="n">engagement</span>


<span class="k">def</span><span class="w"> </span><span class="nf">get_wstg_info</span><span class="p">(</span><span class="n">wstg_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Obtener información de un item WSTG desde diccionario&quot;&quot;&quot;</span>
    <span class="c1"># Diccionario básico de WSTG (puede expandirse)</span>
    <span class="n">wstg_dictionary</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;WSTG-INFO-01&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="s1">&#39;Conduct OSINT reconnaissance&#39;</span><span class="p">,</span>
            <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="s1">&#39;Gather information about the target through publicly available sources&#39;</span><span class="p">,</span>
            <span class="s1">&#39;severity&#39;</span><span class="p">:</span> <span class="s1">&#39;Info&#39;</span>
        <span class="p">},</span>
        <span class="s1">&#39;WSTG-INFO-02&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="s1">&#39;Fingerprint Web Server&#39;</span><span class="p">,</span>
            <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="s1">&#39;Identify the web server and version&#39;</span><span class="p">,</span>
            <span class="s1">&#39;severity&#39;</span><span class="p">:</span> <span class="s1">&#39;Info&#39;</span>
        <span class="p">},</span>
        <span class="c1"># Añadir más items según necesidad</span>
    <span class="p">}</span>
    
    <span class="k">return</span> <span class="n">wstg_dictionary</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">wstg_id</span><span class="p">,</span> <span class="p">{</span>
        <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">wstg_id</span><span class="si">}</span><span class="s1"> Test&#39;</span><span class="p">,</span>
        <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Security test for </span><span class="si">{</span><span class="n">wstg_id</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
        <span class="s1">&#39;severity&#39;</span><span class="p">:</span> <span class="s1">&#39;Medium&#39;</span>
    <span class="p">})</span>


<span class="k">def</span><span class="w"> </span><span class="nf">find_finding_by_wstg_id</span><span class="p">(</span><span class="n">wstg_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">test</span><span class="p">:</span> <span class="n">Test</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Finding</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Buscar finding por WSTG ID en los tags o título&quot;&quot;&quot;</span>
    <span class="c1"># Buscar por tag exacto</span>
    <span class="n">findings</span> <span class="o">=</span> <span class="n">Finding</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
        <span class="n">test</span><span class="o">=</span><span class="n">test</span><span class="p">,</span>
        <span class="n">tags__name</span><span class="o">=</span><span class="n">wstg_id</span>
    <span class="p">)</span><span class="o">.</span><span class="n">distinct</span><span class="p">()</span>
    
    <span class="k">if</span> <span class="n">findings</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">findings</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
    
    <span class="c1"># Buscar por tag WSTG y verificar título</span>
    <span class="n">findings</span> <span class="o">=</span> <span class="n">Finding</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
        <span class="n">test</span><span class="o">=</span><span class="n">test</span><span class="p">,</span>
        <span class="n">tags__name</span><span class="o">=</span><span class="s1">&#39;WSTG&#39;</span>
    <span class="p">)</span><span class="o">.</span><span class="n">distinct</span><span class="p">()</span>
    
    <span class="k">for</span> <span class="n">finding</span> <span class="ow">in</span> <span class="n">findings</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">wstg_id</span> <span class="ow">in</span> <span class="n">finding</span><span class="o">.</span><span class="n">title</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">finding</span>
    
    <span class="k">return</span> <span class="kc">None</span>


<span class="k">def</span><span class="w"> </span><span class="nf">create_finding_from_wstg</span><span class="p">(</span><span class="n">wstg_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">status</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">notes</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">test</span><span class="p">:</span> <span class="n">Test</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Finding</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Crear nuevo finding desde WSTG&quot;&quot;&quot;</span>
    <span class="n">wstg_info</span> <span class="o">=</span> <span class="n">get_wstg_info</span><span class="p">(</span><span class="n">wstg_id</span><span class="p">)</span>
    <span class="n">status_map</span> <span class="o">=</span> <span class="n">WSTG_TO_DD_STATUS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">WSTG_TO_DD_STATUS</span><span class="p">[</span><span class="s1">&#39;Not Started&#39;</span><span class="p">])</span>
    
    <span class="c1"># Mapear severidad</span>
    <span class="n">severity_map</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;Info&#39;</span><span class="p">:</span> <span class="s1">&#39;Info&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Low&#39;</span><span class="p">:</span> <span class="s1">&#39;Low&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Medium&#39;</span><span class="p">:</span> <span class="s1">&#39;Medium&#39;</span><span class="p">,</span>
        <span class="s1">&#39;High&#39;</span><span class="p">:</span> <span class="s1">&#39;High&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Critical&#39;</span><span class="p">:</span> <span class="s1">&#39;Critical&#39;</span>
    <span class="p">}</span>
    <span class="n">severity</span> <span class="o">=</span> <span class="n">severity_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">wstg_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;severity&#39;</span><span class="p">,</span> <span class="s1">&#39;Medium&#39;</span><span class="p">),</span> <span class="s1">&#39;Medium&#39;</span><span class="p">)</span>
    
    <span class="n">finding</span> <span class="o">=</span> <span class="n">Finding</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
        <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">wstg_id</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">wstg_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;WSTG Test&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="n">wstg_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;description&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
        <span class="n">test</span><span class="o">=</span><span class="n">test</span><span class="p">,</span>
        <span class="n">severity</span><span class="o">=</span><span class="n">severity</span><span class="p">,</span>
        <span class="n">active</span><span class="o">=</span><span class="n">status_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;active&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
        <span class="n">verified</span><span class="o">=</span><span class="n">status_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;verified&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
        <span class="n">false_p</span><span class="o">=</span><span class="n">status_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;false_p&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
        <span class="n">mitigation</span><span class="o">=</span><span class="n">notes</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="n">reporter</span><span class="o">=</span><span class="n">test</span><span class="o">.</span><span class="n">lead</span>
    <span class="p">)</span>
    
    <span class="c1"># Añadir tags</span>
    <span class="n">tag_wstg</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">Tag</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;WSTG&#39;</span><span class="p">)</span>
    <span class="n">tag_id</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">Tag</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">wstg_id</span><span class="p">)</span>
    <span class="n">finding</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tag_wstg</span><span class="p">,</span> <span class="n">tag_id</span><span class="p">)</span>
    
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Finding creado: </span><span class="si">{</span><span class="n">finding</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2"> para </span><span class="si">{</span><span class="n">wstg_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">finding</span>


<span class="k">def</span><span class="w"> </span><span class="nf">extract_wstg_id</span><span class="p">(</span><span class="n">finding</span><span class="p">:</span> <span class="n">Finding</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Extraer WSTG ID de un finding&quot;&quot;&quot;</span>
    <span class="c1"># Buscar en tags</span>
    <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">finding</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">tag</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;WSTG-&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">tag</span><span class="o">.</span><span class="n">name</span>
    
    <span class="c1"># Buscar en título</span>
    <span class="k">if</span> <span class="s1">&#39;WSTG-&#39;</span> <span class="ow">in</span> <span class="n">finding</span><span class="o">.</span><span class="n">title</span><span class="p">:</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;WSTG-\w+-\d+&#39;</span><span class="p">,</span> <span class="n">finding</span><span class="o">.</span><span class="n">title</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="kc">None</span>


<span class="k">def</span><span class="w"> </span><span class="nf">determine_wstg_status</span><span class="p">(</span><span class="n">finding</span><span class="p">:</span> <span class="n">Finding</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Determinar estado WSTG basado en estado del finding&quot;&quot;&quot;</span>
    <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">finding</span><span class="o">.</span><span class="n">active</span><span class="p">,</span> <span class="n">finding</span><span class="o">.</span><span class="n">verified</span><span class="p">,</span> <span class="n">finding</span><span class="o">.</span><span class="n">false_p</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">DD_TO_WSTG_STATUS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="s1">&#39;Not Started&#39;</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">sync_from_tracker</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Sincronizar desde WSTG Tracker hacia DefectDojo</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">wstg_id</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;wstg_id&#39;</span><span class="p">)</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;status&#39;</span><span class="p">)</span>
    <span class="n">notes</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;notes&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">timestamp</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;timestamp&#39;</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">())</span>
    
    <span class="k">if</span> <span class="ow">not</span> <span class="n">wstg_id</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">status</span><span class="p">:</span>
        <span class="n">error_msg</span> <span class="o">=</span> <span class="s2">&quot;wstg_id and status are required&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="n">error_msg</span><span class="p">}</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="n">test</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">get_wstg_test_and_engagement</span><span class="p">()</span>
        
        <span class="c1"># Buscar finding existente</span>
        <span class="n">finding</span> <span class="o">=</span> <span class="n">find_finding_by_wstg_id</span><span class="p">(</span><span class="n">wstg_id</span><span class="p">,</span> <span class="n">test</span><span class="p">)</span>
        <span class="n">old_status</span> <span class="o">=</span> <span class="n">determine_wstg_status</span><span class="p">(</span><span class="n">finding</span><span class="p">)</span> <span class="k">if</span> <span class="n">finding</span> <span class="k">else</span> <span class="kc">None</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">finding</span><span class="p">:</span>
            <span class="c1"># Crear nuevo finding</span>
            <span class="n">finding</span> <span class="o">=</span> <span class="n">create_finding_from_wstg</span><span class="p">(</span><span class="n">wstg_id</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">notes</span><span class="p">,</span> <span class="n">test</span><span class="p">)</span>
            <span class="n">action</span> <span class="o">=</span> <span class="s2">&quot;created&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Actualizar finding existente</span>
            <span class="n">status_map</span> <span class="o">=</span> <span class="n">WSTG_TO_DD_STATUS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">WSTG_TO_DD_STATUS</span><span class="p">[</span><span class="s1">&#39;Not Started&#39;</span><span class="p">])</span>
            <span class="n">finding</span><span class="o">.</span><span class="n">active</span> <span class="o">=</span> <span class="n">status_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;active&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
            <span class="n">finding</span><span class="o">.</span><span class="n">verified</span> <span class="o">=</span> <span class="n">status_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;verified&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="n">finding</span><span class="o">.</span><span class="n">false_p</span> <span class="o">=</span> <span class="n">status_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;false_p&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">notes</span><span class="p">:</span>
                <span class="n">finding</span><span class="o">.</span><span class="n">mitigation</span> <span class="o">=</span> <span class="n">notes</span>
            <span class="n">finding</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="n">action</span> <span class="o">=</span> <span class="s2">&quot;updated&quot;</span>
        
        <span class="c1"># Actualizar estado de sincronización</span>
        <span class="n">state</span> <span class="o">=</span> <span class="n">load_sync_state</span><span class="p">()</span>
        <span class="k">if</span> <span class="s1">&#39;items&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">state</span><span class="p">:</span>
            <span class="n">state</span><span class="p">[</span><span class="s1">&#39;items&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">state</span><span class="p">[</span><span class="s1">&#39;items&#39;</span><span class="p">][</span><span class="n">wstg_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;finding_id&#39;</span><span class="p">:</span> <span class="n">finding</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="s1">&#39;wstg_status&#39;</span><span class="p">:</span> <span class="n">status</span><span class="p">,</span>
            <span class="s1">&#39;defectdojo_status&#39;</span><span class="p">:</span> <span class="s1">&#39;verified&#39;</span> <span class="k">if</span> <span class="n">finding</span><span class="o">.</span><span class="n">verified</span> <span class="k">else</span> <span class="s1">&#39;active&#39;</span><span class="p">,</span>
            <span class="s1">&#39;last_sync_timestamp&#39;</span><span class="p">:</span> <span class="n">timestamp</span><span class="p">,</span>
            <span class="s1">&#39;last_sync_direction&#39;</span><span class="p">:</span> <span class="s1">&#39;tracker-&gt;dd&#39;</span>
        <span class="p">}</span>
        <span class="n">save_sync_state</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
        
        <span class="c1"># Registrar en log</span>
        <span class="n">log_sync</span><span class="p">(</span><span class="n">wstg_id</span><span class="p">,</span> <span class="s1">&#39;tracker-&gt;dd&#39;</span><span class="p">,</span> <span class="n">old_status</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;finding_id&quot;</span><span class="p">:</span> <span class="n">finding</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="n">action</span><span class="p">,</span>
            <span class="s2">&quot;defectdojo_status&quot;</span><span class="p">:</span> <span class="s2">&quot;verified&quot;</span> <span class="k">if</span> <span class="n">finding</span><span class="o">.</span><span class="n">verified</span> <span class="k">else</span> <span class="s2">&quot;active&quot;</span><span class="p">,</span>
            <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Finding </span><span class="si">{</span><span class="n">action</span><span class="si">}</span><span class="s2"> correctamente&quot;</span>
        <span class="p">}</span>
        
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">error_msg</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error en sync_from_tracker: </span><span class="si">{</span><span class="n">error_msg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">log_sync</span><span class="p">(</span><span class="n">wstg_id</span><span class="p">,</span> <span class="s1">&#39;tracker-&gt;dd&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">error_msg</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="n">error_msg</span><span class="p">}</span>


<span class="k">def</span><span class="w"> </span><span class="nf">sync_from_defectdojo</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Sincronizar desde DefectDojo hacia WSTG Tracker</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">finding_data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;finding&#39;</span><span class="p">,</span> <span class="p">{})</span>
    <span class="n">finding_id</span> <span class="o">=</span> <span class="n">finding_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span>
    <span class="n">event</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;event&#39;</span><span class="p">,</span> <span class="s1">&#39;finding_updated&#39;</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="ow">not</span> <span class="n">finding_id</span><span class="p">:</span>
        <span class="n">error_msg</span> <span class="o">=</span> <span class="s2">&quot;finding id is required&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="n">error_msg</span><span class="p">}</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="n">finding</span> <span class="o">=</span> <span class="n">Finding</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">finding_id</span><span class="p">)</span>
        
        <span class="c1"># Extraer WSTG ID</span>
        <span class="n">wstg_id</span> <span class="o">=</span> <span class="n">extract_wstg_id</span><span class="p">(</span><span class="n">finding</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">wstg_id</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;WSTG ID not found in finding&quot;</span><span class="p">}</span>
        
        <span class="c1"># Determinar estado WSTG</span>
        <span class="n">wstg_status</span> <span class="o">=</span> <span class="n">determine_wstg_status</span><span class="p">(</span><span class="n">finding</span><span class="p">)</span>
        
        <span class="c1"># Actualizar estado de sincronización</span>
        <span class="n">state</span> <span class="o">=</span> <span class="n">load_sync_state</span><span class="p">()</span>
        <span class="k">if</span> <span class="s1">&#39;items&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">state</span><span class="p">:</span>
            <span class="n">state</span><span class="p">[</span><span class="s1">&#39;items&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        
        <span class="n">old_wstg_status</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s1">&#39;items&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">wstg_id</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;wstg_status&#39;</span><span class="p">)</span>
        
        <span class="n">state</span><span class="p">[</span><span class="s1">&#39;items&#39;</span><span class="p">][</span><span class="n">wstg_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;finding_id&#39;</span><span class="p">:</span> <span class="n">finding</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="s1">&#39;wstg_status&#39;</span><span class="p">:</span> <span class="n">wstg_status</span><span class="p">,</span>
            <span class="s1">&#39;defectdojo_status&#39;</span><span class="p">:</span> <span class="s1">&#39;verified&#39;</span> <span class="k">if</span> <span class="n">finding</span><span class="o">.</span><span class="n">verified</span> <span class="k">else</span> <span class="s1">&#39;active&#39;</span><span class="p">,</span>
            <span class="s1">&#39;last_sync_timestamp&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
            <span class="s1">&#39;last_sync_direction&#39;</span><span class="p">:</span> <span class="s1">&#39;dd-&gt;tracker&#39;</span><span class="p">,</span>
            <span class="s1">&#39;event&#39;</span><span class="p">:</span> <span class="n">event</span>
        <span class="p">}</span>
        <span class="n">save_sync_state</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
        
        <span class="c1"># Registrar en log</span>
        <span class="n">log_sync</span><span class="p">(</span><span class="n">wstg_id</span><span class="p">,</span> <span class="s1">&#39;dd-&gt;tracker&#39;</span><span class="p">,</span> <span class="n">old_wstg_status</span><span class="p">,</span> <span class="n">wstg_status</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;wstg_id&quot;</span><span class="p">:</span> <span class="n">wstg_id</span><span class="p">,</span>
            <span class="s2">&quot;wstg_status&quot;</span><span class="p">:</span> <span class="n">wstg_status</span><span class="p">,</span>
            <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Estado sincronizado con tracker&quot;</span>
        <span class="p">}</span>
        
    <span class="k">except</span> <span class="n">Finding</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
        <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Finding </span><span class="si">{</span><span class="n">finding_id</span><span class="si">}</span><span class="s2"> not found&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="n">error_msg</span><span class="p">}</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">error_msg</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error en sync_from_defectdojo: </span><span class="si">{</span><span class="n">error_msg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="n">error_msg</span><span class="p">}</span>


<span class="k">def</span><span class="w"> </span><span class="nf">get_sync_status</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Obtener estado de sincronización&quot;&quot;&quot;</span>
    <span class="n">state</span> <span class="o">=</span> <span class="n">load_sync_state</span><span class="p">()</span>
    <span class="n">items</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;items&#39;</span><span class="p">,</span> <span class="p">{})</span>
    
    <span class="n">total_items</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">)</span>
    <span class="n">synced_items</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> 
                      <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;last_sync_timestamp&#39;</span><span class="p">))</span>
    
    <span class="c1"># Contar conflictos (items con diferentes estados)</span>
    <span class="n">conflicts</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">wstg_id</span><span class="p">,</span> <span class="n">item_data</span> <span class="ow">in</span> <span class="n">items</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">wstg_status</span> <span class="o">=</span> <span class="n">item_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;wstg_status&#39;</span><span class="p">)</span>
        <span class="n">dd_status</span> <span class="o">=</span> <span class="n">item_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;defectdojo_status&#39;</span><span class="p">)</span>
        <span class="c1"># Verificar si hay inconsistencia</span>
        <span class="c1"># (lógica simplificada, puede mejorarse)</span>
        <span class="k">if</span> <span class="n">wstg_status</span> <span class="ow">and</span> <span class="n">dd_status</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">wstg_status</span> <span class="o">==</span> <span class="s1">&#39;Done&#39;</span> <span class="ow">and</span> <span class="n">dd_status</span> <span class="o">!=</span> <span class="s1">&#39;verified&#39;</span><span class="p">)</span> <span class="ow">or</span> \
               <span class="p">(</span><span class="n">wstg_status</span> <span class="o">==</span> <span class="s1">&#39;In Progress&#39;</span> <span class="ow">and</span> <span class="n">dd_status</span> <span class="o">!=</span> <span class="s1">&#39;active&#39;</span><span class="p">):</span>
                <span class="n">conflicts</span> <span class="o">+=</span> <span class="mi">1</span>
    
    <span class="n">last_sync</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sync_log&#39;</span><span class="p">):</span>
        <span class="n">last_sync</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s1">&#39;sync_log&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;timestamp&#39;</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;last_sync&quot;</span><span class="p">:</span> <span class="n">last_sync</span> <span class="ow">or</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
        <span class="s2">&quot;total_items&quot;</span><span class="p">:</span> <span class="n">total_items</span><span class="p">,</span>
        <span class="s2">&quot;synced_items&quot;</span><span class="p">:</span> <span class="n">synced_items</span><span class="p">,</span>
        <span class="s2">&quot;pending_items&quot;</span><span class="p">:</span> <span class="n">total_items</span> <span class="o">-</span> <span class="n">synced_items</span><span class="p">,</span>
        <span class="s2">&quot;conflicts&quot;</span><span class="p">:</span> <span class="n">conflicts</span>
    <span class="p">}</span>


<span class="c1"># Inicializar logging al importar</span>
<span class="n">init_logging</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="paso-2-anadir-endpoints-a-flask">
<h3>2.2 Paso 2: Añadir Endpoints a Flask<a class="headerlink" href="#paso-2-anadir-endpoints-a-flask" title="Link to this heading">¶</a></h3>
<p><strong>Archivo</strong>: <code class="docutils literal notranslate"><span class="pre">app/routes.py</span></code> (MODIFICAR - añadir al final)</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Añadir al final del archivo routes.py</span>

<span class="nd">@api</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/wstg/sync&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">wstg_sync</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Sincronizar estado desde WSTG Tracker hacia DefectDojo</span>
<span class="sd">    Endpoint automático llamado por el tracker cuando cambia un estado</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">.wstg_sync</span><span class="w"> </span><span class="kn">import</span> <span class="n">sync_from_tracker</span>
    
    <span class="n">data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;No data provided&quot;</span><span class="p">}),</span> <span class="mi">400</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">sync_from_tracker</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;success&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">result</span><span class="p">),</span> <span class="mi">200</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">result</span><span class="p">),</span> <span class="mi">400</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">current_app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error en sincronización WSTG: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}),</span> <span class="mi">500</span>


<span class="nd">@api</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/wstg/webhook&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">wstg_webhook</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Recibir webhook de DefectDojo y sincronizar con tracker</span>
<span class="sd">    Endpoint automático llamado por DefectDojo cuando se actualiza un finding</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">.wstg_sync</span><span class="w"> </span><span class="kn">import</span> <span class="n">sync_from_defectdojo</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">.config</span><span class="w"> </span><span class="kn">import</span> <span class="n">WSTG_WEBHOOK_KEY</span>
    
    <span class="n">data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;No data provided&quot;</span><span class="p">}),</span> <span class="mi">400</span>
    
    <span class="c1"># Validar autenticación del webhook (API key)</span>
    <span class="n">api_key</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;X-API-Key&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Authorization&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;Bearer &#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">expected_key</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;WSTG_WEBHOOK_KEY&#39;</span><span class="p">,</span> <span class="n">WSTG_WEBHOOK_KEY</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">expected_key</span> <span class="ow">and</span> <span class="n">expected_key</span> <span class="o">!=</span> <span class="s1">&#39;change_me_in_production&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">api_key</span> <span class="ow">or</span> <span class="n">api_key</span> <span class="o">!=</span> <span class="n">expected_key</span><span class="p">:</span>
            <span class="n">current_app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Intento de webhook no autorizado: </span><span class="si">{</span><span class="n">api_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Unauthorized&quot;</span><span class="p">}),</span> <span class="mi">401</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">sync_from_defectdojo</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;success&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">result</span><span class="p">),</span> <span class="mi">200</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">result</span><span class="p">),</span> <span class="mi">400</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">current_app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error en webhook WSTG: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}),</span> <span class="mi">500</span>


<span class="nd">@api</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/wstg/status&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">wstg_status</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Obtener estado de sincronización WSTG</span>
<span class="sd">    Útil para monitoreo y dashboard</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">.wstg_sync</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_sync_status</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="n">status</span> <span class="o">=</span> <span class="n">get_sync_status</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">status</span><span class="p">),</span> <span class="mi">200</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">current_app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error obteniendo estado WSTG: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}),</span> <span class="mi">500</span>
</pre></div>
</div>
</section>
<section id="paso-3-anadir-configuracion">
<h3>2.3 Paso 3: Añadir Configuración<a class="headerlink" href="#paso-3-anadir-configuracion" title="Link to this heading">¶</a></h3>
<p><strong>Archivo</strong>: <code class="docutils literal notranslate"><span class="pre">app/config.py</span></code> (MODIFICAR)</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Añadir al final del archivo</span>

<span class="c1"># Configuración WSTG Sync</span>
<span class="n">WSTG_WEBHOOK_KEY</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;WSTG_WEBHOOK_KEY&#39;</span><span class="p">,</span> <span class="s1">&#39;change_me_in_production&#39;</span><span class="p">)</span>
<span class="n">WSTG_SYNC_API_URL</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;WSTG_SYNC_API_URL&#39;</span><span class="p">,</span> <span class="s1">&#39;http://localhost:5001/api/wstg/sync&#39;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="paso-4-crear-servicio-de-sincronizacion-en-background">
<h3>2.4 Paso 4: Crear Servicio de Sincronización en Background<a class="headerlink" href="#paso-4-crear-servicio-de-sincronizacion-en-background" title="Link to this heading">¶</a></h3>
<p><strong>Archivo</strong>: <code class="docutils literal notranslate"><span class="pre">scripts/wstg_sync_service.py</span></code> (NUEVO)</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python3</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Servicio de sincronización bidireccional WSTG ↔ DefectDojo</span>
<span class="sd">Ejecuta polling periódico, detecta cambios y resuelve conflictos automáticamente</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">django</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>

<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;/app&#39;</span><span class="p">)</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;DJANGO_SETTINGS_MODULE&#39;</span><span class="p">,</span> <span class="s1">&#39;dojo.settings.settings&#39;</span><span class="p">)</span>
<span class="n">django</span><span class="o">.</span><span class="n">setup</span><span class="p">()</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">dojo.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">Finding</span><span class="p">,</span> <span class="n">Test</span><span class="p">,</span> <span class="n">Test_Type</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">app.wstg_sync</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">get_wstg_test_and_engagement</span><span class="p">,</span> 
    <span class="n">extract_wstg_id</span><span class="p">,</span> 
    <span class="n">determine_wstg_status</span><span class="p">,</span>
    <span class="n">load_sync_state</span><span class="p">,</span>
    <span class="n">save_sync_state</span><span class="p">,</span>
    <span class="n">log_sync</span>
<span class="p">)</span>

<span class="c1"># Configurar logging</span>
<span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span>
    <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span>
    <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="s1"> - </span><span class="si">%(name)s</span><span class="s1"> - </span><span class="si">%(levelname)s</span><span class="s1"> - </span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">,</span>
    <span class="n">handlers</span><span class="o">=</span><span class="p">[</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">FileHandler</span><span class="p">(</span><span class="s1">&#39;/app/data/wstg_sync_service.log&#39;</span><span class="p">),</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">()</span>
    <span class="p">]</span>
<span class="p">)</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;wstg_sync_service&#39;</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">sync_all_wstg_findings</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Sincronizar todos los findings WSTG desde DefectDojo&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">test</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">get_wstg_test_and_engagement</span><span class="p">()</span>
        
        <span class="c1"># Obtener todos los findings con tag WSTG</span>
        <span class="n">findings</span> <span class="o">=</span> <span class="n">Finding</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">test</span><span class="o">=</span><span class="n">test</span><span class="p">,</span>
            <span class="n">tags__name</span><span class="o">=</span><span class="s1">&#39;WSTG&#39;</span>
        <span class="p">)</span><span class="o">.</span><span class="n">distinct</span><span class="p">()</span>
        
        <span class="n">synced</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">errors</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">updated</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="n">state</span> <span class="o">=</span> <span class="n">load_sync_state</span><span class="p">()</span>
        <span class="k">if</span> <span class="s1">&#39;items&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">state</span><span class="p">:</span>
            <span class="n">state</span><span class="p">[</span><span class="s1">&#39;items&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        
        <span class="k">for</span> <span class="n">finding</span> <span class="ow">in</span> <span class="n">findings</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">wstg_id</span> <span class="o">=</span> <span class="n">extract_wstg_id</span><span class="p">(</span><span class="n">finding</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">wstg_id</span><span class="p">:</span>
                    <span class="k">continue</span>
                
                <span class="n">wstg_status</span> <span class="o">=</span> <span class="n">determine_wstg_status</span><span class="p">(</span><span class="n">finding</span><span class="p">)</span>
                
                <span class="c1"># Verificar si hay cambios</span>
                <span class="n">item_state</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s1">&#39;items&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">wstg_id</span><span class="p">,</span> <span class="p">{})</span>
                <span class="n">old_wstg_status</span> <span class="o">=</span> <span class="n">item_state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;wstg_status&#39;</span><span class="p">)</span>
                <span class="n">last_sync</span> <span class="o">=</span> <span class="n">item_state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;last_sync_timestamp&#39;</span><span class="p">)</span>
                
                <span class="c1"># Actualizar estado</span>
                <span class="n">state</span><span class="p">[</span><span class="s1">&#39;items&#39;</span><span class="p">][</span><span class="n">wstg_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;finding_id&#39;</span><span class="p">:</span> <span class="n">finding</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                    <span class="s1">&#39;wstg_status&#39;</span><span class="p">:</span> <span class="n">wstg_status</span><span class="p">,</span>
                    <span class="s1">&#39;defectdojo_status&#39;</span><span class="p">:</span> <span class="s1">&#39;verified&#39;</span> <span class="k">if</span> <span class="n">finding</span><span class="o">.</span><span class="n">verified</span> <span class="k">else</span> <span class="s1">&#39;active&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;last_sync_timestamp&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
                    <span class="s1">&#39;last_sync_direction&#39;</span><span class="p">:</span> <span class="s1">&#39;dd-&gt;tracker&#39;</span>
                <span class="p">}</span>
                
                <span class="k">if</span> <span class="n">old_wstg_status</span> <span class="o">!=</span> <span class="n">wstg_status</span><span class="p">:</span>
                    <span class="n">updated</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✓ Actualizado </span><span class="si">{</span><span class="n">wstg_id</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">old_wstg_status</span><span class="si">}</span><span class="s2"> → </span><span class="si">{</span><span class="n">wstg_status</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">log_sync</span><span class="p">(</span><span class="n">wstg_id</span><span class="p">,</span> <span class="s1">&#39;dd-&gt;tracker&#39;</span><span class="p">,</span> <span class="n">old_wstg_status</span><span class="p">,</span> <span class="n">wstg_status</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Sin cambios </span><span class="si">{</span><span class="n">wstg_id</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">wstg_status</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                
                <span class="n">synced</span> <span class="o">+=</span> <span class="mi">1</span>
                
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">errors</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✗ Error sincronizando finding </span><span class="si">{</span><span class="n">finding</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
        <span class="n">save_sync_state</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
        
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sincronización completada: </span><span class="si">{</span><span class="n">synced</span><span class="si">}</span><span class="s2"> items, </span><span class="si">{</span><span class="n">updated</span><span class="si">}</span><span class="s2"> actualizados, </span><span class="si">{</span><span class="n">errors</span><span class="si">}</span><span class="s2"> errores&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">synced</span><span class="p">,</span> <span class="n">updated</span><span class="p">,</span> <span class="n">errors</span>
        
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error en sync_all_wstg_findings: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span>


<span class="k">def</span><span class="w"> </span><span class="nf">resolve_conflicts</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Resolver conflictos entre tracker y DefectDojo&quot;&quot;&quot;</span>
    <span class="n">state</span> <span class="o">=</span> <span class="n">load_sync_state</span><span class="p">()</span>
    <span class="n">items</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;items&#39;</span><span class="p">,</span> <span class="p">{})</span>
    <span class="n">conflicts_resolved</span> <span class="o">=</span> <span class="mi">0</span>
    
    <span class="k">for</span> <span class="n">wstg_id</span><span class="p">,</span> <span class="n">item_data</span> <span class="ow">in</span> <span class="n">items</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">wstg_status</span> <span class="o">=</span> <span class="n">item_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;wstg_status&#39;</span><span class="p">)</span>
        <span class="n">dd_status</span> <span class="o">=</span> <span class="n">item_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;defectdojo_status&#39;</span><span class="p">)</span>
        <span class="n">last_direction</span> <span class="o">=</span> <span class="n">item_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;last_sync_direction&#39;</span><span class="p">)</span>
        
        <span class="c1"># Detectar conflictos</span>
        <span class="n">is_conflict</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">wstg_status</span> <span class="o">==</span> <span class="s1">&#39;Done&#39;</span> <span class="ow">and</span> <span class="n">dd_status</span> <span class="o">!=</span> <span class="s1">&#39;verified&#39;</span><span class="p">:</span>
            <span class="n">is_conflict</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="n">wstg_status</span> <span class="o">==</span> <span class="s1">&#39;In Progress&#39;</span> <span class="ow">and</span> <span class="n">dd_status</span> <span class="o">!=</span> <span class="s1">&#39;active&#39;</span><span class="p">:</span>
            <span class="n">is_conflict</span> <span class="o">=</span> <span class="kc">True</span>
        
        <span class="k">if</span> <span class="n">is_conflict</span><span class="p">:</span>
            <span class="c1"># Estrategia: DefectDojo tiene prioridad</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Resolviendo conflicto para </span><span class="si">{</span><span class="n">wstg_id</span><span class="si">}</span><span class="s2">: DefectDojo tiene prioridad&quot;</span><span class="p">)</span>
            <span class="c1"># Aquí se podría actualizar el tracker si tuviera API</span>
            <span class="n">conflicts_resolved</span> <span class="o">+=</span> <span class="mi">1</span>
    
    <span class="k">if</span> <span class="n">conflicts_resolved</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Conflictos resueltos: </span><span class="si">{</span><span class="n">conflicts_resolved</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">conflicts_resolved</span>


<span class="k">def</span><span class="w"> </span><span class="nf">run_sync_service</span><span class="p">(</span><span class="n">interval_minutes</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Ejecutar servicio de sincronización en loop&quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;🔄 Iniciando servicio de sincronización WSTG (intervalo: </span><span class="si">{</span><span class="n">interval_minutes</span><span class="si">}</span><span class="s2"> min)&quot;</span><span class="p">)</span>
    
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="si">}</span><span class="s2">] Iniciando sincronización...&quot;</span><span class="p">)</span>
            <span class="n">synced</span><span class="p">,</span> <span class="n">updated</span><span class="p">,</span> <span class="n">errors</span> <span class="o">=</span> <span class="n">sync_all_wstg_findings</span><span class="p">()</span>
            
            <span class="c1"># Resolver conflictos</span>
            <span class="n">conflicts</span> <span class="o">=</span> <span class="n">resolve_conflicts</span><span class="p">()</span>
            
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="si">}</span><span class="s2">] Sincronización completada: </span><span class="si">{</span><span class="n">synced</span><span class="si">}</span><span class="s2"> items, </span><span class="si">{</span><span class="n">updated</span><span class="si">}</span><span class="s2"> actualizados, </span><span class="si">{</span><span class="n">errors</span><span class="si">}</span><span class="s2"> errores, </span><span class="si">{</span><span class="n">conflicts</span><span class="si">}</span><span class="s2"> conflictos&quot;</span><span class="p">)</span>
            
        <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Servicio detenido por usuario&quot;</span><span class="p">)</span>
            <span class="k">break</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ Error en servicio de sincronización: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">interval_minutes</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">argparse</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s1">&#39;Servicio de sincronización WSTG&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--interval&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Intervalo en minutos (default: 5)&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--once&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Ejecutar una vez y salir&#39;</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
    
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">once</span><span class="p">:</span>
        <span class="n">sync_all_wstg_findings</span><span class="p">()</span>
        <span class="n">resolve_conflicts</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">run_sync_service</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">interval</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="paso-5-configurar-docker-compose">
<h3>2.5 Paso 5: Configurar Docker Compose<a class="headerlink" href="#paso-5-configurar-docker-compose" title="Link to this heading">¶</a></h3>
<p><strong>Archivo</strong>: <code class="docutils literal notranslate"><span class="pre">docker-compose.yml</span></code> (MODIFICAR - añadir servicio)</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="c1"># Servicio de sincronización WSTG (Background)</span>
<span class="w">  </span><span class="nt">wstg-sync</span><span class="p">:</span>
<span class="w">    </span><span class="nt">profiles</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">defectdojo</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">defectdojo/defectdojo-django:latest</span>
<span class="w">    </span><span class="nt">container_name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">wstg-sync-service</span>
<span class="w">    </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">unless-stopped</span>
<span class="w">    </span><span class="nt">depends_on</span><span class="p">:</span>
<span class="w">      </span><span class="nt">defectdojo</span><span class="p">:</span>
<span class="w">        </span><span class="nt">condition</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">service_healthy</span>
<span class="w">      </span><span class="nt">defectdojo-db</span><span class="p">:</span>
<span class="w">        </span><span class="nt">condition</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">service_healthy</span>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./scripts/wstg_sync_service.py:/app/wstg_sync_service.py:ro</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./app/wstg_sync.py:/app/wstg_sync.py:ro</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./data:/app/data</span>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span>
<span class="w">      </span><span class="nt">DD_DATABASE_URL</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">postgresql://defectdojo:defectdojo_password@defectdojo-db:5432/defectdojo</span>
<span class="w">      </span><span class="nt">DD_SECRET_KEY</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">defectdojo_secret_key_change_in_production</span>
<span class="w">      </span><span class="nt">DD_DEBUG</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;True&quot;</span>
<span class="w">      </span><span class="nt">WSTG_SYNC_INTERVAL</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">${WSTG_SYNC_INTERVAL:-5}</span>
<span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">python /app/wstg_sync_service.py --interval ${WSTG_SYNC_INTERVAL:-5}</span>
<span class="w">    </span><span class="nt">networks</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">defectdojo-network</span>
<span class="w">    </span><span class="nt">healthcheck</span><span class="p">:</span>
<span class="w">      </span><span class="nt">test</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;CMD&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;python&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;-c&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;import</span><span class="nv"> </span><span class="s">sys;</span><span class="nv"> </span><span class="s">sys.exit(0)&quot;</span><span class="p p-Indicator">]</span>
<span class="w">      </span><span class="nt">interval</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">60s</span>
<span class="w">      </span><span class="nt">timeout</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10s</span>
<span class="w">      </span><span class="nt">retries</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3</span>
</pre></div>
</div>
</section>
<section id="paso-6-actualizar-makefile">
<h3>2.6 Paso 6: Actualizar Makefile<a class="headerlink" href="#paso-6-actualizar-makefile" title="Link to this heading">¶</a></h3>
<p><strong>Archivo</strong>: <code class="docutils literal notranslate"><span class="pre">Makefile</span></code> (MODIFICAR - añadir targets)</p>
<div class="highlight-makefile notranslate"><div class="highlight"><pre><span></span><span class="c"># Sincronización WSTG</span>
<span class="nf">sync-wstg</span><span class="o">:</span><span class="w"> </span><span class="n">setup</span>-<span class="n">env</span> <span class="c">## Sincronizar todos los findings WSTG (una vez)</span>
<span class="w">	</span>@echo<span class="w"> </span><span class="s2">&quot;🔄 Sincronizando findings WSTG...&quot;</span>
<span class="w">	</span>@<span class="k">$(</span>COMPOSE<span class="k">)</span><span class="w"> </span>--profile<span class="w"> </span>defectdojo<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>wstg-sync<span class="w"> </span>python<span class="w"> </span>/app/wstg_sync_service.py<span class="w"> </span>--once<span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="se">\</span>
<span class="w">	 </span><span class="k">$(</span>COMPOSE<span class="k">)</span><span class="w"> </span>--profile<span class="w"> </span>defectdojo<span class="w"> </span>run<span class="w"> </span>--rm<span class="w"> </span>wstg-sync<span class="w"> </span>python<span class="w"> </span>/app/wstg_sync_service.py<span class="w"> </span>--once
<span class="w">	</span>@echo<span class="w"> </span><span class="s2">&quot;✅ Sincronización completada&quot;</span>

<span class="nf">wstg-status</span><span class="o">:</span><span class="w"> </span><span class="n">setup</span>-<span class="n">env</span> <span class="c">## Obtener estado de sincronización WSTG</span>
<span class="w">	</span>@echo<span class="w"> </span><span class="s2">&quot;📊 Estado de sincronización WSTG:&quot;</span>
<span class="w">	</span>@curl<span class="w"> </span>-s<span class="w"> </span>http://localhost:5001/api/wstg/status<span class="w"> </span><span class="p">|</span><span class="w"> </span>python3<span class="w"> </span>-m<span class="w"> </span>json.tool<span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Error obteniendo estado&quot;</span>

<span class="nf">wstg-logs</span><span class="o">:</span><span class="w"> </span><span class="n">setup</span>-<span class="n">env</span> <span class="c">## Ver logs del servicio de sincronización WSTG</span>
<span class="w">	</span>@echo<span class="w"> </span><span class="s2">&quot;📋 Logs del servicio WSTG:&quot;</span>
<span class="w">	</span>@<span class="k">$(</span>COMPOSE<span class="k">)</span><span class="w"> </span>--profile<span class="w"> </span>defectdojo<span class="w"> </span>logs<span class="w"> </span>--tail<span class="o">=</span><span class="m">50</span><span class="w"> </span>wstg-sync
</pre></div>
</div>
</section>
</section>
<hr class="docutils" />
<section id="implementacion-completa-de-codigo">
<h2>3. Implementación Completa de Código<a class="headerlink" href="#implementacion-completa-de-codigo" title="Link to this heading">¶</a></h2>
<section id="codigo-javascript-para-wstg-tracker-automatizacion-completa">
<h3>3.1 Código JavaScript para WSTG Tracker (Automatización Completa)<a class="headerlink" href="#codigo-javascript-para-wstg-tracker-automatizacion-completa" title="Link to this heading">¶</a></h3>
<p><strong>Archivo</strong>: <code class="docutils literal notranslate"><span class="pre">wstg-tracker-integration.js</span></code> (Para añadir al tracker)</p>
<p>Este código debe integrarse en el WSTG Tracker para automatización completa:</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="cm">/**</span>
<span class="cm"> * Integración automática WSTG Tracker ↔ DefectDojo</span>
<span class="cm"> * Añadir este código al WSTG Tracker para sincronización automática</span>
<span class="cm"> */</span>

<span class="kd">class</span><span class="w"> </span><span class="nx">WSTGSyncManager</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kr">constructor</span><span class="p">(</span><span class="nx">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{})</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="nx">apiUrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">config</span><span class="p">.</span><span class="nx">apiUrl</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;http://localhost:5001/api/wstg/sync&#39;</span><span class="p">;</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="nx">syncQueue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="nx">syncing</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="nx">retryDelay</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">5000</span><span class="p">;</span><span class="w"> </span><span class="c1">// 5 segundos</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="nx">maxRetries</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">3</span><span class="p">;</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="nx">enabled</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">config</span><span class="p">.</span><span class="nx">enabled</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">        </span>
<span class="w">        </span><span class="c1">// Inicializar</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="nx">init</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nx">init</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">enabled</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;WSTG Sync deshabilitado&#39;</span><span class="p">);</span>
<span class="w">            </span><span class="k">return</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// Interceptar cambios de estado en el tracker</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="nx">setupStateChangeListener</span><span class="p">();</span>
<span class="w">        </span>
<span class="w">        </span><span class="c1">// Procesar cola de sincronizaciones pendientes</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="nx">processQueue</span><span class="p">();</span>
<span class="w">        </span>
<span class="w">        </span><span class="c1">// Reintentar sincronizaciones fallidas periódicamente</span>
<span class="w">        </span><span class="nx">setInterval</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">retryFailedSyncs</span><span class="p">(),</span><span class="w"> </span><span class="mf">30000</span><span class="p">);</span><span class="w"> </span><span class="c1">// Cada 30 segundos</span>
<span class="w">        </span>
<span class="w">        </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;WSTG Sync Manager inicializado&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nx">setupStateChangeListener</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Esta función debe adaptarse según la implementación del tracker</span>
<span class="w">        </span><span class="c1">// Ejemplo genérico:</span>
<span class="w">        </span>
<span class="w">        </span><span class="c1">// Si el tracker usa eventos personalizados</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nb">window</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="s1">&#39;undefined&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nb">window</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;wstg-status-changed&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">event</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">wstgId</span><span class="p">,</span><span class="w"> </span><span class="nx">oldStatus</span><span class="p">,</span><span class="w"> </span><span class="nx">newStatus</span><span class="p">,</span><span class="w"> </span><span class="nx">notes</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">event</span><span class="p">.</span><span class="nx">detail</span><span class="p">;</span>
<span class="w">                </span><span class="k">this</span><span class="p">.</span><span class="nx">syncOnStatusChange</span><span class="p">(</span><span class="nx">wstgId</span><span class="p">,</span><span class="w"> </span><span class="nx">oldStatus</span><span class="p">,</span><span class="w"> </span><span class="nx">newStatus</span><span class="p">,</span><span class="w"> </span><span class="nx">notes</span><span class="p">);</span>
<span class="w">            </span><span class="p">});</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span>
<span class="w">        </span><span class="c1">// Si el tracker usa localStorage y se puede observar</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="nx">observeLocalStorage</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nx">observeLocalStorage</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Observar cambios en localStorage (si el tracker lo usa)</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">originalSetItem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">localStorage</span><span class="p">.</span><span class="nx">setItem</span><span class="p">;</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">self</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">;</span>
<span class="w">        </span>
<span class="w">        </span><span class="nx">localStorage</span><span class="p">.</span><span class="nx">setItem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kd">function</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span><span class="w"> </span><span class="nx">value</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">originalSetItem</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="nx">arguments</span><span class="p">);</span>
<span class="w">            </span>
<span class="w">            </span><span class="c1">// Si es un cambio de estado WSTG</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">key</span><span class="p">.</span><span class="nx">startsWith</span><span class="p">(</span><span class="s1">&#39;wstg_&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">key</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="s1">&#39;wstg&#39;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="kd">const</span><span class="w"> </span><span class="nx">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span>
<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">status</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">data</span><span class="p">.</span><span class="nx">wstgId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                        </span><span class="nx">self</span><span class="p">.</span><span class="nx">syncItem</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">wstgId</span><span class="p">,</span><span class="w"> </span><span class="nx">data</span><span class="p">.</span><span class="nx">status</span><span class="p">,</span><span class="w"> </span><span class="nx">data</span><span class="p">.</span><span class="nx">notes</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">);</span>
<span class="w">                    </span><span class="p">}</span>
<span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="c1">// No es JSON, ignorar</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">};</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="nx">syncItem</span><span class="p">(</span><span class="nx">wstgId</span><span class="p">,</span><span class="w"> </span><span class="nx">status</span><span class="p">,</span><span class="w"> </span><span class="nx">notes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">enabled</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="p">;</span>

<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">payload</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">wstg_id</span><span class="o">:</span><span class="w"> </span><span class="nx">wstgId</span><span class="p">,</span>
<span class="w">            </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="nx">status</span><span class="p">,</span>
<span class="w">            </span><span class="nx">notes</span><span class="o">:</span><span class="w"> </span><span class="nx">notes</span><span class="p">,</span>
<span class="w">            </span><span class="nx">timestamp</span><span class="o">:</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">().</span><span class="nx">toISOString</span><span class="p">(),</span>
<span class="w">            </span><span class="nx">user</span><span class="o">:</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">getCurrentUser</span><span class="p">()</span>
<span class="w">        </span><span class="p">};</span>

<span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="nx">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">apiUrl</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;POST&#39;</span><span class="p">,</span>
<span class="w">                </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;application/json&#39;</span>
<span class="w">                </span><span class="p">},</span>
<span class="w">                </span><span class="nx">body</span><span class="o">:</span><span class="w"> </span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">payload</span><span class="p">),</span>
<span class="w">                </span><span class="c1">// Timeout de 10 segundos</span>
<span class="w">                </span><span class="nx">signal</span><span class="o">:</span><span class="w"> </span><span class="nx">AbortSignal</span><span class="p">.</span><span class="nx">timeout</span><span class="p">(</span><span class="mf">10000</span><span class="p">)</span>
<span class="w">            </span><span class="p">});</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">response</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="kd">const</span><span class="w"> </span><span class="nx">errorText</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">text</span><span class="p">();</span>
<span class="w">                </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="sb">`Sync failed: </span><span class="si">${</span><span class="nx">response</span><span class="p">.</span><span class="nx">status</span><span class="si">}</span><span class="sb"> </span><span class="si">${</span><span class="nx">errorText</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>
<span class="w">            </span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">success</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`✓ Sincronizado </span><span class="si">${</span><span class="nx">wstgId</span><span class="si">}</span><span class="sb">:`</span><span class="p">,</span><span class="w"> </span><span class="nx">result</span><span class="p">);</span>
<span class="w">                </span><span class="k">this</span><span class="p">.</span><span class="nx">showNotification</span><span class="p">(</span><span class="sb">`Sincronizado: </span><span class="si">${</span><span class="nx">wstgId</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;success&#39;</span><span class="p">);</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="nx">result</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">error</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;Sync failed&#39;</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="sb">`✗ Error sincronizando </span><span class="si">${</span><span class="nx">wstgId</span><span class="si">}</span><span class="sb">:`</span><span class="p">,</span><span class="w"> </span><span class="nx">error</span><span class="p">);</span>
<span class="w">            </span>
<span class="w">            </span><span class="c1">// Añadir a cola para reintento</span>
<span class="w">            </span><span class="k">this</span><span class="p">.</span><span class="nx">addToQueue</span><span class="p">(</span><span class="nx">wstgId</span><span class="p">,</span><span class="w"> </span><span class="nx">status</span><span class="p">,</span><span class="w"> </span><span class="nx">notes</span><span class="p">,</span><span class="w"> </span><span class="nx">error</span><span class="p">);</span>
<span class="w">            </span>
<span class="w">            </span><span class="k">this</span><span class="p">.</span><span class="nx">showNotification</span><span class="p">(</span><span class="sb">`Error sincronizando </span><span class="si">${</span><span class="nx">wstgId</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;error&#39;</span><span class="p">);</span>
<span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="nx">error</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="nx">syncOnStatusChange</span><span class="p">(</span><span class="nx">wstgId</span><span class="p">,</span><span class="w"> </span><span class="nx">oldStatus</span><span class="p">,</span><span class="w"> </span><span class="nx">newStatus</span><span class="p">,</span><span class="w"> </span><span class="nx">notes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">enabled</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="p">;</span>
<span class="w">        </span>
<span class="w">        </span><span class="c1">// Solo sincronizar si el estado cambió</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">oldStatus</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="nx">newStatus</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`Estado cambiado: </span><span class="si">${</span><span class="nx">wstgId</span><span class="si">}</span><span class="sb"> </span><span class="si">${</span><span class="nx">oldStatus</span><span class="si">}</span><span class="sb"> → </span><span class="si">${</span><span class="nx">newStatus</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">            </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">syncItem</span><span class="p">(</span><span class="nx">wstgId</span><span class="p">,</span><span class="w"> </span><span class="nx">newStatus</span><span class="p">,</span><span class="w"> </span><span class="nx">notes</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nx">addToQueue</span><span class="p">(</span><span class="nx">wstgId</span><span class="p">,</span><span class="w"> </span><span class="nx">status</span><span class="p">,</span><span class="w"> </span><span class="nx">notes</span><span class="p">,</span><span class="w"> </span><span class="nx">error</span><span class="p">,</span><span class="w"> </span><span class="nx">retries</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="nx">syncQueue</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
<span class="w">            </span><span class="nx">wstgId</span><span class="p">,</span>
<span class="w">            </span><span class="nx">status</span><span class="p">,</span>
<span class="w">            </span><span class="nx">notes</span><span class="p">,</span>
<span class="w">            </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="nx">error</span><span class="p">.</span><span class="nx">message</span><span class="p">,</span>
<span class="w">            </span><span class="nx">retries</span><span class="p">,</span>
<span class="w">            </span><span class="nx">timestamp</span><span class="o">:</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">().</span><span class="nx">toISOString</span><span class="p">()</span>
<span class="w">        </span><span class="p">});</span>
<span class="w">        </span>
<span class="w">        </span><span class="c1">// Guardar cola en localStorage para persistencia</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="nx">saveQueue</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="nx">processQueue</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">syncing</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">syncQueue</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="nx">syncing</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">        </span>
<span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">syncQueue</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="nx">item</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">syncQueue</span><span class="p">[</span><span class="mf">0</span><span class="p">];</span>
<span class="w">            </span>
<span class="w">            </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">syncItem</span><span class="p">(</span><span class="nx">item</span><span class="p">.</span><span class="nx">wstgId</span><span class="p">,</span><span class="w"> </span><span class="nx">item</span><span class="p">.</span><span class="nx">status</span><span class="p">,</span><span class="w"> </span><span class="nx">item</span><span class="p">.</span><span class="nx">notes</span><span class="p">);</span>
<span class="w">                </span><span class="c1">// Éxito, remover de la cola</span>
<span class="w">                </span><span class="k">this</span><span class="p">.</span><span class="nx">syncQueue</span><span class="p">.</span><span class="nx">shift</span><span class="p">();</span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="c1">// Incrementar reintentos</span>
<span class="w">                </span><span class="nx">item</span><span class="p">.</span><span class="nx">retries</span><span class="o">++</span><span class="p">;</span>
<span class="w">                </span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">item</span><span class="p">.</span><span class="nx">retries</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">maxRetries</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="c1">// Máximo de reintentos alcanzado, remover</span>
<span class="w">                    </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="sb">`Máximo de reintentos alcanzado para </span><span class="si">${</span><span class="nx">item</span><span class="p">.</span><span class="nx">wstgId</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">                    </span><span class="k">this</span><span class="p">.</span><span class="nx">syncQueue</span><span class="p">.</span><span class="nx">shift</span><span class="p">();</span>
<span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="c1">// Reintentar más tarde</span>
<span class="w">                    </span><span class="k">break</span><span class="p">;</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span>
<span class="w">            </span><span class="c1">// Pequeña pausa entre sincronizaciones</span>
<span class="w">            </span><span class="k">await</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Promise</span><span class="p">(</span><span class="nx">resolve</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">setTimeout</span><span class="p">(</span><span class="nx">resolve</span><span class="p">,</span><span class="w"> </span><span class="mf">1000</span><span class="p">));</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="nx">saveQueue</span><span class="p">();</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="nx">syncing</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="nx">retryFailedSyncs</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">syncQueue</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`Reintentando </span><span class="si">${</span><span class="k">this</span><span class="p">.</span><span class="nx">syncQueue</span><span class="p">.</span><span class="nx">length</span><span class="si">}</span><span class="sb"> sincronizaciones fallidas...`</span><span class="p">);</span>
<span class="w">            </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">processQueue</span><span class="p">();</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nx">saveQueue</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">localStorage</span><span class="p">.</span><span class="nx">setItem</span><span class="p">(</span><span class="s1">&#39;wstg_sync_queue&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">syncQueue</span><span class="p">));</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;Error guardando cola de sincronización:&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">e</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nx">loadQueue</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="nx">saved</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">localStorage</span><span class="p">.</span><span class="nx">getItem</span><span class="p">(</span><span class="s1">&#39;wstg_sync_queue&#39;</span><span class="p">);</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">saved</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">this</span><span class="p">.</span><span class="nx">syncQueue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">saved</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;Error cargando cola de sincronización:&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">e</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nx">getCurrentUser</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Obtener usuario actual del tracker</span>
<span class="w">        </span><span class="c1">// Adaptar según implementación del tracker</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">localStorage</span><span class="p">.</span><span class="nx">getItem</span><span class="p">(</span><span class="s1">&#39;wstg_user&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;admin&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nx">showNotification</span><span class="p">(</span><span class="nx">message</span><span class="p">,</span><span class="w"> </span><span class="nx">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;info&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Mostrar notificación al usuario</span>
<span class="w">        </span><span class="c1">// Adaptar según implementación del tracker</span>
<span class="w">        </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`[</span><span class="si">${</span><span class="nx">type</span><span class="p">.</span><span class="nx">toUpperCase</span><span class="p">()</span><span class="si">}</span><span class="sb">] </span><span class="si">${</span><span class="nx">message</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">        </span>
<span class="w">        </span><span class="c1">// Si hay un sistema de notificaciones en el tracker</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nb">window</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="s1">&#39;undefined&#39;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nb">window</span><span class="p">.</span><span class="nx">showNotification</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nb">window</span><span class="p">.</span><span class="nx">showNotification</span><span class="p">(</span><span class="nx">message</span><span class="p">,</span><span class="w"> </span><span class="nx">type</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Método para sincronizar manualmente todos los items</span>
<span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="nx">syncAll</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Sincronizando todos los items...&#39;</span><span class="p">);</span>
<span class="w">        </span>
<span class="w">        </span><span class="c1">// Obtener todos los items del tracker</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">items</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">getAllTrackerItems</span><span class="p">();</span>
<span class="w">        </span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">item</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">items</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">syncItem</span><span class="p">(</span><span class="nx">item</span><span class="p">.</span><span class="nx">wstgId</span><span class="p">,</span><span class="w"> </span><span class="nx">item</span><span class="p">.</span><span class="nx">status</span><span class="p">,</span><span class="w"> </span><span class="nx">item</span><span class="p">.</span><span class="nx">notes</span><span class="p">);</span>
<span class="w">                </span><span class="k">await</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Promise</span><span class="p">(</span><span class="nx">resolve</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">setTimeout</span><span class="p">(</span><span class="nx">resolve</span><span class="p">,</span><span class="w"> </span><span class="mf">500</span><span class="p">));</span><span class="w"> </span><span class="c1">// Pausa entre items</span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="sb">`Error sincronizando </span><span class="si">${</span><span class="nx">item</span><span class="p">.</span><span class="nx">wstgId</span><span class="si">}</span><span class="sb">:`</span><span class="p">,</span><span class="w"> </span><span class="nx">error</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span>
<span class="w">        </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Sincronización completa finalizada&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nx">getAllTrackerItems</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Obtener todos los items del tracker</span>
<span class="w">        </span><span class="c1">// Adaptar según implementación del tracker</span>
<span class="w">        </span><span class="c1">// Ejemplo genérico:</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">items</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>
<span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="nx">trackerData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">localStorage</span><span class="p">.</span><span class="nx">getItem</span><span class="p">(</span><span class="s1">&#39;wstg_checklist&#39;</span><span class="p">);</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">trackerData</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="kd">const</span><span class="w"> </span><span class="nx">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">trackerData</span><span class="p">);</span>
<span class="w">                </span><span class="c1">// Procesar data según estructura del tracker</span>
<span class="w">                </span><span class="c1">// ...</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;Error obteniendo items del tracker:&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">e</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">items</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Inicializar automáticamente cuando se carga la página</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nb">window</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="s1">&#39;undefined&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nb">window</span><span class="p">.</span><span class="nx">wstgSyncManager</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">WSTGSyncManager</span><span class="p">({</span>
<span class="w">        </span><span class="nx">apiUrl</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;http://localhost:5001/api/wstg/sync&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">enabled</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1">// Cargar cola guardada</span>
<span class="w">    </span><span class="nb">window</span><span class="p">.</span><span class="nx">wstgSyncManager</span><span class="p">.</span><span class="nx">loadQueue</span><span class="p">();</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1">// Sincronizar todos los items al cargar (opcional)</span>
<span class="w">    </span><span class="c1">// window.wstgSyncManager.syncAll();</span>
<span class="p">}</span>

<span class="c1">// Exportar para uso en módulos</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">module</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="s1">&#39;undefined&#39;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">WSTGSyncManager</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="integracion-en-el-tracker">
<h3>3.2 Integración en el Tracker<a class="headerlink" href="#integracion-en-el-tracker" title="Link to this heading">¶</a></h3>
<p>Para integrar en el tracker, añadir este código:</p>
<ol class="arabic simple">
<li><p><strong>Si el tracker es una aplicación web estática:</strong></p>
<ul class="simple">
<li><p>Añadir el script antes de <code class="docutils literal notranslate"><span class="pre">&lt;/body&gt;</span></code></p></li>
<li><p>Modificar los handlers de cambio de estado para llamar a <code class="docutils literal notranslate"><span class="pre">wstgSyncManager.syncOnStatusChange()</span></code></p></li>
</ul>
</li>
<li><p><strong>Si el tracker usa un framework (React/Vue/etc.):</strong></p>
<ul class="simple">
<li><p>Importar <code class="docutils literal notranslate"><span class="pre">WSTGSyncManager</span></code> como módulo</p></li>
<li><p>Usar en los componentes que manejan cambios de estado</p></li>
</ul>
</li>
</ol>
<p><strong>Ejemplo de integración en handler de cambio de estado:</strong></p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="c1">// En el código del tracker, cuando se cambia el estado:</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">onStatusChange</span><span class="p">(</span><span class="nx">wstgId</span><span class="p">,</span><span class="w"> </span><span class="nx">oldStatus</span><span class="p">,</span><span class="w"> </span><span class="nx">newStatus</span><span class="p">,</span><span class="w"> </span><span class="nx">notes</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Código existente del tracker</span>
<span class="w">    </span><span class="nx">updateTrackerState</span><span class="p">(</span><span class="nx">wstgId</span><span class="p">,</span><span class="w"> </span><span class="nx">newStatus</span><span class="p">);</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1">// Añadir sincronización automática</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">wstgSyncManager</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nb">window</span><span class="p">.</span><span class="nx">wstgSyncManager</span><span class="p">.</span><span class="nx">syncOnStatusChange</span><span class="p">(</span><span class="nx">wstgId</span><span class="p">,</span><span class="w"> </span><span class="nx">oldStatus</span><span class="p">,</span><span class="w"> </span><span class="nx">newStatus</span><span class="p">,</span><span class="w"> </span><span class="nx">notes</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
</section>
<hr class="docutils" />
<section id="automatizacion-del-wstg-tracker">
<h2>4. Automatización del WSTG Tracker<a class="headerlink" href="#automatizacion-del-wstg-tracker" title="Link to this heading">¶</a></h2>
<section id="opcion-a-modificar-el-tracker-original">
<h3>4.1 Opción A: Modificar el Tracker Original<a class="headerlink" href="#opcion-a-modificar-el-tracker-original" title="Link to this heading">¶</a></h3>
<p>Si tienes acceso al código fuente del tracker:</p>
<ol class="arabic simple">
<li><p>Clonar el repositorio: <code class="docutils literal notranslate"><span class="pre">https://github.com/adanalvarez/owasp-wstg-tracker</span></code></p></li>
<li><p>Añadir el código de <code class="docutils literal notranslate"><span class="pre">WSTGSyncManager</span></code> al proyecto</p></li>
<li><p>Integrar en los componentes de cambio de estado</p></li>
<li><p>Recompilar y desplegar</p></li>
</ol>
</section>
<section id="opcion-b-bookmarklet-o-extension-de-navegador">
<h3>4.2 Opción B: Bookmarklet o Extensión de Navegador<a class="headerlink" href="#opcion-b-bookmarklet-o-extension-de-navegador" title="Link to this heading">¶</a></h3>
<p>Si no tienes acceso al código, crear un bookmarklet o extensión:</p>
<p><strong>Bookmarklet</strong> (añadir a favoritos del navegador):</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="nx">javascript</span><span class="o">:</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">script</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">&#39;script&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="nx">script</span><span class="p">.</span><span class="nx">src</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;http://localhost:5001/static/js/wstg-sync.js&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="nx">script</span><span class="p">.</span><span class="nx">onload</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kd">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nb">window</span><span class="p">.</span><span class="nx">wstgSyncManager</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">WSTGSyncManager</span><span class="p">({</span>
<span class="w">            </span><span class="nx">apiUrl</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;http://localhost:5001/api/wstg/sync&#39;</span>
<span class="w">        </span><span class="p">});</span>
<span class="w">        </span><span class="nx">alert</span><span class="p">(</span><span class="s1">&#39;WSTG Sync activado&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">    </span><span class="nb">document</span><span class="p">.</span><span class="nx">head</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">script</span><span class="p">);</span>
<span class="p">})();</span>
</pre></div>
</div>
</section>
<section id="opcion-c-proxy-interceptor">
<h3>4.3 Opción C: Proxy/Interceptor<a class="headerlink" href="#opcion-c-proxy-interceptor" title="Link to this heading">¶</a></h3>
<p>Crear un proxy que intercepte las llamadas del tracker y añada sincronización automática.</p>
</section>
</section>
<hr class="docutils" />
<section id="configuracion-de-webhooks">
<h2>5. Configuración de Webhooks<a class="headerlink" href="#configuracion-de-webhooks" title="Link to this heading">¶</a></h2>
<section id="configurar-webhook-en-defectdojo">
<h3>5.1 Configurar Webhook en DefectDojo<a class="headerlink" href="#configurar-webhook-en-defectdojo" title="Link to this heading">¶</a></h3>
<p><strong>Paso a paso:</strong></p>
<ol class="arabic simple">
<li><p>Acceder a DefectDojo: <code class="docutils literal notranslate"><span class="pre">http://localhost:8080</span></code></p></li>
<li><p>Login como admin</p></li>
<li><p>Ir a <strong>Configuration</strong> → <strong>Tool Configurations</strong></p></li>
<li><p>Crear nueva configuración:</p>
<ul class="simple">
<li><p><strong>Name</strong>: <code class="docutils literal notranslate"><span class="pre">WSTG</span> <span class="pre">Sync</span> <span class="pre">Webhook</span></code></p></li>
<li><p><strong>Tool Type</strong>: <code class="docutils literal notranslate"><span class="pre">Webhook</span></code></p></li>
<li><p><strong>URL</strong>: <code class="docutils literal notranslate"><span class="pre">http://flask_medical_register:5001/api/wstg/webhook</span></code></p></li>
<li><p><strong>Authentication Type</strong>: <code class="docutils literal notranslate"><span class="pre">API</span> <span class="pre">Key</span></code></p></li>
<li><p><strong>API Key</strong>: (generar y copiar)</p></li>
<li><p><strong>Events</strong>: Seleccionar:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">finding_created</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">finding_updated</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">finding_verified</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">finding_mitigated</span></code></p></li>
</ul>
</li>
</ul>
</li>
<li><p>Guardar configuración</p></li>
</ol>
</section>
<section id="configurar-api-key-en-flask">
<h3>5.2 Configurar API Key en Flask<a class="headerlink" href="#configurar-api-key-en-flask" title="Link to this heading">¶</a></h3>
<p><strong>Archivo</strong>: <code class="docutils literal notranslate"><span class="pre">.env</span></code> o <code class="docutils literal notranslate"><span class="pre">docker-compose.yml</span></code></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">WSTG_WEBHOOK_KEY</span><span class="o">=</span>tu_api_key_generada_aqui
</pre></div>
</div>
<p><strong>Archivo</strong>: <code class="docutils literal notranslate"><span class="pre">docker-compose.yml</span></code> (añadir a servicio web)</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="nt">web</span><span class="p">:</span>
<span class="w">    </span><span class="c1"># ... configuración existente ...</span>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span>
<span class="w">      </span><span class="c1"># ... otras variables ...</span>
<span class="w">      </span><span class="nt">WSTG_WEBHOOK_KEY</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">${WSTG_WEBHOOK_KEY:-change_me_in_production}</span>
</pre></div>
</div>
</section>
<section id="verificar-webhook">
<h3>5.3 Verificar Webhook<a class="headerlink" href="#verificar-webhook" title="Link to this heading">¶</a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Probar webhook manualmente</span>
curl<span class="w"> </span>-X<span class="w"> </span>POST<span class="w"> </span>http://localhost:5001/api/wstg/webhook<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-H<span class="w"> </span><span class="s2">&quot;Content-Type: application/json&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-H<span class="w"> </span><span class="s2">&quot;X-API-Key: tu_api_key&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-d<span class="w"> </span><span class="s1">&#39;{</span>
<span class="s1">    &quot;event&quot;: &quot;finding_updated&quot;,</span>
<span class="s1">    &quot;finding&quot;: {</span>
<span class="s1">      &quot;id&quot;: 123,</span>
<span class="s1">      &quot;title&quot;: &quot;WSTG-INFO-01: Test&quot;,</span>
<span class="s1">      &quot;active&quot;: false,</span>
<span class="s1">      &quot;verified&quot;: true,</span>
<span class="s1">      &quot;tags&quot;: [&quot;WSTG&quot;, &quot;INFO-01&quot;]</span>
<span class="s1">    }</span>
<span class="s1">  }&#39;</span>
</pre></div>
</div>
</section>
</section>
<hr class="docutils" />
<section id="servicios-en-background">
<h2>6. Servicios en Background<a class="headerlink" href="#servicios-en-background" title="Link to this heading">¶</a></h2>
<section id="iniciar-servicio-de-sincronizacion">
<h3>6.1 Iniciar Servicio de Sincronización<a class="headerlink" href="#iniciar-servicio-de-sincronizacion" title="Link to this heading">¶</a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Con docker-compose (automático al levantar DefectDojo)</span>
make<span class="w"> </span>up<span class="w">  </span><span class="c1"># O make initDefectDojo</span>

<span class="c1"># Verificar que el servicio está corriendo</span>
docker<span class="w"> </span>ps<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>wstg-sync

<span class="c1"># Ver logs</span>
docker-compose<span class="w"> </span>logs<span class="w"> </span>-f<span class="w"> </span>wstg-sync
</pre></div>
</div>
</section>
<section id="sincronizacion-manual">
<h3>6.2 Sincronización Manual<a class="headerlink" href="#sincronizacion-manual" title="Link to this heading">¶</a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Sincronizar una vez</span>
make<span class="w"> </span>sync-wstg

<span class="c1"># O directamente</span>
docker-compose<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>wstg-sync<span class="w"> </span>python<span class="w"> </span>/app/wstg_sync_service.py<span class="w"> </span>--once
</pre></div>
</div>
</section>
<section id="configurar-intervalo">
<h3>6.3 Configurar Intervalo<a class="headerlink" href="#configurar-intervalo" title="Link to this heading">¶</a></h3>
<p><strong>Archivo</strong>: <code class="docutils literal notranslate"><span class="pre">.env</span></code></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">WSTG_SYNC_INTERVAL</span><span class="o">=</span><span class="m">5</span><span class="w">  </span><span class="c1"># minutos</span>
</pre></div>
</div>
</section>
</section>
<hr class="docutils" />
<section id="testing-y-validacion">
<h2>7. Testing y Validación<a class="headerlink" href="#testing-y-validacion" title="Link to this heading">¶</a></h2>
<section id="tests-automatizados">
<h3>7.1 Tests Automatizados<a class="headerlink" href="#tests-automatizados" title="Link to this heading">¶</a></h3>
<p><strong>Archivo</strong>: <code class="docutils literal notranslate"><span class="pre">tests/backend/blackbox/test_wstg_sync.py</span></code> (NUEVO)</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">app.wstg_sync</span><span class="w"> </span><span class="kn">import</span> <span class="n">sync_from_tracker</span><span class="p">,</span> <span class="n">sync_from_defectdojo</span><span class="p">,</span> <span class="n">get_sync_status</span>


<span class="k">def</span><span class="w"> </span><span class="nf">test_sync_from_tracker_success</span><span class="p">(</span><span class="n">app</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test sincronización exitosa desde tracker&quot;&quot;&quot;</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;wstg_id&#39;</span><span class="p">:</span> <span class="s1">&#39;WSTG-INFO-01&#39;</span><span class="p">,</span>
        <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;Done&#39;</span><span class="p">,</span>
        <span class="s1">&#39;notes&#39;</span><span class="p">:</span> <span class="s1">&#39;Test de sincronización&#39;</span><span class="p">,</span>
        <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="s1">&#39;2025-12-03T17:30:00Z&#39;</span>
    <span class="p">}</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">sync_from_tracker</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;success&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span>
    <span class="k">assert</span> <span class="s1">&#39;finding_id&#39;</span> <span class="ow">in</span> <span class="n">result</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;action&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;created&#39;</span><span class="p">,</span> <span class="s1">&#39;updated&#39;</span><span class="p">]</span>


<span class="k">def</span><span class="w"> </span><span class="nf">test_sync_from_tracker_missing_fields</span><span class="p">(</span><span class="n">app</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test sincronización con campos faltantes&quot;&quot;&quot;</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;wstg_id&#39;</span><span class="p">:</span> <span class="s1">&#39;WSTG-INFO-01&#39;</span><span class="p">}</span>  <span class="c1"># Falta status</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">sync_from_tracker</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;success&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span>
    <span class="k">assert</span> <span class="s1">&#39;error&#39;</span> <span class="ow">in</span> <span class="n">result</span>


<span class="k">def</span><span class="w"> </span><span class="nf">test_sync_from_defectdojo_success</span><span class="p">(</span><span class="n">app</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test sincronización exitosa desde DefectDojo&quot;&quot;&quot;</span>
    <span class="c1"># Primero crear un finding</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">dojo.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">Finding</span><span class="p">,</span> <span class="n">Test</span><span class="p">,</span> <span class="n">Test_Type</span>
    <span class="n">test</span> <span class="o">=</span> <span class="n">Test</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">test_type__name</span><span class="o">=</span><span class="s1">&#39;WSTG Security Testing&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">test</span><span class="p">:</span>
        <span class="n">pytest</span><span class="o">.</span><span class="n">skip</span><span class="p">(</span><span class="s2">&quot;Test WSTG no existe&quot;</span><span class="p">)</span>
    
    <span class="n">finding</span> <span class="o">=</span> <span class="n">Finding</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
        <span class="n">test</span><span class="o">=</span><span class="n">test</span><span class="p">,</span>
        <span class="n">tags__name</span><span class="o">=</span><span class="s1">&#39;WSTG&#39;</span>
    <span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
    
    <span class="k">if</span> <span class="ow">not</span> <span class="n">finding</span><span class="p">:</span>
        <span class="n">pytest</span><span class="o">.</span><span class="n">skip</span><span class="p">(</span><span class="s2">&quot;No hay findings WSTG para testear&quot;</span><span class="p">)</span>
    
    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;event&#39;</span><span class="p">:</span> <span class="s1">&#39;finding_updated&#39;</span><span class="p">,</span>
        <span class="s1">&#39;finding&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">finding</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="n">finding</span><span class="o">.</span><span class="n">title</span><span class="p">,</span>
            <span class="s1">&#39;active&#39;</span><span class="p">:</span> <span class="n">finding</span><span class="o">.</span><span class="n">active</span><span class="p">,</span>
            <span class="s1">&#39;verified&#39;</span><span class="p">:</span> <span class="n">finding</span><span class="o">.</span><span class="n">verified</span><span class="p">,</span>
            <span class="s1">&#39;tags&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">tag</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">finding</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="n">all</span><span class="p">()]</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">sync_from_defectdojo</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;success&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span>
    <span class="k">assert</span> <span class="s1">&#39;wstg_id&#39;</span> <span class="ow">in</span> <span class="n">result</span>
    <span class="k">assert</span> <span class="s1">&#39;wstg_status&#39;</span> <span class="ow">in</span> <span class="n">result</span>


<span class="k">def</span><span class="w"> </span><span class="nf">test_get_sync_status</span><span class="p">(</span><span class="n">app</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test obtención de estado de sincronización&quot;&quot;&quot;</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">get_sync_status</span><span class="p">()</span>
    <span class="k">assert</span> <span class="s1">&#39;last_sync&#39;</span> <span class="ow">in</span> <span class="n">status</span>
    <span class="k">assert</span> <span class="s1">&#39;total_items&#39;</span> <span class="ow">in</span> <span class="n">status</span>
    <span class="k">assert</span> <span class="s1">&#39;synced_items&#39;</span> <span class="ow">in</span> <span class="n">status</span>
    <span class="k">assert</span> <span class="s1">&#39;pending_items&#39;</span> <span class="ow">in</span> <span class="n">status</span>
    <span class="k">assert</span> <span class="s1">&#39;conflicts&#39;</span> <span class="ow">in</span> <span class="n">status</span>


<span class="k">def</span><span class="w"> </span><span class="nf">test_api_endpoint_sync</span><span class="p">(</span><span class="n">client</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test endpoint /api/wstg/sync&quot;&quot;&quot;</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s1">&#39;/api/wstg/sync&#39;</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="p">{</span>
        <span class="s1">&#39;wstg_id&#39;</span><span class="p">:</span> <span class="s1">&#39;WSTG-INFO-01&#39;</span><span class="p">,</span>
        <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;Done&#39;</span><span class="p">,</span>
        <span class="s1">&#39;notes&#39;</span><span class="p">:</span> <span class="s1">&#39;Test&#39;</span>
    <span class="p">})</span>
    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">get_json</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;success&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span>


<span class="k">def</span><span class="w"> </span><span class="nf">test_api_endpoint_status</span><span class="p">(</span><span class="n">client</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test endpoint /api/wstg/status&quot;&quot;&quot;</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;/api/wstg/status&#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">get_json</span><span class="p">()</span>
    <span class="k">assert</span> <span class="s1">&#39;last_sync&#39;</span> <span class="ow">in</span> <span class="n">data</span>
</pre></div>
</div>
</section>
<section id="pruebas-manuales">
<h3>7.2 Pruebas Manuales<a class="headerlink" href="#pruebas-manuales" title="Link to this heading">¶</a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># 1. Probar sincronización desde tracker</span>
curl<span class="w"> </span>-X<span class="w"> </span>POST<span class="w"> </span>http://localhost:5001/api/wstg/sync<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-H<span class="w"> </span><span class="s2">&quot;Content-Type: application/json&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-d<span class="w"> </span><span class="s1">&#39;{</span>
<span class="s1">    &quot;wstg_id&quot;: &quot;WSTG-INFO-01&quot;,</span>
<span class="s1">    &quot;status&quot;: &quot;Done&quot;,</span>
<span class="s1">    &quot;notes&quot;: &quot;Test de sincronización&quot;</span>
<span class="s1">  }&#39;</span>

<span class="c1"># 2. Verificar estado</span>
curl<span class="w"> </span>http://localhost:5001/api/wstg/status<span class="w"> </span><span class="p">|</span><span class="w"> </span>python3<span class="w"> </span>-m<span class="w"> </span>json.tool

<span class="c1"># 3. Verificar finding en DefectDojo</span>
<span class="c1"># Acceder a http://localhost:8080 y buscar el finding</span>

<span class="c1"># 4. Probar webhook (simulado)</span>
curl<span class="w"> </span>-X<span class="w"> </span>POST<span class="w"> </span>http://localhost:5001/api/wstg/webhook<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-H<span class="w"> </span><span class="s2">&quot;Content-Type: application/json&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-H<span class="w"> </span><span class="s2">&quot;X-API-Key: change_me_in_production&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-d<span class="w"> </span><span class="s1">&#39;{</span>
<span class="s1">    &quot;event&quot;: &quot;finding_updated&quot;,</span>
<span class="s1">    &quot;finding&quot;: {</span>
<span class="s1">      &quot;id&quot;: 1,</span>
<span class="s1">      &quot;title&quot;: &quot;WSTG-INFO-01: Test&quot;,</span>
<span class="s1">      &quot;active&quot;: false,</span>
<span class="s1">      &quot;verified&quot;: true,</span>
<span class="s1">      &quot;tags&quot;: [&quot;WSTG&quot;, &quot;INFO-01&quot;]</span>
<span class="s1">    }</span>
<span class="s1">  }&#39;</span>
</pre></div>
</div>
</section>
</section>
<hr class="docutils" />
<section id="monitoreo-y-alertas">
<h2>8. Monitoreo y Alertas<a class="headerlink" href="#monitoreo-y-alertas" title="Link to this heading">¶</a></h2>
<section id="dashboard-de-estado">
<h3>8.1 Dashboard de Estado<a class="headerlink" href="#dashboard-de-estado" title="Link to this heading">¶</a></h3>
<p><strong>Archivo</strong>: <code class="docutils literal notranslate"><span class="pre">app/routes.py</span></code> (añadir endpoint)</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@api</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/wstg/dashboard&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">wstg_dashboard</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Dashboard de estado de sincronización WSTG&quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">.wstg_sync</span><span class="w"> </span><span class="kn">import</span> <span class="n">load_sync_state</span><span class="p">,</span> <span class="n">get_sync_status</span>
    
    <span class="n">state</span> <span class="o">=</span> <span class="n">load_sync_state</span><span class="p">()</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">get_sync_status</span><span class="p">()</span>
    
    <span class="c1"># Estadísticas adicionales</span>
    <span class="n">items</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;items&#39;</span><span class="p">,</span> <span class="p">{})</span>
    <span class="n">stats</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;by_status&#39;</span><span class="p">:</span> <span class="p">{},</span>
        <span class="s1">&#39;by_direction&#39;</span><span class="p">:</span> <span class="p">{},</span>
        <span class="s1">&#39;recent_syncs&#39;</span><span class="p">:</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sync_log&#39;</span><span class="p">,</span> <span class="p">[])[</span><span class="o">-</span><span class="mi">10</span><span class="p">:]</span>  <span class="c1"># Últimos 10</span>
    <span class="p">}</span>
    
    <span class="k">for</span> <span class="n">item_data</span> <span class="ow">in</span> <span class="n">items</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="n">status_key</span> <span class="o">=</span> <span class="n">item_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;wstg_status&#39;</span><span class="p">,</span> <span class="s1">&#39;Unknown&#39;</span><span class="p">)</span>
        <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;by_status&#39;</span><span class="p">][</span><span class="n">status_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;by_status&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">status_key</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        
        <span class="n">direction</span> <span class="o">=</span> <span class="n">item_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;last_sync_direction&#39;</span><span class="p">,</span> <span class="s1">&#39;Unknown&#39;</span><span class="p">)</span>
        <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;by_direction&#39;</span><span class="p">][</span><span class="n">direction</span><span class="p">]</span> <span class="o">=</span> <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;by_direction&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">direction</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
    
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
        <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="n">status</span><span class="p">,</span>
        <span class="s1">&#39;statistics&#39;</span><span class="p">:</span> <span class="n">stats</span><span class="p">,</span>
        <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
    <span class="p">}),</span> <span class="mi">200</span>
</pre></div>
</div>
</section>
<section id="logging-y-alertas">
<h3>8.2 Logging y Alertas<a class="headerlink" href="#logging-y-alertas" title="Link to this heading">¶</a></h3>
<p>El sistema ya incluye logging automático en:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">/app/data/wstg_sync.log</span></code> - Logs de sincronización</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">/app/data/wstg_sync_service.log</span></code> - Logs del servicio</p></li>
</ul>
<p><strong>Monitoreo de logs:</strong></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Ver logs en tiempo real</span>
tail<span class="w"> </span>-f<span class="w"> </span>data/wstg_sync.log
tail<span class="w"> </span>-f<span class="w"> </span>data/wstg_sync_service.log

<span class="c1"># Buscar errores</span>
grep<span class="w"> </span>ERROR<span class="w"> </span>data/wstg_sync.log
grep<span class="w"> </span>ERROR<span class="w"> </span>data/wstg_sync_service.log
</pre></div>
</div>
</section>
<section id="alertas-automaticas-opcional">
<h3>8.3 Alertas Automáticas (Opcional)<a class="headerlink" href="#alertas-automaticas-opcional" title="Link to this heading">¶</a></h3>
<p><strong>Archivo</strong>: <code class="docutils literal notranslate"><span class="pre">scripts/wstg_alert_service.py</span></code> (NUEVO - opcional)</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python3</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Servicio de alertas para sincronización WSTG</span>
<span class="sd">Envía notificaciones si hay problemas</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>

<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;/app&#39;</span><span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">app.wstg_sync</span><span class="w"> </span><span class="kn">import</span> <span class="n">load_sync_state</span><span class="p">,</span> <span class="n">get_sync_status</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;wstg_alert&#39;</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">check_and_alert</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Verificar estado y enviar alertas si es necesario&quot;&quot;&quot;</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">get_sync_status</span><span class="p">()</span>
    <span class="n">state</span> <span class="o">=</span> <span class="n">load_sync_state</span><span class="p">()</span>
    
    <span class="n">alerts</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="c1"># Alerta si hay muchos conflictos</span>
    <span class="k">if</span> <span class="n">status</span><span class="p">[</span><span class="s1">&#39;conflicts&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>
        <span class="n">alerts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;⚠️ Alto número de conflictos: </span><span class="si">{</span><span class="n">status</span><span class="p">[</span><span class="s1">&#39;conflicts&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="c1"># Alerta si última sincronización es muy antigua</span>
    <span class="k">if</span> <span class="n">status</span><span class="p">[</span><span class="s1">&#39;last_sync&#39;</span><span class="p">]:</span>
        <span class="n">last_sync</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromisoformat</span><span class="p">(</span><span class="n">status</span><span class="p">[</span><span class="s1">&#39;last_sync&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;Z&#39;</span><span class="p">,</span> <span class="s1">&#39;+00:00&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">last_sync</span><span class="o">.</span><span class="n">tzinfo</span><span class="p">)</span> <span class="o">-</span> <span class="n">last_sync</span> <span class="o">&gt;</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">alerts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;⚠️ Última sincronización hace más de 1 hora&quot;</span><span class="p">)</span>
    
    <span class="c1"># Alerta si hay muchos items pendientes</span>
    <span class="k">if</span> <span class="n">status</span><span class="p">[</span><span class="s1">&#39;pending_items&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">status</span><span class="p">[</span><span class="s1">&#39;total_items&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.2</span><span class="p">:</span>
        <span class="n">alerts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;⚠️ Muchos items pendientes: </span><span class="si">{</span><span class="n">status</span><span class="p">[</span><span class="s1">&#39;pending_items&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="c1"># Enviar alertas (adaptar según sistema de notificaciones)</span>
    <span class="k">for</span> <span class="n">alert</span> <span class="ow">in</span> <span class="n">alerts</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">alert</span><span class="p">)</span>
        <span class="c1"># Aquí se podría enviar email, Slack, etc.</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">check_and_alert</span><span class="p">()</span>
</pre></div>
</div>
</section>
</section>
<hr class="docutils" />
<section id="troubleshooting">
<h2>9. Troubleshooting<a class="headerlink" href="#troubleshooting" title="Link to this heading">¶</a></h2>
<section id="problemas-comunes">
<h3>9.1 Problemas Comunes<a class="headerlink" href="#problemas-comunes" title="Link to this heading">¶</a></h3>
<section id="problema-sincronizacion-no-funciona-desde-tracker">
<h4>Problema: Sincronización no funciona desde tracker<a class="headerlink" href="#problema-sincronizacion-no-funciona-desde-tracker" title="Link to this heading">¶</a></h4>
<p><strong>Solución:</strong></p>
<ol class="arabic simple">
<li><p>Verificar que el tracker puede acceder a <code class="docutils literal notranslate"><span class="pre">http://localhost:5001/api/wstg/sync</span></code></p></li>
<li><p>Verificar CORS en Flask (ya configurado)</p></li>
<li><p>Verificar logs: <code class="docutils literal notranslate"><span class="pre">tail</span> <span class="pre">-f</span> <span class="pre">data/wstg_sync.log</span></code></p></li>
<li><p>Probar manualmente con curl</p></li>
</ol>
</section>
<section id="problema-webhooks-no-llegan">
<h4>Problema: Webhooks no llegan<a class="headerlink" href="#problema-webhooks-no-llegan" title="Link to this heading">¶</a></h4>
<p><strong>Solución:</strong></p>
<ol class="arabic simple">
<li><p>Verificar configuración de webhook en DefectDojo</p></li>
<li><p>Verificar que la URL es accesible desde DefectDojo: <code class="docutils literal notranslate"><span class="pre">http://flask_medical_register:5001/api/wstg/webhook</span></code></p></li>
<li><p>Verificar API key</p></li>
<li><p>Verificar logs de Flask: <code class="docutils literal notranslate"><span class="pre">docker-compose</span> <span class="pre">logs</span> <span class="pre">web</span></code></p></li>
</ol>
</section>
<section id="problema-servicio-de-sincronizacion-no-inicia">
<h4>Problema: Servicio de sincronización no inicia<a class="headerlink" href="#problema-servicio-de-sincronizacion-no-inicia" title="Link to this heading">¶</a></h4>
<p><strong>Solución:</strong></p>
<ol class="arabic simple">
<li><p>Verificar que DefectDojo está corriendo: <code class="docutils literal notranslate"><span class="pre">docker</span> <span class="pre">ps</span> <span class="pre">|</span> <span class="pre">grep</span> <span class="pre">defectdojo</span></code></p></li>
<li><p>Verificar logs: <code class="docutils literal notranslate"><span class="pre">docker-compose</span> <span class="pre">logs</span> <span class="pre">wstg-sync</span></code></p></li>
<li><p>Verificar permisos de archivos: <code class="docutils literal notranslate"><span class="pre">ls</span> <span class="pre">-la</span> <span class="pre">scripts/wstg_sync_service.py</span></code></p></li>
<li><p>Ejecutar manualmente: <code class="docutils literal notranslate"><span class="pre">docker-compose</span> <span class="pre">exec</span> <span class="pre">wstg-sync</span> <span class="pre">python</span> <span class="pre">/app/wstg_sync_service.py</span> <span class="pre">--once</span></code></p></li>
</ol>
</section>
<section id="problema-conflictos-no-se-resuelven">
<h4>Problema: Conflictos no se resuelven<a class="headerlink" href="#problema-conflictos-no-se-resuelven" title="Link to this heading">¶</a></h4>
<p><strong>Solución:</strong></p>
<ol class="arabic simple">
<li><p>Verificar lógica de resolución en <code class="docutils literal notranslate"><span class="pre">wstg_sync_service.py</span></code></p></li>
<li><p>Revisar estado: <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">wstg-status</span></code></p></li>
<li><p>Sincronizar manualmente: <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">sync-wstg</span></code></p></li>
</ol>
</section>
</section>
<section id="comandos-de-diagnostico">
<h3>9.2 Comandos de Diagnóstico<a class="headerlink" href="#comandos-de-diagnostico" title="Link to this heading">¶</a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Estado general</span>
make<span class="w"> </span>wstg-status

<span class="c1"># Logs del servicio</span>
make<span class="w"> </span>wstg-logs

<span class="c1"># Logs de Flask</span>
docker-compose<span class="w"> </span>logs<span class="w"> </span>web<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>wstg

<span class="c1"># Estado de sincronización desde API</span>
curl<span class="w"> </span>http://localhost:5001/api/wstg/status<span class="w"> </span><span class="p">|</span><span class="w"> </span>python3<span class="w"> </span>-m<span class="w"> </span>json.tool

<span class="c1"># Verificar archivos de estado</span>
cat<span class="w"> </span>data/wstg_sync_state.json<span class="w"> </span><span class="p">|</span><span class="w"> </span>python3<span class="w"> </span>-m<span class="w"> </span>json.tool

<span class="c1"># Verificar findings WSTG en DefectDojo</span>
docker-compose<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>defectdojo<span class="w"> </span>python<span class="w"> </span>/app/manage.py<span class="w"> </span>shell<span class="w"> </span>-c<span class="w"> </span><span class="s2">&quot;</span>
<span class="s2">from dojo.models import Finding, Test, Test_Type</span>
<span class="s2">test = Test.objects.filter(test_type__name=&#39;WSTG Security Testing&#39;).first()</span>
<span class="s2">if test:</span>
<span class="s2">    print(f&#39;Findings WSTG: {Finding.objects.filter(test=test, tags__name=\&quot;WSTG\&quot;).count()}&#39;)</span>
<span class="s2">&quot;</span>
</pre></div>
</div>
</section>
</section>
<hr class="docutils" />
<section id="resumen-de-automatizacion">
<h2>10. Resumen de Automatización<a class="headerlink" href="#resumen-de-automatizacion" title="Link to this heading">¶</a></h2>
<section id="componentes-automaticos-implementados">
<h3>✅ Componentes Automáticos Implementados<a class="headerlink" href="#componentes-automaticos-implementados" title="Link to this heading">¶</a></h3>
<ol class="arabic simple">
<li><p><strong>Sincronización Tracker → DefectDojo</strong></p>
<ul class="simple">
<li><p>✅ Automática cuando usuario cambia estado</p></li>
<li><p>✅ Endpoint <code class="docutils literal notranslate"><span class="pre">/api/wstg/sync</span></code> listo</p></li>
<li><p>✅ Código JavaScript para integración en tracker</p></li>
<li><p>✅ Cola de reintentos automáticos</p></li>
</ul>
</li>
<li><p><strong>Sincronización DefectDojo → Tracker</strong></p>
<ul class="simple">
<li><p>✅ Automática vía webhooks</p></li>
<li><p>✅ Endpoint <code class="docutils literal notranslate"><span class="pre">/api/wstg/webhook</span></code> listo</p></li>
<li><p>✅ Polling periódico como backup</p></li>
<li><p>✅ Almacenamiento de estado</p></li>
</ul>
</li>
<li><p><strong>Servicio de Sincronización</strong></p>
<ul class="simple">
<li><p>✅ Servicio en background cada 5 minutos</p></li>
<li><p>✅ Detección automática de cambios</p></li>
<li><p>✅ Resolución automática de conflictos</p></li>
<li><p>✅ Logging completo</p></li>
</ul>
</li>
<li><p><strong>Manejo de Errores</strong></p>
<ul class="simple">
<li><p>✅ Reintentos automáticos</p></li>
<li><p>✅ Cola de sincronizaciones fallidas</p></li>
<li><p>✅ Logging de errores</p></li>
<li><p>✅ Notificaciones (opcional)</p></li>
</ul>
</li>
</ol>
</section>
<section id="checklist-de-implementacion">
<h3>📋 Checklist de Implementación<a class="headerlink" href="#checklist-de-implementacion" title="Link to this heading">¶</a></h3>
<ul class="simple">
<li><p>[ ] Crear <code class="docutils literal notranslate"><span class="pre">app/wstg_sync.py</span></code></p></li>
<li><p>[ ] Añadir endpoints en <code class="docutils literal notranslate"><span class="pre">app/routes.py</span></code></p></li>
<li><p>[ ] Añadir configuración en <code class="docutils literal notranslate"><span class="pre">app/config.py</span></code></p></li>
<li><p>[ ] Crear <code class="docutils literal notranslate"><span class="pre">scripts/wstg_sync_service.py</span></code></p></li>
<li><p>[ ] Modificar <code class="docutils literal notranslate"><span class="pre">docker-compose.yml</span></code></p></li>
<li><p>[ ] Actualizar <code class="docutils literal notranslate"><span class="pre">Makefile</span></code></p></li>
<li><p>[ ] Integrar código JavaScript en tracker</p></li>
<li><p>[ ] Configurar webhook en DefectDojo</p></li>
<li><p>[ ] Probar sincronización</p></li>
<li><p>[ ] Verificar logs y monitoreo</p></li>
</ul>
<hr class="docutils" />
<p><strong>Fecha</strong>: 2025-12-03<br />
<strong>Versión</strong>: 2.0<br />
<strong>Estado</strong>: Implementación Completa con Automatización Total</p>
</section>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          
          
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2025, PumukyDev &amp; Alejandro Quiñones
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            On this page
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">Implementación Completa: Integración Bidireccional Automática WSTG Tracker ↔ DefectDojo</a><ul>
<li><a class="reference internal" href="#confirmacion-automatizacion-total">✅ Confirmación: Automatización Total</a><ul>
<li><a class="reference internal" href="#componentes-de-automatizacion">Componentes de Automatización</a></li>
</ul>
</li>
<li><a class="reference internal" href="#indice">Índice</a></li>
<li><a class="reference internal" href="#arquitectura-completa">1. Arquitectura Completa</a></li>
<li><a class="reference internal" href="#guia-de-desarrollo-paso-a-paso">2. Guía de Desarrollo Paso a Paso</a><ul>
<li><a class="reference internal" href="#paso-1-crear-modulo-de-sincronizacion-base">2.1 Paso 1: Crear Módulo de Sincronización Base</a></li>
<li><a class="reference internal" href="#paso-2-anadir-endpoints-a-flask">2.2 Paso 2: Añadir Endpoints a Flask</a></li>
<li><a class="reference internal" href="#paso-3-anadir-configuracion">2.3 Paso 3: Añadir Configuración</a></li>
<li><a class="reference internal" href="#paso-4-crear-servicio-de-sincronizacion-en-background">2.4 Paso 4: Crear Servicio de Sincronización en Background</a></li>
<li><a class="reference internal" href="#paso-5-configurar-docker-compose">2.5 Paso 5: Configurar Docker Compose</a></li>
<li><a class="reference internal" href="#paso-6-actualizar-makefile">2.6 Paso 6: Actualizar Makefile</a></li>
</ul>
</li>
<li><a class="reference internal" href="#implementacion-completa-de-codigo">3. Implementación Completa de Código</a><ul>
<li><a class="reference internal" href="#codigo-javascript-para-wstg-tracker-automatizacion-completa">3.1 Código JavaScript para WSTG Tracker (Automatización Completa)</a></li>
<li><a class="reference internal" href="#integracion-en-el-tracker">3.2 Integración en el Tracker</a></li>
</ul>
</li>
<li><a class="reference internal" href="#automatizacion-del-wstg-tracker">4. Automatización del WSTG Tracker</a><ul>
<li><a class="reference internal" href="#opcion-a-modificar-el-tracker-original">4.1 Opción A: Modificar el Tracker Original</a></li>
<li><a class="reference internal" href="#opcion-b-bookmarklet-o-extension-de-navegador">4.2 Opción B: Bookmarklet o Extensión de Navegador</a></li>
<li><a class="reference internal" href="#opcion-c-proxy-interceptor">4.3 Opción C: Proxy/Interceptor</a></li>
</ul>
</li>
<li><a class="reference internal" href="#configuracion-de-webhooks">5. Configuración de Webhooks</a><ul>
<li><a class="reference internal" href="#configurar-webhook-en-defectdojo">5.1 Configurar Webhook en DefectDojo</a></li>
<li><a class="reference internal" href="#configurar-api-key-en-flask">5.2 Configurar API Key en Flask</a></li>
<li><a class="reference internal" href="#verificar-webhook">5.3 Verificar Webhook</a></li>
</ul>
</li>
<li><a class="reference internal" href="#servicios-en-background">6. Servicios en Background</a><ul>
<li><a class="reference internal" href="#iniciar-servicio-de-sincronizacion">6.1 Iniciar Servicio de Sincronización</a></li>
<li><a class="reference internal" href="#sincronizacion-manual">6.2 Sincronización Manual</a></li>
<li><a class="reference internal" href="#configurar-intervalo">6.3 Configurar Intervalo</a></li>
</ul>
</li>
<li><a class="reference internal" href="#testing-y-validacion">7. Testing y Validación</a><ul>
<li><a class="reference internal" href="#tests-automatizados">7.1 Tests Automatizados</a></li>
<li><a class="reference internal" href="#pruebas-manuales">7.2 Pruebas Manuales</a></li>
</ul>
</li>
<li><a class="reference internal" href="#monitoreo-y-alertas">8. Monitoreo y Alertas</a><ul>
<li><a class="reference internal" href="#dashboard-de-estado">8.1 Dashboard de Estado</a></li>
<li><a class="reference internal" href="#logging-y-alertas">8.2 Logging y Alertas</a></li>
<li><a class="reference internal" href="#alertas-automaticas-opcional">8.3 Alertas Automáticas (Opcional)</a></li>
</ul>
</li>
<li><a class="reference internal" href="#troubleshooting">9. Troubleshooting</a><ul>
<li><a class="reference internal" href="#problemas-comunes">9.1 Problemas Comunes</a><ul>
<li><a class="reference internal" href="#problema-sincronizacion-no-funciona-desde-tracker">Problema: Sincronización no funciona desde tracker</a></li>
<li><a class="reference internal" href="#problema-webhooks-no-llegan">Problema: Webhooks no llegan</a></li>
<li><a class="reference internal" href="#problema-servicio-de-sincronizacion-no-inicia">Problema: Servicio de sincronización no inicia</a></li>
<li><a class="reference internal" href="#problema-conflictos-no-se-resuelven">Problema: Conflictos no se resuelven</a></li>
</ul>
</li>
<li><a class="reference internal" href="#comandos-de-diagnostico">9.2 Comandos de Diagnóstico</a></li>
</ul>
</li>
<li><a class="reference internal" href="#resumen-de-automatizacion">10. Resumen de Automatización</a><ul>
<li><a class="reference internal" href="#componentes-automaticos-implementados">✅ Componentes Automáticos Implementados</a></li>
<li><a class="reference internal" href="#checklist-de-implementacion">📋 Checklist de Implementación</a></li>
</ul>
</li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script src="_static/documentation_options.js?v=01f34227"></script>
    <script src="_static/doctools.js?v=9bcbadda"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/scripts/furo.js?v=46bd48cc"></script>
    </body>
</html>